<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiteGram Ultra</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surf: #17212b; --accent: #2481cc; --text: #fff; --msg-my: #2b5278; --msg-other: #182533; --border: #000; }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* Sidebar */
        #sidebar { width: 300px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .chat-item { padding: 12px; cursor: pointer; display: flex; align-items: center; gap: 10px; border-radius: 10px; margin: 2px 8px; transition: 0.2s; }
        .chat-item:hover, .chat-item.active { background: var(--accent); }

        /* Chat */
        #chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* Bubbles */
        .msg { max-width: 75%; padding: 10px; border-radius: 15px; position: relative; }
        .msg.my { align-self: flex-end; background: var(--msg-my); border-bottom-right-radius: 2px; }
        .msg.other { align-self: flex-start; background: var(--msg-other); border-bottom-left-radius: 2px; }

        /* Actions */
        .del-btn { position: absolute; top: -10px; right: -10px; background: #ff4d4d; color: white; border: none; width: 22px; height: 22px; border-radius: 50%; cursor: pointer; display: none; align-items: center; justify-content: center; z-index: 10; }
        .msg.my:hover .del-btn { display: flex; }
        .react-bar { display: flex; gap: 8px; margin-top: 5px; }
        .react-btn { cursor: pointer; opacity: 0.6; transition: 0.2s; font-size: 14px; }
        .react-btn:hover { opacity: 1; transform: scale(1.2); }
        .msg-reactions { display: flex; gap: 5px; background: rgba(0,0,0,0.3); padding: 2px 8px; border-radius: 10px; width: fit-content; margin-top: 5px; font-size: 11px; }

        /* Media */
        .file-box { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; display: flex; align-items: center; gap: 10px; text-decoration: none; color: white; border: 1px dashed rgba(255,255,255,0.2); }
        .video-note { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid var(--accent); }
        #v-preview { position: absolute; bottom: 85px; right: 20px; width: 130px; height: 130px; border-radius: 50%; border: 3px solid #ff4d4d; display: none; object-fit: cover; transform: scaleX(-1); }
        
        /* UI Elements */
        #call-ui { position: fixed; inset: 0; background: rgba(14,22,33,0.98); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .call-anim { width: 100px; height: 100px; border-radius: 50%; border: 3px solid var(--accent); animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(36,129,204,0.7); } 100% { box-shadow: 0 0 0 30px rgba(36,129,204,0); } }

        #sticker-panel { display: none; position: absolute; bottom: 80px; left: 15px; background: var(--surf); border: 1px solid var(--border); padding: 10px; border-radius: 15px; grid-template-columns: repeat(4, 1fr); gap: 10px; z-index: 100; }
        .btn-icon { width: 40px; height: 40px; border-radius: 50%; border: none; background: transparent; color: #808b99; cursor: pointer; font-size: 20px; }
        .btn-icon:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>

    <div id="call-ui">
        <div class="call-anim" style="margin-bottom:20px"></div>
        <h2 id="call-target">–í—ã–∑–æ–≤...</h2>
        <button onclick="endCall()" style="background:#ff4d4d; color:white; border:none; padding:12px 35px; border-radius:20px; cursor:pointer;">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>

    <div id="sidebar">
        <div style="padding:15px; display:flex; align-items:center; gap:10px; border-bottom:1px solid var(--border);">
            <img id="my-av" class="avatar" src="https://via.placeholder.com/40">
            <b id="my-name-display" style="flex:1">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            <button class="btn-icon" onclick="createGroup()">+</button>
        </div>
        <div style="padding:10px;"><input id="search-chat" placeholder="–ü–æ–∏—Å–∫..." oninput="filterList()" style="width:100%; padding:10px; border-radius:10px; background:var(--bg); border:none; color:white;"></div>
        <div id="chats-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="chat-area">
        <video id="v-preview" autoplay muted></video>
        <div style="background:var(--surf); padding:10px 15px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between;">
            <b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
            <button class="btn-icon" onclick="startCall()">üìû</button>
        </div>

        <div id="messages"></div>

        <div id="sticker-panel">
            <img src="https://cdn-icons-png.flaticon.com/512/4721/4721028.png" style="width:50px; cursor:pointer" onclick="sendMedia(this.src, 'sticker')">
            <img src="https://cdn-icons-png.flaticon.com/512/4721/4721021.png" style="width:50px; cursor:pointer" onclick="sendMedia(this.src, 'sticker')">
            <img src="https://cdn-icons-png.flaticon.com/512/2584/2584606.png" style="width:50px; cursor:pointer" onclick="sendMedia(this.src, 'sticker')">
            <img src="https://cdn-icons-png.flaticon.com/512/4721/4721038.png" style="width:50px; cursor:pointer" onclick="sendMedia(this.src, 'sticker')">
        </div>

        <div style="background:var(--surf); padding:10px 15px; display:flex; align-items:center; gap:8px;">
            <label class="btn-icon" style="display:flex; align-items:center; justify-content:center; cursor:pointer">
                üìé<input type="file" onchange="uploadFile(this)">
            </label>
            <button class="btn-icon" onclick="toggleStickers()">üòä</button>
            <button id="v-btn" class="btn-icon" onclick="recordMedia('video')">üì∑</button>
            <input id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:transparent; border:none; color:white;" onkeypress="if(event.key==='Enter') send()">
            <button id="a-btn" class="btn-icon" onclick="recordMedia('audio')">üé§</button>
            <button class="btn-icon" onclick="send()" style="color:var(--accent)">‚û§</button>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = 'global', mediaRec, chunks = [], isRec = false;

        // –í—Ö–æ–¥
        window.onload = () => {
            const saved = localStorage.getItem('lg_creds');
            if(saved) socket.emit('login_attempt', JSON.parse(saved));
            else login();
        };

        function login() {
            const n = prompt("–ù–∏–∫?"); const p = prompt("–ü–∞—Ä–æ–ª—å?");
            if(n && p) {
                const c = {nick: n, pass: p};
                localStorage.setItem('lg_creds', JSON.stringify(c));
                socket.emit('login_attempt', c);
            }
        }

        socket.on('login_success', u => {
            me = u; document.getElementById('my-name-display').innerText = u.name;
            socket.emit('get_my_rooms', {nick: me.nick});
            switchRoom('global', 'üåç –û–±—â–∏–π —á–∞—Ç');
        });

        // –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–û–í
        function uploadFile(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                socket.emit('message', {
                    room: currentRoom, nick: me.nick, user: me.name,
                    file: e.target.result, fileName: file.name, fileType: file.type
                });
            };
            reader.readAsDataURL(file);
            input.value = '';
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ
        function deleteMsg(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) socket.emit('delete_message', {msg_id: id, room: currentRoom, nick: me.nick});
        }
        socket.on('remove_message_from_ui', id => { const el = document.getElementById(`msg-${id}`); if(el) el.remove(); });

        // –†–µ–∞–∫—Ü–∏–∏
        function addReact(id, emoji) { socket.emit('add_reaction', {msg_id: id, emoji, nick: me.nick, room: currentRoom}); }
        socket.on('update_reactions', msg => {
            const el = document.getElementById(`msg-${msg.id}`);
            if(el) {
                let box = el.querySelector('.msg-reactions') || document.createElement('div');
                box.className = 'msg-reactions';
                const counts = {};
                Object.values(msg.reactions).forEach(e => counts[e] = (counts[e] || 0) + 1);
                box.innerHTML = Object.entries(counts).map(([e, c]) => `<span>${e} ${c}</span>`).join(' ');
                el.appendChild(box);
            }
        });

        // –ü–æ–∏—Å–∫
        function filterList() {
            const q = document.getElementById('search-chat').value.toLowerCase();
            document.querySelectorAll('.chat-item').forEach(el => {
                el.style.display = el.innerText.toLowerCase().includes(q) ? 'flex' : 'none';
            });
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('chat-title').innerText = title;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join', {room: id});
        }

        function createGroup() {
            const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã?");
            if(n) socket.emit('create_room', {name: n, creator_nick: me.nick});
        }

        socket.on('load_rooms', rs => {
            const l = document.getElementById('chats-list'); l.innerHTML = '';
            const add = (id, t) => {
                const d = document.createElement('div');
                d.className = 'chat-item' + (currentRoom===id?' active':'');
                d.innerHTML = `<b>${t}</b>`;
                d.onclick = () => switchRoom(id, t);
                l.appendChild(d);
            };
            add('global', 'üåç –û–±—â–∏–π —á–∞—Ç');
            rs.forEach(r => add(r.id, 'üë• ' + r.name));
        });

        function send() {
            const i = document.getElementById('msg-in');
            if(i.value.trim()) {
                socket.emit('message', {room: currentRoom, text: i.value, nick: me.nick, user: me.name});
                i.value = '';
            }
        }

        function sendMedia(url, type) {
            socket.emit('message', {room: currentRoom, [type]: url, nick: me.nick, user: me.name});
            document.getElementById('sticker-panel').style.display = 'none';
        }

        socket.on('render_message', d => { if(d.room === currentRoom) addMsg(d); });
        socket.on('history', h => h.forEach(addMsg));

        function addMsg(d) {
            const b = document.getElementById('messages');
            let content = d.text ? `<div>${d.text}</div>` : '';
            if(d.sticker) content = `<img src="${d.sticker}" style="width:100px;">`;
            if(d.video) content = `<video class="video-note" src="${d.video}" autoplay loop muted></video>`;
            if(d.voice) content = `<audio controls src="${d.voice}" style="width:200px; height:35px;"></audio>`;
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–æ–≤
            if(d.file) {
                if(d.fileType.startsWith('image/')) {
                    content = `<img src="${d.file}" style="max-width:100%; border-radius:8px; cursor:pointer" onclick="window.open(this.src)">`;
                } else {
                    content = `<a href="${d.file}" download="${d.fileName}" class="file-box">üìÑ ${d.fileName}</a>`;
                }
            }

            const isMy = d.nick === me.nick;
            const html = `
                <div class="msg ${isMy?'my':'other'}" id="msg-${d.id}">
                    ${isMy ? `<button class="del-btn" onclick="deleteMsg('${d.id}')">‚úï</button>` : ''}
                    <small style="font-weight:bold; color:var(--accent); display:block; margin-bottom:4px;">${d.user}</small>
                    ${content}
                    <div class="react-bar">
                        <span class="react-btn" onclick="addReact('${d.id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                        <span class="react-btn" onclick="addReact('${d.id}', 'üëç')">üëç</span>
                    </div>
                </div>`;
            b.insertAdjacentHTML('beforeend', html);
            b.scrollTop = b.scrollHeight;
        }

        // –ó–≤–æ–Ω–∫–∏ –∏ –ú–µ–¥–∏–∞
        function startCall() { document.getElementById('call-target').innerText = document.getElementById('chat-title').innerText; document.getElementById('call-ui').style.display='flex'; }
        function endCall() { document.getElementById('call-ui').style.display='none'; }
        function toggleStickers() { const p = document.getElementById('sticker-panel'); p.style.display = p.style.display==='grid'?'none':'grid'; }

        async function recordMedia(mode) {
            if(!isRec) {
                const stream = await navigator.mediaDevices.getUserMedia({audio:true, video:mode==='video'});
                if(mode==='video') { const p = document.getElementById('v-preview'); p.srcObject=stream; p.style.display='block'; }
                mediaRec = new MediaRecorder(stream); chunks = [];
                mediaRec.ondataavailable = e => chunks.push(e.data);
                mediaRec.onstop = () => {
                    const blob = new Blob(chunks, {type: mode==='video'?'video/webm':'audio/webm'});
                    const r = new FileReader(); r.readAsDataURL(blob);
                    r.onloadend = () => sendMedia(r.result, mode);
                    stream.getTracks().forEach(t => t.stop());
                    document.getElementById('v-preview').style.display='none';
                };
                mediaRec.start(); isRec=true;
                document.getElementById(mode==='video'?'v-btn':'a-btn').style.color='#ff4d4d';
            } else {
                mediaRec.stop(); isRec=false;
                document.getElementById('v-btn').style.color='#808b99';
                document.getElementById('a-btn').style.color='#808b99';
            }
        }
    </script>
</body>
</html>
