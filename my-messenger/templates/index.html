<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Pro</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --text: #ffffff; --primary: #2481cc; --gray: #808b99; }
        .light-mode { --bg: #ffffff; --surface: #f4f4f5; --text: #000000; --primary: #0088cc; --gray: #707579; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-ui { background: var(--surface); border: 1px solid var(--gray); color: var(--text); padding: 12px; border-radius: 8px; margin: 8px; width: 280px; }

        #sidebar { width: 260px; background: var(--surface); border-right: 1px solid rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.05); }
        #member-list { width: 200px; background: var(--surface); border-left: 1px solid rgba(0,0,0,0.2); padding: 10px; }

        .header { background: var(--surface); height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid rgba(0,0,0,0.2); justify-content: space-between; }
        .chat-item { padding: 12px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .chat-item.active { background: var(--primary); }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: var(--surface); padding: 10px; border-radius: 12px; max-width: 80%; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .msg-actions { display: none; position: absolute; top: -20px; right: 0; background: var(--primary); border-radius: 5px; padding: 2px 5px; gap: 5px; }
        .msg:hover .msg-actions { display: flex; }
        .action-btn { cursor: pointer; font-size: 10px; color: white; border: none; background: none; }

        .input-area { padding: 15px; background: var(--surface); display: flex; gap: 10px; }
        .input-area input { flex: 1; background: var(--bg); color: var(--text); border: none; padding: 12px; border-radius: 8px; outline: none; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color: var(--primary)">LiteGram</h1>
        <input type="text" id="r-name" class="input-ui" placeholder="–ò–º—è">
        <input type="text" id="r-user" class="input-ui" placeholder="@username">
        <input type="password" id="r-pass" class="input-ui" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" style="background: var(--primary); color: white; border: none; padding: 12px 100px; border-radius: 8px; cursor: pointer;">–í–û–ô–¢–ò</button>
    </div>

    <div id="main-container" style="display:none; width: 100%;">
        <div id="sidebar">
            <div class="header">
                <button onclick="toggleTheme()" style="background:none; border:none; font-size:20px;">üåì</button>
                <input type="text" placeholder="–ü–æ–∏—Å–∫..." style="width:100px; background:var(--bg); color:var(--text); border:none; border-radius:10px; padding:5px;" oninput="renderList(this.value)">
            </div>
            <div id="list-items" style="flex:1; overflow-y:auto;"></div>
            <button onclick="createRoom()" style="padding:15px; background: var(--primary); color:white; border:none;">+ –°–û–ó–î–ê–¢–¨ –ß–ê–¢</button>
        </div>

        <div id="chat-window">
            <div class="header">
                <div><b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b> <button id="del-chat-btn" onclick="deleteCurrentChat()" style="display:none; color:red; font-size:10px; background:none; border:1px solid red;">–£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button></div>
            </div>
            <div id="messages"></div>
            <div class="input-area">
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
                <button onclick="send()" style="background:none; border:none; color:var(--primary); font-size:24px;">‚û§</button>
            </div>
        </div>

        <div id="member-list">
            <h4>–£—á–∞—Å—Ç–Ω–∏–∫–∏</h4>
            <div id="member-items"></div>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null;
        let currentRoom = "–û–±—â–∏–π —á–∞—Ç";
        let allRooms = ["–û–±—â–∏–π —á–∞—Ç"];

        function login() {
            const name = document.getElementById('r-name').value;
            const nick = document.getElementById('r-user').value.replace('@','');
            const pass = document.getElementById('r-pass').value;
            if(name && nick && pass) socket.emit('login_attempt', { name, nick, pass });
        }

        socket.on('login_success', (userData) => {
            me = userData;
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            switchRoom(currentRoom);
            renderList();
        });

        socket.on('login_error', (msg) => alert(msg));

        function renderList(f = "") {
            document.getElementById('list-items').innerHTML = allRooms.filter(r => r.toLowerCase().includes(f.toLowerCase())).map(r => 
                `<div class="chat-item ${r === currentRoom ? 'active' : ''}" onclick="switchRoom('${r}')"># ${r}</div>`).join('');
        }

        function switchRoom(name) {
            currentRoom = name;
            document.getElementById('chat-title').innerText = name;
            document.getElementById('messages').innerHTML = "";
            socket.emit('join', { room: name, nick: me.nick });
            renderList();
        }

        function send() {
            const el = document.getElementById('msg-input');
            if(el.value.trim()) {
                socket.emit('message', { user: me.name, nick: '@'+me.nick, text: el.value, room: currentRoom });
                el.value = '';
            }
        }

        function addMsg(data) {
            const m = document.getElementById('messages');
            const isMy = data.nick === '@' + me.nick;
            const msgHtml = `
                <div class="msg" id="msg-${data._id}" style="${isMy ? 'align-self: flex-end;' : ''}">
                    <div class="msg-actions">
                        ${isMy ? `<button class="action-btn" onclick="editMsg('${data._id}', '${data.text}')">‚úé</button>` : ''}
                        ${isMy ? `<button class="action-btn" onclick="deleteMsg('${data._id}')">üóë</button>` : ''}
                    </div>
                    <b>${data.user}</b> <br>
                    <span class="text-content">${data.text}</span>
                </div>`;
            m.insertAdjacentHTML('beforeend', msgHtml);
            m.scrollTop = m.scrollHeight;
        }

        socket.on('render_message', (data) => { if(data.room === currentRoom) addMsg(data); });
        socket.on('history', (msgs) => msgs.forEach(m => addMsg(m)));

        // –§–£–ù–ö–¶–ò–ò –£–î–ê–õ–ï–ù–ò–Ø –ò –ò–ó–ú–ï–ù–ï–ù–ò–Ø
        function deleteMsg(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) socket.emit('delete_message', { msg_id: id, room: currentRoom }); }
        socket.on('message_deleted', (data) => document.getElementById(`msg-${data.msg_id}`)?.remove());

        function editMsg(id, oldText) {
            const newText = prompt("–ò–∑–º–µ–Ω–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:", oldText);
            if(newText && newText !== oldText) {
                socket.emit('edit_message', { msg_id: id, new_text: newText, room: currentRoom });
            }
        }
        socket.on('message_edited', (data) => {
            const el = document.querySelector(`#msg-${data.msg_id} .text-content`);
            if(el) el.innerText = data.new_text;
        });

        function deleteCurrentChat() {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —á–∞—Ç –Ω–∞–≤—Å–µ–≥–¥–∞?")) socket.emit('delete_chat', { room: currentRoom, requester: me.nick });
        }
        socket.on('chat_deleted', (data) => {
            alert("–ß–∞—Ç —É–¥–∞–ª–µ–Ω –≤–ª–∞–¥–µ–ª—å—Ü–µ–º");
            allRooms = allRooms.filter(r => r !== data.room);
            switchRoom("–û–±—â–∏–π —á–∞—Ç");
        });

        socket.on('room_info', (data) => {
            document.getElementById('del-chat-btn').style.display = (data.owner === me.nick && data.name !== "–û–±—â–∏–π —á–∞—Ç") ? 'inline' : 'none';
            document.getElementById('member-items').innerHTML = data.members.map(m => `<div>@${m}</div>`).join('');
        });

        function createRoom() {
            const n = prompt("–ò–º—è —á–∞—Ç–∞:");
            if(n) { socket.emit('create_room', { name: n, type: 'group', user: me.nick }); allRooms.push(n); switchRoom(n); }
        }
        socket.on('room_created', (data) => { if(!allRooms.includes(data.name)) { allRooms.push(data.name); renderList(); } });
        function toggleTheme() { document.body.classList.toggle('light-mode'); }
    </script>
</body>
</html>
