<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Ultra</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --primary: #2481cc; --text: #fff; --online: #4ade80; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; overflow: hidden; }
        
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-ui { background: var(--surface); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin: 5px; width: 280px; outline: none; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #main-ui { display: flex; height: 100vh; }
        #sidebar { width: 300px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat { flex: 1; display: flex; flex-direction: column; background: #080e15; }
        
        .header { padding: 15px; background: var(--surface); border-bottom: 1px solid #000; display: flex; align-items: center; justify-content: space-between; }
        .search-box { padding: 10px; }
        .search-box input { width: 100%; background: #0f161e; border: 1px solid #333; color: white; padding: 8px; border-radius: 5px; box-sizing: border-box; }

        /* –ö–Ω–æ–ø–∫–∏ —Å–æ–∑–¥–∞–Ω–∏—è */
        .create-btns { display: flex; gap: 5px; padding: 0 10px 10px; }
        .btn-small { flex: 1; background: #2c3b4a; color: white; border: none; padding: 6px; border-radius: 4px; cursor: pointer; font-size: 11px; }
        .btn-small:hover { background: var(--primary); }

        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ */
        #chats-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #121b25; }
        .chat-item:hover { background: #202b36; }
        .chat-item.active { background: #2b5278; }
        .chat-icon { width: 45px; height: 45px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { display: flex; gap: 10px; max-width: 80%; }
        .msg-content { background: var(--surface); padding: 10px; border-radius: 12px; position: relative; }
        .my-msg { align-self: flex-end; flex-direction: row-reverse; }
        .my-msg .msg-content { background: var(--primary); }

        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; cursor: pointer; }
        .controls { padding: 15px; background: var(--surface); display: flex; gap: 10px; align-items: center; }
        input#msg-input { flex: 1; background: #080e15; border: none; color: white; padding: 12px; border-radius: 10px; outline: none; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:var(--primary)">LiteGram</h1>
        <input type="text" id="r-name" class="input-ui" placeholder="–ò–º—è">
        <input type="text" id="r-user" class="input-ui" placeholder="@username">
        <input type="password" id="r-pass" class="input-ui" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" style="background:var(--primary); color:white; border:none; padding:12px 100px; border-radius:8px; cursor:pointer; font-weight:bold;">–í–û–ô–¢–ò</button>
    </div>

    <div id="main-ui" style="display:none">
        <div id="sidebar">
            <div class="header">
                <img id="my-avatar" class="avatar" onclick="changeAv()" title="–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä">
                <b id="my-name-display">–ü—Ä–æ—Ñ–∏–ª—å</b>
            </div>
            
            <div class="search-box">
                <input type="text" placeholder="–ü–æ–∏—Å–∫..." oninput="filterChats(this.value)">
            </div>

            <div class="create-btns">
                <button class="btn-small" onclick="createNew('group')">+ –ì—Ä—É–ø–ø–∞</button>
                <button class="btn-small" onclick="createNew('channel')">+ –ö–∞–Ω–∞–ª</button>
            </div>

            <div id="chats-list">
                <div class="chat-item active" onclick="switchRoom('global')">
                    <div class="chat-icon">üåê</div>
                    <div style="margin-left:12px;">
                        <b>–û–±—â–∏–π —á–∞—Ç</b>
                        <div style="font-size:12px; color:#aaa;">–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chat">
            <div class="header">
                <div>
                    <b id="chat-title">üåê –û–±—â–∏–π —á–∞—Ç</b>
                    <div id="typing-status" style="font-size:11px; color:var(--online); height:12px;"></div>
                </div>
                <button onclick="startCall()" style="background:var(--primary); border:none; color:white; padding:8px 15px; border-radius:5px; cursor:pointer;">üé• –ó–≤–æ–Ω–æ–∫</button>
            </div>
            <div id="messages"></div>
            <div class="controls">
                <button id="voice-btn" style="background:none; border:none; font-size:24px; cursor:pointer;">üé§</button>
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
                <button onclick="send()" style="background:none; border:none; color:var(--primary); font-size:26px; cursor:pointer;">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = "global", mediaRecorder, audioChunks = [];

        // –ê–≤—Ç–æ-–≤—Ö–æ–¥
        window.onload = () => {
            const saved = localStorage.getItem('litegram_user');
            if(saved) { me = JSON.parse(saved); enterApp(me); }
        };

        function login() {
            const n = document.getElementById('r-name').value, u = document.getElementById('r-user').value.toLowerCase(), p = document.getElementById('r-pass').value;
            if(n && u && p) socket.emit('login_attempt', {name:n, nick:u, pass:p});
        }

        socket.on('login_success', u => { me = u; localStorage.setItem('litegram_user', JSON.stringify(u)); enterApp(u); });

        function enterApp(u) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('my-avatar').src = u.avatar || 'https://www.w3schools.com/howto/img_avatar.png';
            document.getElementById('my-name-display').innerText = u.name;
            switchRoom('global');
        }

        function switchRoom(id) {
            currentRoom = id;
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chat-title').innerText = id === 'global' ? 'üåê –û–±—â–∏–π —á–∞—Ç' : 'üí¨ ' + id;
            socket.emit('join', {room: id});
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ –≤—ã–¥–µ–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
            document.querySelectorAll('.chat-item').forEach(el => el.classList.remove('active'));
            // (–í —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç—É—Ç –Ω—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç –ø–æ ID)
        }

        function createNew(type) {
            const name = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ ${type === 'group' ? '–≥—Ä—É–ø–ø—ã' : '–∫–∞–Ω–∞–ª–∞'}:`);
            if(name) {
                const id = name.toLowerCase().replace(/ /g, '_');
                const html = `
                    <div class="chat-item" onclick="switchRoom('${id}')">
                        <div class="chat-icon">${type === 'group' ? 'üë•' : 'üì¢'}</div>
                        <div style="margin-left:12px;">
                            <b>${name}</b>
                            <div style="font-size:12px; color:#aaa;">${type === 'group' ? '–ì—Ä—É–ø–ø–∞' : '–ö–∞–Ω–∞–ª'}</div>
                        </div>
                    </div>`;
                document.getElementById('chats-list').insertAdjacentHTML('beforeend', html);
                socket.emit('create_room', {name: name, type: type, id: id});
            }
        }

        function changeAv() {
            const url = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ (URL):");
            if(url) {
                socket.emit('update_avatar', {nick: me.nick, avatar: url});
                document.getElementById('my-avatar').src = url;
            }
        }

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value.trim()) {
                socket.emit('message', {user: me.name, nick: '@'+me.nick, text: i.value, room: currentRoom, type: 'text'});
                i.value = '';
            }
        }

        // –ì–æ–ª–æ—Å–æ–≤—ã–µ
        const vBtn = document.getElementById('voice-btn');
        vBtn.onmousedown = async () => {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const reader = new FileReader();
                reader.readAsDataURL(new Blob(audioChunks, {type:'audio/ogg'}));
                reader.onloadend = () => socket.emit('message', {user:me.name, nick:'@'+me.nick, audio:reader.result, room:currentRoom, type:'audio'});
            };
            mediaRecorder.start();
            vBtn.style.color = 'red';
        };
        vBtn.onmouseup = () => { if(mediaRecorder) mediaRecorder.stop(); vBtn.style.color = 'white'; };

        // –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π
        function addMsg(d) {
            const m = document.getElementById('messages'), isMy = d.nick === '@' + me.nick;
            let body = d.text;
            if(d.type === 'audio') body = `<audio src="${d.audio}" controls style="height:30px; width:200px;"></audio>`;
            
            const html = `
                <div class="msg ${isMy ? 'my-msg' : ''}">
                    <img class="avatar" src="${d.avatar || 'https://www.w3schools.com/howto/img_avatar.png'}" style="width:30px; height:30px;">
                    <div class="msg-content">
                        <b style="font-size:10px; opacity:0.5">${d.user}</b><br>
                        ${body}
                    </div>
                </div>`;
            m.insertAdjacentHTML('beforeend', html);
            m.scrollTop = m.scrollHeight;
        }

        socket.on('render_message', addMsg);
        socket.on('history', ms => ms.forEach(addMsg));
        
        function filterChats(val) {
            const items = document.querySelectorAll('.chat-item');
            items.forEach(it => {
                it.style.display = it.innerText.toLowerCase().includes(val.toLowerCase()) ? 'flex' : 'none';
            });
        }
    </script>
</body>
</html>
