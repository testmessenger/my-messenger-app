<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Nexus Messenger | v1.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 2px solid #3b82f6; }
        .dark body { background: #0f172a; color: #e2e8f0; }
        .light body { background: #f1f5f9; color: #0f172a; }
    </style>
</head>
<body class="flex h-screen overflow-hidden transition-all">

    <aside class="w-80 bg-slate-900 border-r border-slate-800 flex flex-col">
        <div class="p-4 border-b border-slate-800 flex justify-between">
            <h1 class="text-xl font-black text-blue-500">NEXUS</h1>
            <button onclick="toggleTheme()"><i data-lucide="moon"></i></button>
        </div>
        <div class="p-4"><input placeholder="Поиск..." class="w-full bg-slate-800 p-2 rounded-lg border-none"></div>
        <div id="chat-list" class="flex-1 overflow-y-auto">
             <div class="p-4 bg-blue-600/10 border-l-4 border-blue-500 cursor-pointer">
                 <p class="font-bold"># Общий чат</p>
                 <p class="text-xs opacity-50">Нажмите, чтобы войти</p>
             </div>
        </div>
        <div class="p-4 border-t border-slate-800">
            <div class="flex items-center gap-3">
                <img src="{{ user.avatar }}" class="w-10 h-10 rounded-full border-2 border-green-500">
                <div class="flex-1 min-w-0">
                    <p class="font-bold truncate">{{ user.display_name }}</p>
                    <p class="text-[10px] opacity-50">@{{ user.username }}</p>
                </div>
                <button onclick="openSettings()"><i data-lucide="settings" class="w-5"></i></button>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col bg-slate-950/50">
        <header class="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/50">
            <h2 id="chat-title" class="font-bold"># general</h2>
            <div class="flex gap-4 opacity-70">
                <i data-lucide="phone" class="cursor-pointer hover:text-blue-500"></i>
                <i data-lucide="video" class="cursor-pointer hover:text-blue-500"></i>
            </div>
        </header>

        <div id="messages-area" class="flex-1 overflow-y-auto p-6 space-y-4">
            </div>

        <footer class="p-4 bg-slate-900 border-t border-slate-800">
            <div class="flex items-end gap-3 max-w-5xl mx-auto">
                <button class="mb-2"><i data-lucide="paperclip"></i></button>
                <textarea id="msgInput" rows="1" placeholder="Ваше сообщение..." class="flex-1 bg-slate-800 rounded-xl p-3 focus:outline-none focus:ring-1 focus:ring-blue-500"></textarea>
                <button onclick="send()" class="mb-1 bg-blue-600 p-3 rounded-full"><i data-lucide="send" class="text-white"></i></button>
                <button id="circleBtn" class="mb-1 bg-slate-700 p-3 rounded-full hover:bg-red-500 transition-colors"><i data-lucide="camera"></i></button>
            </div>
        </footer>
    </main>

    <script>
        lucide.createIcons();
        const socket = io();
        const myId = "{{ session.user_id }}";
        let currentRoom = "general";

        socket.emit('join', {room: currentRoom});

        function send() {
            const txt = document.getElementById('msgInput').value;
            if(!txt) return;
            socket.emit('send_msg', { room: currentRoom, text: txt, type: 'text' });
            document.getElementById('msgInput').value = '';
        }

        socket.on('new_message', (data) => {
            const area = document.getElementById('messages-area');
            const isMe = data.sender_id === myId;
            
            let content = `<p>${data.text}</p>`;
            if(data.type === 'video_circle') {
                content = `<video src="${data.file_url}" class="video-note" controls></video>`;
            }

            const html = `
                <div class="flex ${isMe ? 'justify-end' : 'justify-start'} group">
                    <div class="flex gap-2 max-w-[70%]">
                        ${!isMe ? `<img src="${data.sender_avatar}" class="w-8 h-8 rounded-full self-end">` : ''}
                        <div class="${isMe ? 'bg-blue-600' : 'bg-slate-800'} p-3 rounded-2xl relative">
                            ${!isMe ? `<p class="text-[10px] font-bold mb-1 text-blue-300">@${data.sender_name}</p>` : ''}
                            ${content}
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[9px] opacity-50">${data.ts.split('T')[1].slice(0,5)}</span>
                                <span class="cursor-pointer hover:scale-125 transition-transform text-[10px]">❤️</span>
                            </div>
                            ${isMe ? `<button onclick="deleteMsg('${data._id}')" class="absolute -left-8 top-2 opacity-0 group-hover:opacity-100 text-red-400">✕</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            area.insertAdjacentHTML('beforeend', html);
            area.scrollTop = area.scrollHeight;
        });

        function toggleTheme() {
            document.documentElement.classList.toggle('dark');
            document.documentElement.classList.toggle('light');
        }

        function deleteMsg(id) {
            socket.emit('delete_msg', {msg_id: id});
        }

        socket.on('msg_deleted', (id) => { location.reload(); }); // Простое решение для обновления
    </script>
</body>
</html>
