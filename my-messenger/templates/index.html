<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Elite+</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --text: #ffffff; --primary: #2481cc; --online: #4ade80; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-ui { background: var(--surface); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin: 5px; width: 260px; }

        #sidebar { width: 300px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: #080e15; }
        
        .header { background: var(--surface); padding: 10px 15px; border-bottom: 1px solid #000; display: flex; align-items: center; gap: 12px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è –∏ –†–µ–∞–∫—Ü–∏–∏ */
        .msg { display: flex; gap: 10px; max-width: 80%; position: relative; margin-bottom: 10px; }
        .msg-content { background: var(--surface); padding: 10px; border-radius: 15px; position: relative; min-width: 60px; }
        .my-msg { align-self: flex-end; flex-direction: row-reverse; }
        .my-msg .msg-content { background: var(--primary); }
        
        .reactions-bar { display: flex; gap: 4px; margin-top: 5px; flex-wrap: wrap; }
        .reaction { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 2px 6px; font-size: 12px; cursor: pointer; border: 1px solid transparent; }
        .reaction.active { border-color: var(--primary); background: rgba(36, 129, 204, 0.3); }

        .emoji-picker { position: absolute; bottom: 70px; left: 50px; background: var(--surface); border: 1px solid #333; padding: 10px; display: none; grid-template-columns: repeat(5, 1fr); gap: 5px; border-radius: 10px; z-index: 100; }
        .emoji-btn { cursor: pointer; font-size: 20px; transition: 0.2s; }
        .emoji-btn:hover { transform: scale(1.3); }

        .avatar-circle { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .controls { background: var(--surface); padding: 10px; display: flex; gap: 10px; align-items: center; position: relative; }
        
        .msg-tools { position: absolute; top: -20px; right: 10px; display: none; gap: 10px; background: #222; padding: 2px 8px; border-radius: 5px; font-size: 12px; }
        .msg:hover .msg-tools { display: flex; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color: var(--primary)">LiteGram</h1>
        <input type="text" id="r-name" class="input-ui" placeholder="–ò–º—è">
        <input type="text" id="r-user" class="input-ui" placeholder="@username">
        <input type="password" id="r-pass" class="input-ui" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" style="background:var(--primary); color:white; border:none; padding:12px 80px; border-radius:8px; cursor:pointer;">–í–û–ô–¢–ò</button>
    </div>

    <div id="main-container" style="display:none; width: 100%;">
        <div id="sidebar">
            <div class="header"><b>–ß–∞—Ç—ã</b></div>
            <div id="list-items" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div id="chat-window">
            <div class="header"><b id="chat-title">–û–±—â–∏–π —á–∞—Ç</b></div>
            <div id="messages"></div>
            
            <div class="emoji-picker" id="picker">
                <span class="emoji-btn" onclick="addEmoji('üëç')">üëç</span>
                <span class="emoji-btn" onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
                <span class="emoji-btn" onclick="addEmoji('üòÇ')">üòÇ</span>
                <span class="emoji-btn" onclick="addEmoji('üî•')">üî•</span>
                <span class="emoji-btn" onclick="addEmoji('üòÆ')">üòÆ</span>
            </div>

            <div class="controls">
                <button onclick="document.getElementById('picker').style.display='grid'" style="background:none; border:none; font-size:20px; cursor:pointer;">üòä</button>
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:#080e15; color:white; border:none; padding:12px; border-radius:10px;">
                <button onclick="send()" style="background:none; border:none; color:var(--primary); font-size:26px; cursor:pointer;">‚û§</button>
            </div>
        </div>
    </div>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script>
        const socket = io();
        let me = null, currentRoom = "–û–±—â–∏–π —á–∞—Ç";

        function login() {
            const n = document.getElementById('r-name').value, u = document.getElementById('r-user').value.toLowerCase(), p = document.getElementById('r-pass').value;
            if(n && u && p) socket.emit('login_attempt', {name:n, nick:u, pass:p});
        }

        socket.on('login_success', u => {
            me = u; document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            switchRoom(currentRoom);
            setInterval(() => socket.emit('update_status', {nick: me.nick}), 5000);
        });

        function switchRoom(n) {
            currentRoom = n; document.getElementById('chat-title').innerText = n;
            document.getElementById('messages').innerHTML = ""; 
            socket.emit('join', {room: n, nick: me.nick});
        }

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value) { 
                socket.emit('message', {user: me.name, nick: '@'+me.nick, text: i.value, room: currentRoom}); 
                i.value = ''; 
                document.getElementById('picker').style.display='none';
            }
        }

        function addEmoji(e) { document.getElementById('msg-input').value += e; }

        function addMsg(d) {
            const m = document.getElementById('messages'), isMy = d.nick === '@' + me.nick;
            if(!isMy) document.getElementById('notif-sound').play();

            const html = `
                <div class="msg ${isMy ? 'my-msg' : ''}" id="msg-${d._id}">
                    <img class="avatar-circle" src="${d.avatar || 'https://www.w3schools.com/howto/img_avatar.png'}">
                    <div class="msg-content">
                        <div class="msg-tools">
                            <span onclick="react('${d._id}', 'üëç')">üëç</span>
                            <span onclick="react('${d._id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span onclick="react('${d._id}', 'üî•')">üî•</span>
                            ${isMy ? `<span onclick="deleteMsg('${d._id}')">üóë</span>` : ''}
                        </div>
                        <b style="font-size:11px; opacity:0.7;">${d.user}</b><br>
                        <span>${d.text}</span>
                        <div class="reactions-bar" id="reacts-${d._id}"></div>
                    </div>
                </div>`;
            m.insertAdjacentHTML('beforeend', html);
            if(d.reactions) updateReactsUI(d._id, d.reactions);
            m.scrollTop = m.scrollHeight;
        }

        function react(id, emoji) { socket.emit('add_reaction', {msg_id: id, emoji: emoji, nick: me.nick, room: currentRoom}); }
        
        socket.on('update_reactions', d => updateReactsUI(d.msg_id, d.reactions));

        function updateReactsUI(id, reacts) {
            const container = document.getElementById(`reacts-${id}`);
            if(!container) return;
            container.innerHTML = Object.entries(reacts).map(([emoji, users]) => `
                <span class="reaction ${users.includes(me.nick) ? 'active' : ''}" onclick="react('${id}', '${emoji}')">
                    ${emoji} ${users.length}
                </span>
            `).join('');
        }

        function deleteMsg(id) { socket.emit('delete_msg_global', {msg_id: id, room: currentRoom}); }
        socket.on('msg_deleted_confirm', d => document.getElementById(`msg-${d.msg_id}`)?.remove());

        socket.on('render_message', addMsg);
        socket.on('history', msgs => msgs.forEach(addMsg));

        function login_error(m) { alert(m); }
    </script>
</body>
</html>
