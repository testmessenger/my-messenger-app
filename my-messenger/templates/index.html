<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Elite</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --text: #ffffff; --primary: #2481cc; --online: #4ade80; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-ui { background: var(--surface); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin: 5px; width: 260px; outline: none; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .avatar-circle { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; cursor: pointer; }
        #profile-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--surface); padding: 30px; border-radius: 15px; z-index: 3000; display: none; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); }

        #sidebar { width: 300px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: #080e15; }
        
        .header { background: var(--surface); padding: 10px 15px; border-bottom: 1px solid #000; display: flex; align-items: center; gap: 12px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .msg { display: flex; gap: 10px; max-width: 75%; position: relative; }
        .msg-content { background: var(--surface); padding: 10px 14px; border-radius: 15px; position: relative; }
        .my-msg { align-self: flex-end; flex-direction: row-reverse; }
        .my-msg .msg-content { background: var(--primary); }
        
        .video-circle { width: 220px; height: 220px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .delete-overlay { position: absolute; top: 0; right: 0; cursor: pointer; font-size: 12px; display: none; background: rgba(255,0,0,0.7); border-radius: 50%; width: 18px; height: 18px; text-align: center; }
        .msg:hover .delete-overlay { display: block; }

        .controls { background: var(--surface); padding: 10px; display: flex; gap: 10px; align-items: center; }
        .rec-btn { cursor: pointer; font-size: 22px; background: none; border: none; color: var(--text); }
        .rec-active { color: #ff4d4d; animation: blink 0.8s infinite; }
        @keyframes blink { 50% { opacity: 0.4; } }
        
        #video-preview { position: fixed; bottom: 80px; right: 20px; width: 160px; height: 160px; border-radius: 50%; object-fit: cover; display: none; transform: scaleX(-1); border: 3px solid var(--primary); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color: var(--primary)">LiteGram</h1>
        <input type="text" id="r-name" class="input-ui" placeholder="–ò–º—è">
        <input type="text" id="r-user" class="input-ui" placeholder="@username">
        <input type="password" id="r-pass" class="input-ui" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" style="background: var(--primary); color: white; border: none; padding: 12px 100px; border-radius: 8px; cursor: pointer;">–í–û–ô–¢–ò</button>
    </div>

    <div id="profile-modal">
        <h3>–í–∞—à –ø—Ä–æ—Ñ–∏–ª—å</h3>
        <img id="my-avatar-big" class="avatar-circle" style="width:100px; height:100px; margin-bottom:15px;">
        <br>
        <input type="file" id="avatar-input" style="display:none" onchange="uploadAvatar(this)">
        <button onclick="document.getElementById('avatar-input').click()" style="background:var(--primary); color:white; border:none; padding:8px 15px; border-radius:5px;">–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
        <button onclick="document.getElementById('profile-modal').style.display='none'" style="margin-top:20px; display:block; width:100%; background:none; color:white; border:1px solid #555;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>

    <div id="main-container" style="display:none; width: 100%;">
        <div id="sidebar">
            <div class="header">
                <img id="my-avatar-mini" class="avatar-circle" onclick="document.getElementById('profile-modal').style.display='block'">
                <input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫..." style="flex:1; background:#080e15; border:none; color:white; padding:8px; border-radius:8px;">
                <button onclick="searchUser()" style="background:none; border:none; color:white;">üîç</button>
            </div>
            <div id="list-items" style="flex:1; overflow-y:auto;"></div>
        </div>

        <div id="chat-window">
            <div class="header">
                <div><b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b><br><small id="user-status"></small></div>
            </div>
            <div id="messages"></div>
            <video id="video-preview" autoplay muted></video>
            <div class="controls">
                <button class="rec-btn" onmousedown="startRec('audio')" onmouseup="stopRec()">üé§</button>
                <button class="rec-btn" onmousedown="startRec('video')" onmouseup="stopRec()">üì∑</button>
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:#080e15; color:white; border:none; padding:12px; border-radius:10px;">
                <button onclick="send()" style="background:none; border:none; color:var(--primary); font-size:26px;">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = "–û–±—â–∏–π —á–∞—Ç", chatList = ["–û–±—â–∏–π —á–∞—Ç"], mediaRec, chunks = [];

        function login() {
            const n = document.getElementById('r-name').value, u = document.getElementById('r-user').value.toLowerCase(), p = document.getElementById('r-pass').value;
            if(n && u && p) socket.emit('login_attempt', {name:n, nick:u, pass:p});
        }

        socket.on('login_success', u => {
            me = u; document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            document.getElementById('my-avatar-mini').src = u.avatar || 'https://www.w3schools.com/howto/img_avatar.png';
            document.getElementById('my-avatar-big').src = u.avatar || 'https://www.w3schools.com/howto/img_avatar.png';
            switchRoom(currentRoom);
            setInterval(() => socket.emit('update_status', {nick: me.nick}), 5000);
        });

        function uploadAvatar(input) {
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                socket.emit('update_avatar', {nick: me.nick, avatar: base64});
                document.getElementById('my-avatar-mini').src = base64;
                document.getElementById('my-avatar-big').src = base64;
            };
            reader.readAsDataURL(input.files[0]);
        }

        function switchRoom(n) {
            currentRoom = n; document.getElementById('chat-title').innerText = n;
            document.getElementById('messages').innerHTML = ""; 
            socket.emit('join', {room: n, nick: me.nick});
            if(!chatList.includes(n)) chatList.push(n); renderList();
        }

        function renderList() {
            document.getElementById('list-items').innerHTML = chatList.map(r => `<div class="chat-item" onclick="switchRoom('${r}')" style="padding:15px; cursor:pointer; border-bottom:1px solid #000;">${r}</div>`).join('');
        }

        async function startRec(type) {
            chunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: type === 'video' });
            if(type === 'video') { document.getElementById('video-preview').style.display = 'block'; document.getElementById('video-preview').srcObject = stream; }
            mediaRec = new MediaRecorder(stream);
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.onstop = () => {
                const blob = new Blob(chunks, { type: type === 'video' ? 'video/webm' : 'audio/webm' });
                const reader = new FileReader();
                reader.onload = () => socket.emit('message', { user: me.name, nick: '@'+me.nick, room: currentRoom, file: reader.result, file_type: blob.type });
                reader.readAsDataURL(blob);
                stream.getTracks().forEach(t => t.stop());
                document.getElementById('video-preview').style.display = 'none';
            };
            mediaRec.start();
        }
        function stopRec() { mediaRec.stop(); }

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value) { socket.emit('message', {user: me.name, nick: '@'+me.nick, text: i.value, room: currentRoom}); i.value = ''; }
        }

        function addMsg(d) {
            const m = document.getElementById('messages'), isMy = d.nick === '@' + me.nick;
            let content = `<span>${d.text || ''}</span>`;
            if(d.file) {
                if(d.file_type.includes('video')) content = `<video src="${d.file}" class="video-circle" controls></video>`;
                else if(d.file_type.includes('audio')) content = `<audio src="${d.file}" controls></audio>`;
            }
            const html = `
                <div class="msg ${isMy ? 'my-msg' : ''}" id="msg-${d._id}">
                    <img class="avatar-circle" src="${d.avatar || 'https://www.w3schools.com/howto/img_avatar.png'}" style="width:30px; height:30px;">
                    <div class="msg-content">
                        ${isMy ? `<div class="delete-overlay" onclick="deleteGlobal('${d._id}')">√ó</div>` : ''}
                        <b style="font-size:11px; color:#aaa;">${d.user}</b><br>${content}
                    </div>
                </div>`;
            m.insertAdjacentHTML('beforeend', html);
            m.scrollTop = m.scrollHeight;
        }

        function deleteGlobal(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å —É –≤—Å–µ—Ö?")) socket.emit('delete_msg_global', {msg_id: id, room: currentRoom}); }
        socket.on('msg_deleted_confirm', d => document.getElementById(`msg-${d.msg_id}`)?.remove());
        socket.on('render_message', addMsg);
        socket.on('history', msgs => msgs.forEach(addMsg));
        
        function searchUser() { socket.emit('search_user', {query: document.getElementById('user-search').value}); }
        socket.on('user_found', u => switchRoom([me.nick, u.nick].sort().join('_')));
        
        socket.on('status_updated', d => {
            if(currentRoom.includes(d.nick)) {
                const online = (Date.now()/1000 - d.last_seen) < 15;
                document.getElementById('user-status').innerText = online ? "–≤ —Å–µ—Ç–∏" : "–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ";
                document.getElementById('user-status').style.color = online ? "var(--online)" : "#aaa";
            }
        });
    </script>
</body>
</html>
