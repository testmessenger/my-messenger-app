<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; border: 3px solid #3b82f6; object-fit: cover; }
        #incoming-call-modal { animation: slideIn 0.5s ease; }
        @keyframes slideIn { from { transform: translateY(-100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#020617] text-slate-200 flex h-screen overflow-hidden">

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>

    <aside class="w-80 border-r border-slate-800 flex flex-col bg-[#0f172a]">
        <div class="p-4 flex justify-between items-center border-b border-slate-800">
            <h1 class="text-xl font-black text-blue-500">NEXUS</h1>
            <button onclick="createGroup()" class="bg-blue-600 p-2 rounded-lg"><i data-lucide="plus"></i></button>
        </div>
        <div id="chats-list" class="flex-1 overflow-y-auto p-2">
            <div onclick="switchRoom('general', 'Общий чат')" class="p-3 hover:bg-slate-800 rounded-xl cursor-pointer"># Общий чат</div>
            <div id="my-groups-list"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/40">
            <h2 id="header-title" class="font-bold"># general</h2>
            <button id="call-btn" onclick="initiateCall()" class="hidden bg-green-600 p-2 rounded-full text-white"><i data-lucide="phone"></i></button>
        </header>
        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4"></div>
        <footer class="p-4 bg-slate-900/20">
            <div class="max-w-4xl mx-auto flex items-center gap-2 bg-slate-800 p-2 rounded-2xl">
                <textarea id="msgInput" rows="1" class="flex-1 bg-transparent p-2 outline-none resize-none"></textarea>
                <button onmousedown="startVoice()" onmouseup="stopVoice()" onclick="takeVideoCircle()" class="p-2"><i data-lucide="mic" id="mic-icon"></i></button>
                <button onclick="send()" class="p-3 bg-blue-600 rounded-xl"><i data-lucide="send"></i></button>
            </div>
        </footer>

        <div id="call-overlay" class="hidden absolute inset-0 z-[200] bg-slate-950 flex flex-col items-center justify-center">
            <div class="relative w-full h-full flex items-center justify-center">
                <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
                <video id="localVideo" autoplay playsinline muted class="absolute top-10 right-10 w-48 h-72 border-2 border-blue-500 rounded-2xl object-cover"></video>
            </div>
            <div class="absolute bottom-10 flex gap-6">
                <button onclick="toggleMic()" id="mic-toggle" class="p-6 bg-slate-800 rounded-full"><i data-lucide="mic"></i></button>
                <button onclick="toggleCam()" id="cam-toggle" class="p-6 bg-slate-800 rounded-full"><i data-lucide="video"></i></button>
                <button onclick="endCall()" class="p-6 bg-red-600 rounded-full"><i data-lucide="phone-off"></i></button>
            </div>
        </div>

        <div id="incoming-call-modal" class="hidden absolute top-5 left-1/2 -translate-x-1/2 w-80 bg-blue-600 p-4 rounded-3xl shadow-2xl z-[300] flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center"><i data-lucide="phone-incoming"></i></div>
                <div>
                    <p class="font-bold text-sm" id="caller-name-label">Вызов...</p>
                    <p class="text-[10px] opacity-80 uppercase font-bold">Входящий звонок</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="acceptCall()" class="p-2 bg-green-500 rounded-full"><i data-lucide="check"></i></button>
                <button onclick="rejectCall()" class="p-2 bg-red-500 rounded-full"><i data-lucide="x"></i></button>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        const socket = io();
        const myId = "{{ user._id }}";
        const myName = "{{ user.display_name }}";
        let currentRoom = "general";
        let peerConnection;
        let localStream;
        let incomingOffer;

        const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

        // --- УВЕДОМЛЕНИЯ ---
        Notification.requestPermission();
        socket.on('notify', (data) => {
            document.getElementById('notif-sound').play();
            if (Notification.permission === "granted") {
                new Notification(data.title, { body: data.body });
            }
        });

        // --- ЛОГИКА ЗВОНКА (WebRTC) ---
        async function initiateCall() {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;
            document.getElementById('call-overlay').classList.remove('hidden');

            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = e => {
                if (e.candidate) socket.emit('ice_candidate', { room: currentRoom, candidate: e.candidate });
            };
            peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            socket.emit('call_user', { room: currentRoom, from: myId, caller_name: myName, offer: offer });
        }

        socket.on('incoming_call', async (data) => {
            incomingOffer = data;
            document.getElementById('caller-name-label').innerText = data.caller_name;
            document.getElementById('incoming-call-modal').classList.remove('hidden');
            document.getElementById('ringtone').play();
        });

        async function acceptCall() {
            document.getElementById('ringtone').pause();
            document.getElementById('incoming-call-modal').classList.add('hidden');
            document.getElementById('call-overlay').classList.remove('hidden');

            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;

            peerConnection = new RTCPeerConnection(config);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            peerConnection.onicecandidate = e => {
                if (e.candidate) socket.emit('ice_candidate', { room: currentRoom, candidate: e.candidate });
            };
            peerConnection.ontrack = e => document.getElementById('remoteVideo').srcObject = e.streams[0];

            await peerConnection.setRemoteDescription(new RTCSessionDescription(incomingOffer.offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);
            socket.emit('answer_call', { room: currentRoom, answer: answer });
        }

        socket.on('call_accepted', async (data) => {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.answer));
        });

        socket.on('ice_candidate', c => peerConnection?.addIceCandidate(new RTCIceCandidate(c)));

        function rejectCall() {
            document.getElementById('ringtone').pause();
            document.getElementById('incoming-call-modal').classList.add('hidden');
            socket.emit('hangup', { room: currentRoom });
        }

        function endCall() {
            localStream?.getTracks().forEach(t => t.stop());
            peerConnection?.close();
            document.getElementById('call-overlay').classList.add('hidden');
            socket.emit('hangup', { room: currentRoom });
        }

        socket.on('call_ended', () => {
            alert("Звонок завершен");
            location.reload();
        });

        // Кнопки управления в звонке
        function toggleMic() {
            const track = localStream.getAudioTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('mic-toggle').classList.toggle('bg-red-500', !track.enabled);
        }
        function toggleCam() {
            const track = localStream.getVideoTracks()[0];
            track.enabled = !track.enabled;
            document.getElementById('cam-toggle').classList.toggle('bg-red-500', !track.enabled);
        }

        // --- ОСТАЛЬНЫЕ ФУНКЦИИ (НЕ ВЫРЕЗАНО) ---
        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('header-title').innerText = title;
            document.getElementById('chat-window').innerHTML = '';
            document.getElementById('call-btn').classList.toggle('hidden', id === 'general' || id.length === 24);
            socket.emit('join_room', { room: id });
        }

        function send() {
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            socket.emit('send_msg', { room: currentRoom, text: val });
            document.getElementById('msgInput').value = '';
        }
    </script>
</body>
</html>
