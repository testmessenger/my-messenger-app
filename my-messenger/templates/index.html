<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>LiteGram Pro Control</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surf: #17212b; --accent: #2481cc; --text: #fff; --msg-my: #2b5278; --msg-other: #182533; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; font-family: sans-serif; }
        
        #sidebar { width: 300px; background: var(--surf); border-right: 1px solid #000; display: flex; flex-direction: column; }
        .chat-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; }
        .chat-item.active { background: var(--accent); }

        #chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { max-width: 70%; padding: 10px; border-radius: 12px; position: relative; }
        .msg.my { align-self: flex-end; background: var(--msg-my); }
        .msg.other { align-self: flex-start; background: var(--msg-other); }

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */
        #user-menu { display: none; position: fixed; background: #2c3e50; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 1000; padding: 5px; }
        #user-menu button { display: block; width: 100%; padding: 8px 15px; background: none; border: none; color: white; text-align: left; cursor: pointer; border-radius: 4px; }
        #user-menu button:hover { background: var(--accent); }

        .admin-badge { font-size: 10px; background: #e74c3c; padding: 2px 5px; border-radius: 4px; margin-left: 5px; }
        .mute-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; border-radius: 10px; z-index: 100; }
        
        .btn-icon { background: none; border: none; color: #808b99; cursor: pointer; font-size: 20px; padding: 5px; }
        #v-preview { position: absolute; bottom: 80px; right: 20px; width: 120px; height: 120px; border-radius: 50%; border: 2px solid red; display: none; }
        .file-link { color: var(--accent); text-decoration: none; display: block; margin-top: 5px; border: 1px dashed #444; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="user-menu">
        <div id="menu-target-name" style="padding: 8px; border-bottom: 1px solid #444; font-weight: bold; font-size: 12px;"></div>
        <button onclick="adminDo('promote')">–ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º</button>
        <button onclick="adminDo('mute')">–ó–∞–º—É—Ç–∏—Ç—å</button>
        <button onclick="adminDo('ban')" style="color: #ff4d4d;">–ó–∞–±–∞–Ω–∏—Ç—å</button>
    </div>

    <div id="sidebar">
        <div style="padding: 15px; border-bottom: 1px solid #000; display: flex; justify-content: space-between;">
            <b id="my-nick">LiteGram</b>
            <button onclick="createRoom()" style="background:var(--accent); border:none; color:white; border-radius:4px; cursor:pointer;">+</button>
        </div>
        <div id="rooms-list"></div>
    </div>

    <div id="chat-area">
        <video id="v-preview" autoplay muted></video>
        <div style="padding: 10px 20px; background: var(--surf); border-bottom: 1px solid #000;">
            <b id="active-chat-name">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
        </div>
        
        <div id="messages"></div>

        <div id="input-container" style="padding: 15px; background: var(--surf); display: flex; align-items: center; gap: 10px; position: relative;">
            <div id="mute-msg" class="mute-overlay">–í—ã –∑–∞–º—É—á–µ–Ω—ã –≤ —ç—Ç–æ–º —á–∞—Ç–µ</div>
            <label class="btn-icon">üìé<input type="file" onchange="uploadFile(this)" style="display:none"></label>
            <button class="btn-icon" onclick="recordMedia('video')">üì∑</button>
            <input id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:none; border:none; color:white; outline:none;" onkeypress="if(event.key==='Enter') send()">
            <button class="btn-icon" onclick="recordMedia('audio')">üé§</button>
            <button onclick="send()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:20px;">‚û§</button>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = 'global', selectedUser = null, roomData = {}, isRec = false, mediaRec, chunks = [];

        window.onload = () => {
            const s = localStorage.getItem('lg_creds');
            if(s) socket.emit('login_attempt', JSON.parse(s)); else login();
        };

        function login() {
            const n = prompt("–ù–∏–∫?"); const p = prompt("–ü–∞—Ä–æ–ª—å?");
            if(n && p) {
                const c = {nick: n.replace('@','').toLowerCase(), pass: p};
                localStorage.setItem('lg_creds', JSON.stringify(c));
                socket.emit('login_attempt', c);
            }
        }

        socket.on('login_success', u => {
            me = u; document.getElementById('my-nick').innerText = u.nick;
            socket.emit('get_my_rooms', {nick: me.nick});
        });

        socket.on('load_rooms', rs => {
            const l = document.getElementById('rooms-list'); l.innerHTML = '';
            rs.forEach(r => {
                const d = document.createElement('div');
                d.className = 'chat-item' + (currentRoom===r.id?' active':'');
                d.innerHTML = `<span>${r.name}</span>`;
                d.onclick = () => switchRoom(r.id, r.name);
                l.appendChild(d);
            });
        });

        function switchRoom(id, name) {
            currentRoom = id;
            document.getElementById('active-chat-name').innerText = name;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join', {room: id, nick: me.nick});
        }

        socket.on('room_update', data => {
            roomData = data;
            const isMuted = data.muted.includes(me.nick);
            document.getElementById('mute-msg').style.display = isMuted ? 'flex' : 'none';
        });

        socket.on('user_banned', data => {
            if(data.target === me.nick) {
                alert("–í—ã –±—ã–ª–∏ –∑–∞–±–∞–Ω–µ–Ω—ã!");
                location.reload();
            }
        });

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        function openUserMenu(e, targetNick) {
            e.preventDefault();
            const isOwner = roomData.owner === me.nick;
            const isAdmin = roomData.admins.includes(me.nick);
            
            if((isOwner || isAdmin) && targetNick !== me.nick) {
                selectedUser = targetNick;
                const menu = document.getElementById('user-menu');
                document.getElementById('menu-target-name').innerText = "@" + targetNick;
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';
            }
        }

        document.addEventListener('click', () => document.getElementById('user-menu').style.display = 'none');

        function adminDo(action) {
            socket.emit('admin_action', {room: currentRoom, nick: me.nick, target: selectedUser, action: action});
        }

        function send() {
            const i = document.getElementById('msg-in');
            if(i.value.trim()) {
                socket.emit('message', {room: currentRoom, text: i.value, nick: me.nick, user: me.nick});
                i.value = '';
            }
        }

        function uploadFile(input) {
            const f = input.files[0]; if(!f) return;
            const r = new FileReader();
            r.onload = (e) => socket.emit('message', {room:currentRoom, nick:me.nick, user:me.nick, file:e.target.result, fileName:f.name, fileType:f.type});
            r.readAsDataURL(f);
        }

        socket.on('render_message', d => { if(d.room === currentRoom) addMsg(d); });
        socket.on('history', h => h.forEach(addMsg));

        function addMsg(d) {
            const b = document.getElementById('messages');
            let c = d.text ? `<div>${d.text}</div>` : '';
            if(d.file) {
                if(d.fileType.startsWith('image/')) c = `<img src="${d.file}" style="max-width:100%; border-radius:8px;">`;
                else c = `<a href="${d.file}" download="${d.fileName}" class="file-link">üìÑ ${d.fileName}</a>`;
            }
            if(d.sticker) c = `<img src="${d.sticker}" width="80">`;
            if(d.video) c = `<video src="${d.video}" autoplay loop muted style="width:150px; border-radius:50%;"></video>`;
            if(d.voice) c = `<audio controls src="${d.voice}" style="width:180px;"></audio>`;

            const isMy = d.nick === me.nick;
            const isAdmin = roomData.admins && roomData.admins.includes(d.nick);
            const isOwner = roomData.owner === d.nick;

            const h = `
                <div class="msg ${isMy?'my':'other'}">
                    <small style="color:var(--accent); font-weight:bold; cursor:pointer;" oncontextmenu="openUserMenu(event, '${d.nick}')">
                        ${d.user} ${isOwner ? '<span class="admin-badge">–°–æ–∑–¥–∞—Ç–µ–ª—å</span>' : (isAdmin ? '<span class="admin-badge" style="background:gray">–ê–¥–º–∏–Ω</span>' : '')}
                    </small>
                    ${c}
                </div>`;
            b.insertAdjacentHTML('beforeend', h);
            b.scrollTop = b.scrollHeight;
        }

        function createRoom() {
            const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã?");
            if(n) socket.emit('create_room', {name: n, creator_nick: me.nick});
        }

        // –ú–µ–¥–∏–∞ —Ñ—É–Ω–∫—Ü–∏–∏ (–ö—Ä—É–∂–æ—á–∫–∏ –∏ –≥–æ–ª–æ—Å)
        async function recordMedia(mode) {
            if(!isRec) {
                const s = await navigator.mediaDevices.getUserMedia({audio:true, video:mode==='video'});
                if(mode==='video') { const p=document.getElementById('v-preview'); p.srcObject=s; p.style.display='block'; }
                mediaRec = new MediaRecorder(s); chunks = [];
                mediaRec.ondataavailable = e => chunks.push(e.data);
                mediaRec.onstop = () => {
                    const b = new Blob(chunks, {type: mode==='video'?'video/webm':'audio/webm'});
                    const r = new FileReader(); r.readAsDataURL(b);
                    r.onloadend = () => socket.emit('message', {room:currentRoom, [mode]:r.result, nick:me.nick, user:me.nick});
                    s.getTracks().forEach(t => t.stop());
                    document.getElementById('v-preview').style.display='none';
                };
                mediaRec.start(); isRec=true;
            } else { mediaRec.stop(); isRec=false; }
        }
    </script>
</body>
</html>
