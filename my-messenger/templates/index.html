<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Nexus Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 3px solid #3b82f6; }
        .dark body { background: #020617; color: #f1f5f9; }
        .light body { background: #f8fafc; color: #0f172a; }
        .active-chat { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <aside class="w-80 border-r border-slate-800 flex flex-col bg-slate-900/40">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-xl font-black text-blue-500">NEXUS</h1>
            <button onclick="createGroupPrompt()" class="bg-blue-600 p-2 rounded-lg text-white hover:bg-blue-500"><i data-lucide="plus"></i></button>
        </div>
        
        <div class="px-4 pb-2">
            <input id="searchInput" oninput="searchNexus()" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –∏ –≥—Ä—É–ø–ø..." class="w-full bg-slate-800 p-2 rounded-xl border border-slate-700 text-sm outline-none">
        </div>

        <div id="chats" class="flex-1 overflow-y-auto">
            <div onclick="switchRoom('general')" class="p-4 cursor-pointer hover:bg-slate-800 transition active-chat"># –û–±—â–∏–π —á–∞—Ç</div>
            <div id="search-results" class="hidden border-b border-slate-800 pb-2"></div>
            <div id="my-contacts" class="p-2 space-y-1"></div>
        </div>

        <div class="p-4 border-t border-slate-800 flex items-center gap-3">
            <img src="{{ user.avatar }}" class="w-10 h-10 rounded-full border-2 border-blue-500">
            <div class="flex-1 min-w-0">
                <p class="font-bold truncate">{{ user.display_name }}</p>
                <p class="text-[10px] text-blue-400">@{{ user.username }}</p>
            </div>
            <button onclick="toggleTheme()">üåì</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col">
        <header id="chat-header" class="h-16 border-b border-slate-800 flex items-center px-6 bg-slate-900/20 backdrop-blur-md">
            <h2 class="font-bold"># general</h2>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

        <footer class="p-4 border-t border-slate-800 glass">
            <div class="max-w-4xl mx-auto flex items-end gap-2">
                <input type="file" id="fileInp" class="hidden" onchange="uploadFile(this)">
                <button onclick="document.getElementById('fileInp').click()" class="p-3 text-slate-400"><i data-lucide="paperclip"></i></button>
                <textarea id="msgInput" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-slate-800 rounded-2xl p-3 outline-none resize-none"></textarea>
                <button onclick="recordCircle()" class="p-3 bg-slate-800 rounded-full"><i data-lucide="camera"></i></button>
                <button onclick="send()" class="p-3 bg-blue-600 rounded-full"><i data-lucide="send"></i></button>
            </div>
        </footer>
    </main>

    <script>
        lucide.createIcons();
        const socket = io();
        let currentRoom = "general";
        const myId = "{{ user._id }}";

        socket.emit('join_room', {room: currentRoom});

        async function searchNexus() {
            const q = document.getElementById('searchInput').value;
            if(q.length < 2) { document.getElementById('search-results').classList.add('hidden'); return; }
            const res = await fetch(`/api/search?q=${q}`);
            const data = await res.json();
            const box = document.getElementById('search-results');
            box.classList.remove('hidden');
            box.innerHTML = '<p class="text-[10px] px-4 py-1 opacity-50 uppercase">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</p>';
            
            data.users.forEach(u => {
                if(u._id === myId) return;
                box.innerHTML += `<div onclick="openDM('${u._id}', '${u.username}')" class="p-3 flex items-center gap-2 hover:bg-blue-600/20 cursor-pointer">
                    <img src="${u.avatar}" class="w-8 h-8 rounded-full"> @${u.username} (–õ–°)</div>`;
            });
            data.groups.forEach(g => {
                box.innerHTML += `<div onclick="switchRoom('${g._id}', '${g.title}')" class="p-3 flex items-center gap-2 hover:bg-slate-800 cursor-pointer">
                    <div class="w-8 h-8 bg-slate-700 rounded-lg flex items-center justify-center text-xs">#</div> ${g.title}</div>`;
            });
        }

        function openDM(targetId, name) {
            const room = [myId, targetId].sort().join("_");
            switchRoom(room, `@${name}`);
        }

        function switchRoom(room, title = "–û–±—â–∏–π —á–∞—Ç") {
            currentRoom = room;
            document.getElementById('chat-header').innerHTML = `<h2 class="font-bold">${title}</h2>`;
            document.getElementById('chat-window').innerHTML = '';
            socket.emit('join_room', {room: room});
        }

        async function createGroupPrompt() {
            const title = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:");
            if(!title) return;
            const res = await fetch('/api/groups/create', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({title: title})
            });
            const data = await res.json();
            switchRoom(data.id, title);
        }

        function send() {
            const inp = document.getElementById('msgInput');
            if(!inp.value) return;
            socket.emit('send_msg', { room: currentRoom, text: inp.value, type: 'text' });
            inp.value = '';
        }

        socket.on('new_message', (data) => {
            const win = document.getElementById('chat-window');
            const isMe = data.sender_id === myId;
            let content = `<p>${data.text}</p>`;
            if(data.type === 'video_circle') content = `<video src="${data.file_url}" class="video-note" controls></video>`;
            if(data.type === 'file') content = `<a href="${data.file_url}" download class="text-blue-400 underline">üìé –§–∞–π–ª: ${data.text}</a>`;

            const html = `
                <div id="msg-${data._id}" class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-in fade-in">
                    <div class="flex gap-2 max-w-[80%] group">
                        <div class="relative ${isMe ? 'bg-blue-600' : 'bg-slate-800'} p-3 rounded-2xl">
                            ${!isMe ? `<p class="text-[9px] font-bold text-blue-300">@${data.sender_name}</p>` : ''}
                            ${content}
                            <button onclick="deleteMsg('${data._id}')" class="absolute -top-2 -right-2 bg-red-500 rounded-full p-1 opacity-0 group-hover:opacity-100 transition">‚úï</button>
                        </div>
                    </div>
                </div>`;
            win.insertAdjacentHTML('beforeend', html);
            win.scrollTop = win.scrollHeight;
            lucide.createIcons();
        });

        function deleteMsg(id) { socket.emit('delete_msg', {msg_id: id}); }
        socket.on('msg_deleted', (id) => { document.getElementById(`msg-${id}`)?.remove(); });

        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
    </script>
</body>
</html>
