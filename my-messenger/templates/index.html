<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Nexus Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 3px solid #3b82f6; }
        .modal { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="flex h-screen bg-slate-950 text-white overflow-hidden font-sans">

    <aside class="w-80 border-r border-slate-800 flex flex-col bg-slate-900/40">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-xl font-black text-blue-500 italic">NEXUS</h1>
            <button onclick="createRoom()" class="bg-slate-800 p-2 rounded-lg hover:bg-slate-700 transition"><i data-lucide="plus-circle"></i></button>
        </div>
        
        <div class="px-4 pb-2">
            <input id="searchInput" oninput="runSearch()" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." class="w-full bg-slate-800 p-2 rounded-xl text-sm outline-none border border-slate-700 focus:border-blue-500 transition">
        </div>

        <div id="chats" class="flex-1 overflow-y-auto">
            <div onclick="switchRoom('general', '–û–±—â–∏–π —á–∞—Ç')" class="p-4 cursor-pointer hover:bg-slate-800 border-l-4 border-blue-500 bg-blue-500/10"># –û–±—â–∏–π —á–∞—Ç</div>
            <div id="search-results"></div>
        </div>

        <div class="p-4 border-t border-slate-800 flex items-center gap-3 cursor-pointer hover:bg-slate-800 transition" onclick="toggleModal('settings-modal')">
            <img src="{{ user.avatar }}" class="w-10 h-10 rounded-full border-2 border-blue-500 shadow-lg shadow-blue-500/20">
            <div class="flex-1 min-w-0">
                <p class="font-bold truncate text-sm">{{ user.display_name }}</p>
                <p class="text-[10px] text-blue-400 uppercase font-black">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/20 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <div id="room-icon" class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center font-bold">#</div>
                <h2 id="header-title" class="font-bold">–û–±—â–∏–π —á–∞—Ç</h2>
            </div>
            <div class="flex gap-4">
                <button onclick="toggleInfo()" class="text-slate-400 hover:text-white transition"><i data-lucide="info"></i></button>
            </div>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

        <footer class="p-4 border-t border-slate-800 bg-slate-900/40">
            <div class="max-w-4xl mx-auto flex items-end gap-2">
                <input type="file" id="fInp" class="hidden" onchange="uploadFile(this)">
                <button onclick="document.getElementById('fInp').click()" class="p-3 text-slate-400 hover:text-blue-500"><i data-lucide="paperclip"></i></button>
                <textarea id="msgInput" rows="1" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-slate-800 rounded-2xl p-3 outline-none resize-none focus:ring-1 ring-blue-500 transition"></textarea>
                <button onclick="recordCircle()" class="p-3 bg-slate-800 rounded-full text-red-400 hover:bg-red-500 hover:text-white transition"><i data-lucide="video"></i></button>
                <button onclick="send()" class="p-3 bg-blue-600 rounded-full hover:bg-blue-500 transition shadow-lg shadow-blue-500/30"><i data-lucide="send"></i></button>
            </div>
        </footer>

        <div id="info-panel" class="hidden absolute right-0 top-0 bottom-0 w-64 bg-slate-900 border-l border-slate-800 z-40 p-4 transform transition-transform shadow-2xl">
            <h3 class="font-bold mb-4 flex items-center gap-2 text-blue-400"><i data-lucide="users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
            <div id="members-list" class="space-y-3"></div>
        </div>
    </main>

    <div id="settings-modal" class="hidden fixed inset-0 modal flex items-center justify-center z-50 p-4">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-md rounded-3xl p-8 shadow-2xl">
            <h2 class="text-xl font-bold mb-6 text-blue-500 flex items-center gap-2"><i data-lucide="settings"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <div class="space-y-5">
                <div><label class="text-[10px] uppercase font-bold opacity-50 mb-1 block">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label>
                <input id="set-name" value="{{ user.display_name }}" class="w-full bg-slate-800 p-3 rounded-xl outline-none focus:ring-1 ring-blue-500"></div>
                
                <div><label class="text-[10px] uppercase font-bold opacity-50 mb-1 block">URL –ê–≤–∞—Ç–∞—Ä–∞</label>
                <input id="set-avatar" value="{{ user.avatar }}" class="w-full bg-slate-800 p-3 rounded-xl outline-none focus:ring-1 ring-blue-500"></div>
                
                <div><label class="text-[10px] uppercase font-bold opacity-50 mb-1 block">–û —Å–µ–±–µ (Bio)</label>
                <textarea id="set-bio" class="w-full bg-slate-800 p-3 rounded-xl outline-none focus:ring-1 ring-blue-500 h-24">{{ user.bio }}</textarea></div>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="saveProfile()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold hover:bg-blue-500 transition">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="toggleModal('settings-modal')" class="flex-1 bg-slate-800 py-3 rounded-xl font-bold hover:bg-slate-700 transition">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const socket = io();
        let currentRoom = "general";
        const myId = "{{ user._id }}";

        socket.emit('join_room', {room: currentRoom});

        function toggleModal(id) { document.getElementById(id).classList.toggle('hidden'); }

        async function saveProfile() {
            const data = {
                name: document.getElementById('set-name').value,
                bio: document.getElementById('set-bio').value,
                avatar: document.getElementById('set-avatar').value
            };
            await fetch('/api/profile/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            location.reload();
        }

        async function runSearch() {
            const q = document.getElementById('searchInput').value;
            const res = await fetch(`/api/search?q=${q}`);
            const data = await res.json();
            const box = document.getElementById('search-results');
            box.innerHTML = '';
            data.users.forEach(u => {
                if(u._id === myId) return;
                box.innerHTML += `<div onclick="openDM('${u._id}', '${u.username}')" class="p-3 flex items-center gap-2 hover:bg-slate-800 cursor-pointer transition">
                    <img src="${u.avatar}" class="w-8 h-8 rounded-full border border-blue-500">
                    <span class="text-sm font-bold">@${u.username}</span>
                </div>`;
            });
        }

        function openDM(targetId, name) {
            const room = [myId, targetId].sort().join("_");
            switchRoom(room, `@${name}`);
        }

        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('header-title').innerText = title;
            document.getElementById('chat-window').innerHTML = '';
            socket.emit('join_room', {room: id});
            document.getElementById('info-panel').classList.add('hidden');
        }

        async function toggleInfo() {
            const panel = document.getElementById('info-panel');
            panel.classList.toggle('hidden');
            if(!panel.classList.contains('hidden')) {
                const res = await fetch(`/api/room/${currentRoom}/members`);
                const members = await res.json();
                document.getElementById('members-list').innerHTML = members.map(m => `
                    <div class="flex items-center gap-3 p-2 bg-slate-800/30 rounded-xl">
                        <img src="${m.avatar}" class="w-8 h-8 rounded-full border border-blue-500">
                        <div class="min-w-0">
                            <p class="text-xs font-bold truncate">${m.display_name}</p>
                            <p class="text-[9px] opacity-50 uppercase font-black">Online</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        function send() {
            const inp = document.getElementById('msgInput');
            if(!inp.value.trim()) return;
            socket.emit('send_msg', { room: currentRoom, text: inp.value, type: 'text' });
            inp.value = '';
        }

        socket.on('new_message', (data) => {
            const win = document.getElementById('chat-window');
            const isMe = data.sender_id === myId;
            let content = `<p class="text-sm">${data.text}</p>`;
            
            if(data.type === 'video_circle') content = `<video src="${data.file_url}" class="video-note" controls autoplay loop muted></video>`;
            if(data.type === 'file') content = `<a href="${data.file_url}" download class="text-blue-400 underline text-xs">üìé –§–∞–π–ª: ${data.text}</a>`;

            win.insertAdjacentHTML('beforeend', `
                <div id="msg-${data._id}" class="flex ${isMe ? 'justify-end' : 'justify-start'} animate-in slide-in-from-bottom-2 duration-300">
                    <div class="relative group ${isMe ? 'bg-blue-600' : 'bg-slate-800'} p-3 rounded-2xl max-w-[75%] shadow-xl">
                        ${!isMe ? `<p class="text-[10px] font-black text-blue-300 mb-1 uppercase">@${data.sender_name}</p>` : ''}
                        ${content}
                        <button onclick="deleteMsg('${data._id}')" class="absolute -top-2 -right-2 bg-red-500 w-5 h-5 rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition">‚úï</button>
                    </div>
                </div>
            `);
            win.scrollTop = win.scrollHeight;
            lucide.createIcons();
        });

        function deleteMsg(id) { socket.emit('delete_msg', {msg_id: id}); }
        socket.on('msg_deleted', (id) => { document.getElementById(`msg-${id}`)?.remove(); });

        async function uploadFile(inp) {
            const file = inp.files[0];
            const formData = new FormData();
            formData.append('file', file);
            const res = await fetch('/api/upload', {method: 'POST', body: formData});
            const d = await res.json();
            socket.emit('send_msg', { room: currentRoom, type: 'file', file_url: d.url, text: file.name });
        }

        async function recordCircle() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const recorder = new MediaRecorder(stream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const formData = new FormData();
                formData.append('file', blob);
                const res = await fetch('/api/upload', {method: 'POST', body: formData});
                const d = await res.json();
                socket.emit('send_msg', { room: currentRoom, type: 'video_circle', file_url: d.url });
            };
            recorder.start();
            setTimeout(() => recorder.stop(), 7000);
        }
    </script>
</body>
</html>
