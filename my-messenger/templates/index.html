<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexus Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; border: 3px solid #3b82f6; object-fit: cover; }
        .recording { animation: pulse 1.5s infinite; color: #ef4444; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        .msg-bubble:hover .react-bar { display: flex; }
    </style>
</head>
<body class="bg-[#020617] text-slate-200 flex h-screen overflow-hidden">

    <aside class="w-80 border-r border-slate-800 flex flex-col bg-slate-900/40">
        <div class="p-4 flex justify-between items-center border-b border-slate-800/50">
            <h1 class="text-xl font-black text-blue-500 italic">NEXUS</h1>
            <button onclick="createGroup()" class="bg-blue-600 p-2 rounded-lg text-white"><i data-lucide="plus"></i></button>
        </div>
        <div id="chats-list" class="flex-1 overflow-y-auto p-2 space-y-1">
            <div onclick="switchRoom('general', '–û–±—â–∏–π —á–∞—Ç')" class="p-3 rounded-xl hover:bg-slate-800 cursor-pointer flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">#</div> <b>–û–±—â–∏–π —á–∞—Ç</b>
            </div>
            <div id="my-groups-list"></div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/20">
            <h2 id="header-title" class="font-bold text-lg">–û–±—â–∏–π —á–∞—Ç</h2>
            <div class="flex gap-4">
                <button id="call-btn" class="hidden text-green-500" onclick="startCall()"><i data-lucide="phone"></i></button>
                <button onclick="handleInfoClick()"><i data-lucide="info"></i></button>
            </div>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

        <footer class="p-4 bg-slate-900/50">
            <div class="max-w-4xl mx-auto flex items-end gap-2 bg-slate-900 p-2 rounded-2xl border border-slate-800">
                <button onclick="toggleStickers()" class="p-2"><i data-lucide="smile"></i></button>
                <textarea id="msgInput" rows="1" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); send();}" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-transparent p-2 outline-none resize-none"></textarea>
                
                <button id="recordBtn" 
                    onmousedown="startVoice()" 
                    onmouseup="stopVoice()" 
                    onclick="takeVideoCircle()" 
                    class="p-2 text-slate-400">
                    <i data-lucide="mic" id="mic-icon"></i>
                </button>
                
                <button onclick="send()" class="p-2 bg-blue-600 rounded-xl"><i data-lucide="send"></i></button>
            </div>
        </footer>

        <div id="info-panel" class="hidden absolute right-0 top-0 bottom-0 w-72 bg-slate-900 border-l border-slate-800 z-50 p-6">
            <div id="info-content"></div>
        </div>
        
        <div id="sticker-box" class="hidden absolute bottom-20 left-10 bg-slate-800 p-4 rounded-2xl grid grid-cols-4 gap-2 border border-slate-700">
            <button onclick="sendSticker('üî•')">üî•</button>
            <button onclick="sendSticker('üòÇ')">üòÇ</button>
            <button onclick="sendSticker('‚ù§Ô∏è')">‚ù§Ô∏è</button>
            <button onclick="sendSticker('‚ö°')">‚ö°</button>
        </div>
    </main>

    <script>
        lucide.createIcons();
        const socket = io();
        let currentRoom = 'general';
        const myId = "{{ user._id }}";
        let mediaRecorder;
        let audioChunks = [];

        // --- –ì–†–£–ü–ü–´ –ò –ß–ê–¢–´ ---
        async function loadChats() {
            const res = await fetch('/api/my_chats');
            const groups = await res.json();
            const list = document.getElementById('my-groups-list');
            list.innerHTML = groups.map(g => `
                <div onclick="switchRoom('${g._id}', '${g.title}')" class="p-3 rounded-xl hover:bg-slate-800 cursor-pointer flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-700 rounded-lg flex items-center justify-center font-bold">${g.title[0]}</div>
                    <span class="text-sm font-bold">${g.title}</span>
                </div>
            `).join('');
        }
        loadChats();

        async function createGroup() {
            const t = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:");
            if(!t) return;
            const res = await fetch('/api/groups/create', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({title:t})});
            const d = await res.json();
            loadChats();
            switchRoom(d.id, t);
        }

        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('header-title').innerText = title;
            document.getElementById('chat-window').innerHTML = '';
            document.getElementById('call-btn').classList.toggle('hidden', id.length === 24 || id === 'general');
            socket.emit('join_room', {room: id});
        }

        // --- –ó–ê–ü–ò–°–¨ (–ö–†–£–ñ–ö–ò –ò –ì–û–õ–û–°–û–í–´–ï) ---
        let holdTimer;
        function startVoice() {
            holdTimer = setTimeout(async () => {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/ogg' });
                    const fd = new FormData(); fd.append('file', blob);
                    const res = await fetch('/api/upload', {method:'POST', body:fd});
                    const d = await res.json();
                    socket.emit('send_msg', { room: currentRoom, type: 'voice', file_url: d.url });
                };
                mediaRecorder.start();
                document.getElementById('mic-icon').classList.add('recording');
            }, 300);
        }

        function stopVoice() {
            clearTimeout(holdTimer);
            if(mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('mic-icon').classList.remove('recording');
            }
        }

        async function takeVideoCircle() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const recorder = new MediaRecorder(stream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const fd = new FormData(); fd.append('file', blob);
                const res = await fetch('/api/upload', {method:'POST', body:fd});
                const d = await res.json();
                socket.emit('send_msg', { room: currentRoom, type: 'video_circle', file_url: d.url });
            };
            recorder.start();
            setTimeout(()=>recorder.stop(), 5000);
        }

        // --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –£–ß–ê–°–¢–ù–ò–ö–ê–ú–ò (–†–ê–ù–ì–ò) ---
        async function handleInfoClick() {
            const panel = document.getElementById('info-panel');
            panel.classList.toggle('hidden');
            if(panel.classList.contains('hidden')) return;
            
            const res = await fetch(`/api/room/${currentRoom}/members`);
            const members = await res.json();
            
            // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –í–ª–∞–¥–µ–ª—å—Ü–∞
            document.getElementById('info-content').innerHTML = `
                <h3 class="font-black text-xs uppercase text-blue-500 mb-4">–£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
                <div class="space-y-4">
                    ${members.map(m => `
                        <div class="flex items-center justify-between group cursor-pointer" onclick="manageMember('${m._id}', '${m.display_name}')">
                            <div class="flex items-center gap-2">
                                <img src="${m.avatar}" class="w-8 h-8 rounded-full">
                                <div>
                                    <p class="text-sm font-bold">${m.display_name}</p>
                                    <p class="text-[9px] text-blue-400 font-bold uppercase">–£—á–∞—Å—Ç–Ω–∏–∫</p>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        async function manageMember(tid, name) {
            if (currentRoom === 'general') return;
            const action = prompt(`–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ @${name}:\n1. –ù–∞–∑–Ω–∞—á–∏—Ç—å –∞–¥–º–∏–Ω–æ–º\n2. –ö–∏–∫–Ω—É—Ç—å\n3. –ú—É—Ç`);
            let act = '';
            if(action === '1') act = 'make_admin';
            if(action === '2') act = 'kick';
            if(action === '3') act = 'mute';
            if(act) {
                await fetch('/api/group/manage', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({room_id:currentRoom, target_id:tid, action:act})});
                alert("–ì–æ—Ç–æ–≤–æ");
            }
        }

        // --- –°–û–û–ë–©–ï–ù–ò–Ø, –†–ï–ê–ö–¶–ò–ò, –°–¢–ò–ö–ï–†–´ ---
        function send() {
            const inp = document.getElementById('msgInput');
            if(!inp.value.trim()) return;
            socket.emit('send_msg', { room: currentRoom, text: inp.value });
            inp.value = '';
        }

        function sendSticker(s) {
            socket.emit('send_msg', { room: currentRoom, text: s, type: 'sticker' });
            document.getElementById('sticker-box').classList.add('hidden');
        }

        function toggleStickers() { document.getElementById('sticker-box').classList.toggle('hidden'); }

        socket.on('new_message', (data) => {
            const win = document.getElementById('chat-window');
            const isMe = data.sender_id === myId;
            let content = `<p>${data.text}</p>`;
            
            if(data.type === 'video_circle') content = `<video src="${data.file_url}" class="video-note" controls></video>`;
            if(data.type === 'voice') content = `<audio src="${data.file_url}" controls class="w-full"></audio>`;
            if(data.type === 'sticker') content = `<span class="text-6xl">${data.text}</span>`;

            win.insertAdjacentHTML('beforeend', `
                <div id="msg-${data._id}" class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="relative group msg-bubble ${isMe ? 'bg-blue-600' : 'bg-slate-800'} p-3 rounded-2xl max-w-[70%]">
                        ${content}
                        <div class="react-bar hidden absolute -top-8 left-0 bg-slate-700 p-1 rounded-full gap-2 text-xs">
                            <button onclick="addReact('${data._id}', '‚ù§Ô∏è')">‚ù§Ô∏è</button>
                            <button onclick="addReact('${data._id}', 'üòÇ')">üòÇ</button>
                            <button onclick="addReact('${data._id}', 'üî•')">üî•</button>
                        </div>
                    </div>
                </div>`);
            win.scrollTop = win.scrollHeight;
        });

        function addReact(mid, emoji) { socket.emit('add_reaction', {room: currentRoom, msg_id: mid, emoji: emoji}); }

        function startCall() { alert("–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç (WebRTC –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)"); }
    </script>
</body>
</html>
