<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiteGram Ultra Pro</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surf: #17212b; --prim: #2481cc; --text: #fff; --msg: #182533; --border: #000; }
        .light-theme { --bg: #f0f2f5; --surf: #ffffff; --prim: #0088cc; --text: #000; --msg: #ffffff; --border: #ddd; }
        
        * { box-sizing: border-box; transition: background 0.2s; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* –°–µ—Ç–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
        #sidebar { width: 320px; background: var(--surf); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        #right-bar { width: 280px; background: var(--surf); border-left: 1px solid var(--border); display: none; flex-direction: column; }

        /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
        @media (max-width: 768px) {
            #sidebar { width: 100%; position: absolute; z-index: 100; }
            #sidebar.hidden { display: none; }
            #right-bar { width: 100%; position: absolute; z-index: 200; }
        }

        .header { padding: 10px 15px; background: var(--surf); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; min-height: 60px; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; cursor: pointer; background: #333; }
        
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 85%; padding: 10px; border-radius: 15px; background: var(--msg); border: 1px solid var(--border); position: relative; }
        .my { align-self: flex-end; background: var(--prim); color: #fff; }

        .btn { padding: 8px 12px; border-radius: 20px; border: none; background: var(--prim); color: white; cursor: pointer; font-weight: bold; }
        .rec-active { background: #ff4757 !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* –í–∏–¥–µ–æ-—Å–æ–æ–±—â–µ–Ω–∏—è */
        .video-circle { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid var(--prim); }
        #v-preview { position: absolute; bottom: 80px; right: 20px; width: 120px; height: 120px; border-radius: 50%; border: 3px solid #ff4757; display: none; transform: scaleX(-1); object-fit: cover; background: #000; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–≤–æ–Ω–∫–∞ */
        #call-ui { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 5000; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body class="dark-theme">

    <div id="call-ui">
        <h2 id="call-msg">–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤...</h2>
        <div style="display:flex; gap:20px; margin-top:20px;">
            <button class="btn" style="background:#27ae60; padding:15px 30px;" onclick="answer()">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
            <button class="btn" style="background:#ff4757; padding:15px 30px;" onclick="endCall()">–°–±—Ä–æ—Å–∏—Ç—å</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="header">
            <img id="my-av" class="avatar" onclick="openProfile()">
            <b id="my-name">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
        </div>
        <div id="chats-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="chat-area">
        <video id="v-preview" autoplay muted></video>
        <div class="header">
            <button onclick="toggleSidebar(false)" id="back-btn" class="btn" style="display:none">‚Üê</button>
            <b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
            <div style="display:flex; gap:8px;">
                <button class="btn" style="background:#27ae60" onclick="startCall()">üìû</button>
                <button id="members-btn" class="btn" onclick="toggleRight()">üë§</button>
            </div>
        </div>
        <div id="messages"></div>
        <div class="header" style="gap:10px;">
            <button id="v-btn" class="btn" onclick="toggleVideo()">üì∑</button>
            <input id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
            <button id="a-btn" class="btn" onclick="toggleAudio()">üé§</button>
            <button class="btn" onclick="send()">‚û§</button>
        </div>
    </div>

    <div id="right-bar">
        <div class="header"><b>–£—á–∞—Å—Ç–Ω–∏–∫–∏</b> <button onclick="toggleRight()" class="btn">√ó</button></div>
        <div id="members-list" style="padding:15px;"></div>
    </div>

    <div id="modal-prof" style="position:fixed; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center; z-index:3000;">
        <div style="background:var(--surf); padding:20px; border-radius:20px; width:300px; text-align:center;">
            <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
            <div class="btn" onclick="toggleTheme()" style="margin-bottom:10px;">üåì –°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</div>
            <button class="btn" onclick="document.getElementById('modal-prof').style.display='none'" style="width:100%">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = 'global', mediaRec, chunks = [], isRec = false;

        // –í—Ö–æ–¥ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
        const nick = prompt("–í–∞—à –Ω–∏–∫?") || 'user'+Math.floor(Math.random()*1000);
        socket.emit('login_attempt', {nick: nick, pass: '123'});

        socket.on('login_success', u => {
            me = u;
            document.getElementById('my-name').innerText = u.name;
            document.getElementById('my-av').src = u.avatar || 'https://via.placeholder.com/40';
            socket.emit('get_my_rooms', {nick: me.nick});
            switchRoom('global', 'üåç –û–±—â–∏–π —á–∞—Ç');
        });

        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('chat-title').innerText = title;
            document.getElementById('messages').innerHTML = '';
            
            // –°–ö–†–´–¢–ò–ï –ö–ù–û–ü–ö–ò –£–ß–ê–°–¢–ù–ò–ö–û–í –í –õ–°
            const mBtn = document.getElementById('members-btn');
            mBtn.style.display = id.includes('_ls_') ? 'none' : 'block';
            
            socket.emit('join', {room: id});
            if(window.innerWidth < 768) toggleSidebar(true);
        }

        // –û–¢–ü–†–ê–í–ö–ê
        function send(media = null, type = 'text') {
            const i = document.getElementById('msg-in');
            if(i.value.trim() || media) {
                const data = { room: currentRoom, nick: me.nick, user: me.name };
                if(type === 'voice') data.voice = media;
                else if(type === 'video') data.video = media;
                else data.text = i.value;
                socket.emit('message', data);
                i.value = '';
            }
        }

        // –ó–ê–ü–ò–°–¨ –í–ò–î–ï–û –ò –ê–£–î–ò–û
        async function startMedia(video) {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: video });
            if(video) { 
                const v = document.getElementById('v-preview');
                v.srcObject = stream; v.style.display = 'block';
            }
            mediaRec = new MediaRecorder(stream);
            chunks = [];
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.onstop = () => {
                const blob = new Blob(chunks, { type: video ? 'video/webm' : 'audio/webm' });
                const r = new FileReader(); r.readAsDataURL(blob);
                r.onloadend = () => send(r.result, video ? 'video' : 'voice');
                stream.getTracks().forEach(t => t.stop());
                document.getElementById('v-preview').style.display = 'none';
            };
            mediaRec.start();
            isRec = true;
        }

        function toggleVideo() {
            if(!isRec) { startMedia(true); document.getElementById('v-btn').classList.add('rec-active'); }
            else { mediaRec.stop(); isRec = false; document.getElementById('v-btn').classList.remove('rec-active'); }
        }

        function toggleAudio() {
            if(!isRec) { startMedia(false); document.getElementById('a-btn').classList.add('rec-active'); }
            else { mediaRec.stop(); isRec = false; document.getElementById('a-btn').classList.remove('rec-active'); }
        }

        // –†–ï–ù–î–ï–†
        socket.on('render_message', d => { if(d.room === currentRoom) addMsg(d); });
        socket.on('history', h => h.forEach(addMsg));

        function addMsg(d) {
            const b = document.getElementById('messages');
            let html = `<div>${d.text}</div>`;
            if(d.voice) html = `<audio controls src="${d.voice}"></audio>`;
            if(d.video) html = `<video class="video-circle" src="${d.video}" autoplay loop muted onclick="this.muted=!this.muted"></video>`;
            
            b.insertAdjacentHTML('beforeend', `
                <div class="msg ${d.nick===me.nick?'my':''}" id="m-${d.id}">
                    <small><b>${d.user}</b> <span onclick="delMsg('${d.id}')" style="cursor:pointer">üóë</span></small>
                    ${html}
                    <div style="font-size:12px; cursor:pointer" onclick="react('${d.id}','‚ù§Ô∏è')">‚ù§Ô∏è ${Object.values(d.reactions||{}).filter(x=>x==='‚ù§Ô∏è').length || ''}</div>
                </div>`);
            b.scrollTop = b.scrollHeight;
        }

        // –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø
        function delMsg(id) { socket.emit('delete_msg', {id: id, nick: me.nick}); }
        socket.on('msg_deleted', id => document.getElementById('m-'+id)?.remove());

        function startCall() {
            socket.emit('call_signal', { to_room: currentRoom, from: me.name });
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-msg').innerText = "–í—ã–∑–æ–≤...";
        }
        socket.on('incoming_call', d => {
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('call-msg').innerText = "–ó–≤–æ–Ω–æ–∫ –æ—Ç " + d.from;
        });
        function endCall() { document.getElementById('call-ui').style.display = 'none'; }
        
        function toggleTheme() { document.body.classList.toggle('light-theme'); }
        function openProfile() { document.getElementById('modal-prof').style.display = 'flex'; }
        function toggleSidebar(hide) { 
            document.getElementById('sidebar').classList.toggle('hidden', hide); 
            document.getElementById('back-btn').style.display = hide ? 'block' : 'none';
        }
        function toggleRight() { 
            const rb = document.getElementById('right-bar');
            rb.style.display = rb.style.display === 'flex' ? 'none' : 'flex';
        }

        socket.on('load_rooms', rs => {
            const l = document.getElementById('chats-list');
            l.innerHTML = '<div class="header"><b>–ß–∞—Ç—ã</b></div>';
            rs.forEach(r => {
                l.insertAdjacentHTML('beforeend', `<div style="padding:15px; border-bottom:1px solid var(--border); cursor:pointer" onclick="switchRoom('${r.id}','${r.name}')">üë• ${r.name}</div>`);
            });
        });
    </script>
</body>
</html>
