<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nexus Ultimate Messenger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --bg: #0f111a; --panel: #1a1d29; --text: #ffffff; --accent: #7289da;
            --msg-in: #2b2e3f; --msg-out: #3e4d8c; --mute-bg: rgba(0,0,0,0.8);
        }
        .light-theme {
            --bg: #f0f2f5; --panel: #ffffff; --text: #1c1e21; --accent: #0084ff;
            --msg-in: #e4e6eb; --msg-out: #0084ff; --text-out: #fff;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; transition: 0.3s; }

        /* --- Layout --- */
        .app-container { display: flex; height: 100vh; }
        .sidebar { width: 350px; background: var(--panel); border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; }
        .chat-area { flex: 1; display: flex; flex-direction: column; position: relative; }

        /* --- Header & Search --- */
        .header { padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .search-box { padding: 10px; }
        .search-box input { width: 100%; padding: 10px; border-radius: 8px; border: none; background: var(--bg); color: var(--text); }

        /* --- Chat List --- */
        #chat-list { flex: 1; overflow-y: auto; }
        .chat-item { padding: 15px; display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); transition: 0.2s; }
        .chat-item:hover { background: rgba(255,255,255,0.05); }
        .chat-item img { width: 50px; height: 50px; border-radius: 50%; margin-right: 15px; object-fit: cover; }
        .chat-info { flex: 1; }
        .chat-info h4 { font-size: 16px; margin-bottom: 4px; }
        .chat-info p { font-size: 13px; opacity: 0.6; }

        /* --- Messages Area --- */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 70%; padding: 10px 15px; border-radius: 15px; position: relative; word-wrap: break-word; }
        .msg.in { align-self: flex-start; background: var(--msg-in); border-bottom-left-radius: 2px; }
        .msg.out { align-self: flex-end; background: var(--msg-out); border-bottom-right-radius: 2px; color: var(--text-out); }
        .msg-time { font-size: 10px; opacity: 0.5; display: block; text-align: right; margin-top: 5px; }
        .delete-btn { position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 18px; height: 18px; cursor: pointer; font-size: 10px; display: none; }
        .msg:hover .delete-btn { display: block; }

        /* --- Input Area --- */
        .input-box { padding: 15px; background: var(--panel); display: flex; align-items: center; gap: 10px; }
        .input-box input { flex: 1; padding: 12px; border-radius: 20px; border: none; background: var(--bg); color: var(--text); }
        .mute-overlay { position: absolute; bottom: 0; width: 100%; height: 60px; background: var(--mute-bg); display: none; justify-content: center; align-items: center; color: #ff4d4d; font-weight: bold; z-index: 10; }

        /* --- Modals & Overlays --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-content { background: var(--panel); padding: 30px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; }
        
        /* --- Calling UI --- */
        #call-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        #call-overlay img { width: 120px; height: 120px; border-radius: 50%; margin-bottom: 20px; border: 3px solid var(--accent); }
        .call-btns { display: flex; gap: 40px; margin-top: 30px; }
        .btn-call { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; color: white; }
        .accept { background: #4caf50; }
        .reject { background: #f44336; }

        /* --- Adaptive --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; position: absolute; left: 0; top: 0; z-index: 50; }
            .sidebar.hidden { display: none; }
            .chat-area { width: 100%; }
        }

        .typing-status { font-size: 12px; color: var(--accent); height: 15px; margin-bottom: 5px; }
    </style>
</head>
<body class="{{ user.theme }}-theme">

    <div class="app-container">
        <div class="sidebar" id="sidebar">
            <div class="header">
                <img src="{{ user.av }}" id="my-avatar" style="width:40px; height:40px; border-radius:50%; cursor:pointer;" onclick="toggleProfile()">
                <h3>Nexus</h3>
                <i class="fas fa-plus-circle" style="cursor:pointer;" onclick="showCreateGroup()"></i>
            </div>
            <div class="search-box">
                <input type="text" id="global-search" placeholder="–ü–æ–∏—Å–∫ @—é–∑–µ—Ä–æ–≤ –∏–ª–∏ –≥—Ä—É–ø–ø..." oninput="realtimeSearch()">
            </div>
            <div id="chat-list">
                </div>
        </div>

        <div class="chat-area">
            <div class="header">
                <div style="display:flex; align-items:center;">
                    <i class="fas fa-arrow-left" id="back-btn" style="margin-right:15px; display:none;" onclick="closeChat()"></i>
                    <div id="chat-header-info">
                        <h4 id="current-chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h4>
                        <p id="current-chat-status" style="font-size:12px; opacity:0.6;"></p>
                    </div>
                </div>
                <div class="call-icons" style="display:none;" id="top-call-btns">
                    <i class="fas fa-phone" onclick="initCall('audio')"></i>
                    <i class="fas fa-video" style="margin-left:15px;" onclick="initCall('video')"></i>
                </div>
            </div>

            <div id="messages"></div>

            <div class="typing-status" id="typing-indicator"></div>

            <div class="mute-overlay" id="mute-alert">–í–´ –í –ú–£–¢–ï</div>
            
            <div class="input-box" id="input-container" style="display:none;">
                <i class="fas fa-paperclip" onclick="triggerUpload()"></i>
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <i class="fas fa-microphone" id="voice-btn"></i>
                <i class="fas fa-paper-plane" onclick="sendMsg()"></i>
            </div>
        </div>
    </div>

    <div id="call-overlay">
        <img id="call-av" src="">
        <h2 id="call-name">–ó–≤–æ–Ω–æ–∫...</h2>
        <div class="call-btns">
            <button class="btn-call accept" onclick="answerCall()"><i class="fas fa-phone"></i></button>
            <button class="btn-call reject" onclick="stopCall()"><i class="fas fa-phone-slash"></i></button>
        </div>
        <audio id="ringtone" src="/static/ringtone.mp3" loop></audio>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <h3>–ü—Ä–æ—Ñ–∏–ª—å</h3>
            <img id="p-av" src="{{ user.av }}" style="width:100px; height:100px; border-radius:50%; margin: 15px 0;">
            <input type="text" id="p-name" value="{{ user.name }}" class="search-box input">
            <textarea id="p-bio" class="search-box input">{{ user.bio }}</textarea>
            <p>ID: @{{ user.username }}</p>
            <button onclick="changeTheme()">–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É</button>
            <button onclick="saveProfile()" style="background:var(--accent); color:white; border:none; padding:10px 20px; border-radius:5px; margin-top:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button onclick="closeModals()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <input type="file" id="file-input" style="display:none;" onchange="uploadFile(this)">

    <script>
        const socket = io();
        const myId = "{{ user._id }}";
        let currentRoom = null;
        let isGroup = false;

        // --- Core Functions ---
        async function loadChats() {
            const res = await fetch('/api/groups');
            const groups = await res.json();
            const list = document.getElementById('chat-list');
            list.innerHTML = '';
            groups.forEach(g => {
                const item = document.createElement('div');
                item.className = 'chat-item';
                item.onclick = () => selectChat(g._id, g.title, true, g.member_details.length);
                item.innerHTML = `
                    <img src="/static/group.png">
                    <div class="chat-info">
                        <h4>${g.title}</h4>
                        <p>${g.member_details.length} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function selectChat(id, title, isG, mCount) {
            currentRoom = id;
            isGroup = isG;
            document.getElementById('current-chat-title').innerText = title;
            document.getElementById('current-chat-status').innerText = isG ? `${mCount} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤` : '–≤ —Å–µ—Ç–∏';
            document.getElementById('input-container').style.display = 'flex';
            document.getElementById('top-call-btns').style.display = 'block';
            document.getElementById('messages').innerHTML = '';
            
            socket.emit('join', { room: id });
            loadHistory(id);

            if (window.innerWidth < 768) {
                document.getElementById('sidebar').classList.add('hidden');
                document.getElementById('back-btn').style.display = 'block';
            }
        }

        async function loadHistory(rid) {
            const res = await fetch(`/api/history/${rid}`);
            const msgs = await res.json();
            msgs.forEach(m => renderMsg(m));
        }

        function renderMsg(m) {
            const container = document.getElementById('messages');
            const div = document.createElement('div');
            div.className = `msg ${m.sid === myId ? 'out' : 'in'}`;
            div.id = `msg-${m._id}`;
            
            let content = `<small>${m.name}</small><br>${m.txt}`;
            if (m.type === 'file') content += `<br><a href="${m.url}" target="_blank" style="color:cyan">üìé –§–∞–π–ª</a>`;
            
            div.innerHTML = `
                ${content}
                <span class="msg-time">${new Date(m.ts).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                <button class="delete-btn" onclick="deleteMsg('${m._id}')">‚úï</button>
            `;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // --- Socket Handlers ---
        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if (!inp.value.trim()) return;
            socket.emit('msg', { room: currentRoom, txt: inp.value, type: 'text' });
            inp.value = '';
        }

        socket.on('new_msg', m => {
            if (m.room === currentRoom) renderMsg(m);
            new Audio('/static/msg.mp3').play().catch(()=>{});
        });

        // –°—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∞–µ—Ç
        let typingTimeout;
        document.getElementById('msg-input').oninput = () => {
            socket.emit('typing', { room: currentRoom, st: true, is_g: isGroup });
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                socket.emit('typing', { room: currentRoom, st: false, is_g: isGroup });
            }, 2000);
        };

        socket.on('typing_ev', d => {
            if (d.room === currentRoom) {
                const el = document.getElementById('typing-indicator');
                el.innerText = d.st ? (d.is_g ? `${d.name} –ø–µ—á–∞—Ç–∞–µ—Ç...` : '–ø–µ—á–∞—Ç–∞–µ—Ç...') : '';
            }
        });

        // --- –ó–≤–æ–Ω–∫–∏ ---
        function initCall(type) {
            socket.emit('call_init', { room: currentRoom, type: type });
            showCallUI('–í—ã–∑–æ–≤...', '/static/default.png');
        }

        socket.on('incoming_call', d => {
            if (d.room === currentRoom) {
                showCallUI(d.from, d.av);
                document.getElementById('ringtone').play();
            }
        });

        function showCallUI(name, av) {
            const overlay = document.getElementById('call-overlay');
            overlay.style.display = 'flex';
            document.getElementById('call-name').innerText = name;
            document.getElementById('call-av').src = av;
        }

        function stopCall() {
            document.getElementById('call-overlay').style.display = 'none';
            document.getElementById('ringtone').pause();
        }

        // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
        window.onload = () => {
            loadChats();
            // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            if (Notification.permission !== "granted") Notification.requestPermission();
        };

        function closeChat() {
            document.getElementById('sidebar').classList.remove('hidden');
            document.getElementById('back-btn').style.display = 'none';
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ–º—ã
        function changeTheme() {
            const body = document.body;
            const newTheme = body.classList.contains('dark-theme') ? 'light' : 'dark';
            body.className = `${newTheme}-theme`;
            fetch('/api/profile/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ theme: newTheme })
            });
        }
    </script>
</body>
</html>
