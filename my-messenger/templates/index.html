<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Nexus Messenger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 3px solid #3b82f6; }
        .modal-bg { background: rgba(2, 6, 23, 0.9); backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-slate-950 text-white flex h-screen overflow-hidden">

    <aside class="w-80 border-r border-slate-800 flex flex-col bg-slate-900/40">
        <div class="p-4 flex justify-between items-center text-blue-500 font-black text-xl italic">NEXUS</div>
        <div class="px-4 pb-4"><input id="searchInp" oninput="runSearch()" placeholder="–ü–æ–∏—Å–∫..." class="w-full bg-slate-800 p-2 rounded-xl text-sm outline-none border border-slate-700"></div>
        <div id="chats" class="flex-1 overflow-y-auto">
            <div onclick="switchRoom('general', '–û–±—â–∏–π —á–∞—Ç')" class="p-4 cursor-pointer hover:bg-slate-800 border-l-4 border-blue-500 bg-blue-500/10"># –û–±—â–∏–π —á–∞—Ç</div>
            <div id="search-results"></div>
        </div>
        <div class="p-4 border-t border-slate-800 flex items-center gap-3 cursor-pointer hover:bg-slate-800" onclick="openSettings()">
            <img src="{{ user.avatar }}" id="my-avatar-side" class="w-10 h-10 rounded-full border-2 border-blue-500">
            <div class="flex-1 min-w-0">
                <p class="font-bold truncate text-sm">{{ user.display_name }}</p>
                <p class="text-[10px] text-blue-400 font-bold uppercase">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/20">
            <h2 id="header-title" class="font-bold">–û–±—â–∏–π —á–∞—Ç</h2>
            <button onclick="handleInfoClick()" class="text-slate-400 hover:text-white"><i data-lucide="info"></i></button>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

        <footer class="p-4 border-t border-slate-800">
            <div class="max-w-4xl mx-auto flex items-end gap-2">
                <input type="file" id="fInp" class="hidden" onchange="uploadFile(this, 'msg')">
                <button onclick="document.getElementById('fInp').click()" class="p-3 text-slate-400"><i data-lucide="paperclip"></i></button>
                <textarea id="msgInput" rows="1" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-slate-800 rounded-2xl p-3 outline-none resize-none"></textarea>
                <button onclick="recordCircle()" class="p-3 bg-slate-800 rounded-full text-red-500"><i data-lucide="video"></i></button>
                <button onclick="send()" class="p-3 bg-blue-600 rounded-full"><i data-lucide="send"></i></button>
            </div>
        </footer>

        <div id="info-panel" class="hidden absolute right-0 top-0 bottom-0 w-72 bg-slate-900 border-l border-slate-800 z-50 p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 id="info-type" class="font-bold text-blue-500 uppercase text-xs">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                <button onclick="closeInfo()"><i data-lucide="x" class="w-4"></i></button>
            </div>
            <div id="info-content" class="space-y-4"></div>
        </div>
    </main>

    <div id="settings-modal" class="hidden fixed inset-0 modal-bg flex items-center justify-center z-[100]">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-sm rounded-3xl p-6">
            <h2 class="text-xl font-bold mb-6 text-blue-500 text-center">–ü—Ä–æ—Ñ–∏–ª—å</h2>
            <div class="flex flex-col items-center mb-6 group relative">
                <img id="preview-avatar" src="{{ user.avatar }}" class="w-24 h-24 rounded-full border-4 border-blue-600 object-cover mb-2">
                <input type="file" id="avatarFile" class="hidden" onchange="uploadFile(this, 'avatar')">
                <button onclick="document.getElementById('avatarFile').click()" class="text-[10px] text-blue-400 underline">–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ</button>
            </div>
            <div class="space-y-4">
                <input id="set-name" value="{{ user.display_name }}" placeholder="–ò–º—è" class="w-full bg-slate-800 p-3 rounded-xl outline-none border border-slate-700">
                <textarea id="set-bio" placeholder="–û —Å–µ–±–µ" class="w-full bg-slate-800 p-3 rounded-xl outline-none border border-slate-700 h-20">{{ user.bio }}</textarea>
                <div class="flex gap-2">
                    <button onclick="saveProfile()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">–ì–æ—Ç–æ–≤–æ</button>
                    <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="flex-1 bg-slate-800 py-3 rounded-xl">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        const socket = io();
        let currentRoom = "general";
        let lastUploadedAvatar = null;
        const myId = "{{ user._id }}";

        socket.emit('join_room', {room: currentRoom});

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeInfo() { document.getElementById('info-panel').classList.add('hidden'); }

        // --- –£–ú–ù–ê–Ø –ö–ù–û–ü–ö–ê (i) ---
        async function handleInfoClick() {
            const panel = document.getElementById('info-panel');
            const content = document.getElementById('info-content');
            const typeHeader = document.getElementById('info-type');
            panel.classList.toggle('hidden');
            if(panel.classList.contains('hidden')) return;

            if (currentRoom === 'general' || currentRoom.length === 24) {
                // –ì—Ä—É–ø–ø–æ–≤–æ–π —á–∞—Ç -> –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
                typeHeader.innerText = "–£—á–∞—Å—Ç–Ω–∏–∫–∏";
                const res = await fetch(`/api/room/${currentRoom}/members`);
                const members = await res.json();
                content.innerHTML = members.map(m => `
                    <div class="flex items-center gap-3 p-2 bg-slate-800/50 rounded-xl">
                        <img src="${m.avatar}" class="w-8 h-8 rounded-full border border-blue-500">
                        <p class="text-sm font-bold truncate">${m.display_name}</p>
                    </div>`).join('');
            } else if (currentRoom.includes('_')) {
                // –õ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è -> –ö–∞—Ä—Ç–æ—á–∫–∞ —á–µ–ª–æ–≤–µ–∫–∞
                typeHeader.innerText = "–ü—Ä–æ—Ñ–∏–ª—å —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞";
                const otherId = currentRoom.split('_').find(id => id !== myId);
                const res = await fetch(`/api/user/${otherId}`);
                const u = await res.json();
                content.innerHTML = `
                    <div class="flex flex-col items-center text-center">
                        <img src="${u.avatar}" class="w-32 h-32 rounded-3xl border-4 border-blue-600 mb-4 shadow-xl">
                        <h4 class="text-xl font-black">${u.display_name}</h4>
                        <p class="text-blue-400 text-sm mb-4">@${u.username}</p>
                        <div class="bg-slate-800 p-4 rounded-2xl w-full text-sm italic text-slate-300">"${u.bio}"</div>
                    </div>`;
            }
        }

        // --- –ó–ê–ì–†–£–ó–ö–ê –§–ê–ô–õ–û–í –ò –ê–í–ê–¢–ê–†–ê ---
        async function uploadFile(inp, mode) {
            if(!inp.files[0]) return;
            const formData = new FormData();
            formData.append('file', inp.files[0]);
            const res = await fetch('/api/upload', {method: 'POST', body: formData});
            const d = await res.json();
            
            if(mode === 'avatar') {
                lastUploadedAvatar = d.url;
                document.getElementById('preview-avatar').src = d.url;
            } else {
                socket.emit('send_msg', { room: currentRoom, type: 'file', file_url: d.url, text: inp.files[0].name });
            }
        }

        async function saveProfile() {
            const data = {
                name: document.getElementById('set-name').value,
                bio: document.getElementById('set-bio').value,
                avatar: lastUploadedAvatar // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–ª–∏ –Ω–æ–≤–æ–µ
            };
            await fetch('/api/profile/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            location.reload();
        }

        // --- –ü–û–ò–°–ö –ò –õ–° ---
        async function runSearch() {
            const q = document.getElementById('searchInp').value;
            if(!q) { document.getElementById('search-res').classList.add('hidden'); return; }
            const res = await fetch(`/api/search?q=${q}`);
            const data = await res.json();
            const box = document.getElementById('search-results');
            box.innerHTML = '';
            data.users.forEach(u => {
                if(u._id === myId) return;
                box.innerHTML += `<div onclick="openDM('${u._id}', '${u.username}')" class="p-3 flex items-center gap-2 hover:bg-slate-800 cursor-pointer">
                    <img src="${u.avatar}" class="w-8 h-8 rounded-full border border-blue-500"> @${u.username}</div>`;
            });
        }

        function openDM(id, name) {
            const room = [myId, id].sort().join("_");
            switchRoom(room, `@${name}`);
        }

        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('header-title').innerText = title;
            document.getElementById('chat-window').innerHTML = '';
            socket.emit('join_room', {room: id});
            closeInfo();
        }

        function send() {
            const inp = document.getElementById('msgInput');
            if(!inp.value.trim()) return;
            socket.emit('send_msg', { room: currentRoom, text: inp.value });
            inp.value = '';
        }

        socket.on('new_message', (data) => {
            const win = document.getElementById('chat-window');
            const isMe = data.sender_id === myId;
            let content = `<p>${data.text}</p>`;
            if(data.type === 'video_circle') content = `<video src="${data.file_url}" class="video-note" controls></video>`;
            if(data.type === 'file') content = `<a href="${data.file_url}" download class="text-blue-400 underline">üìé ${data.text}</a>`;

            win.insertAdjacentHTML('beforeend', `
                <div id="msg-${data._id}" class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="relative group ${isMe ? 'bg-blue-600 shadow-blue-500/20' : 'bg-slate-800 shadow-black/50'} p-3 rounded-2xl max-w-[70%] shadow-lg">
                        ${!isMe ? `<p class="text-[9px] font-bold text-blue-300 uppercase mb-1">@${data.sender_name}</p>` : ''}
                        ${content}
                        <button onclick="deleteMsg('${data._id}')" class="absolute -top-2 -right-2 bg-red-500 w-5 h-5 rounded-full text-[10px] opacity-0 group-hover:opacity-100 transition">‚úï</button>
                    </div>
                </div>`);
            win.scrollTop = win.scrollHeight;
        });

        function deleteMsg(id) { socket.emit('delete_msg', {msg_id: id}); }
        socket.on('msg_deleted', (id) => { document.getElementById(`msg-${id}`)?.remove(); });

        async function recordCircle() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const recorder = new MediaRecorder(stream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const formData = new FormData();
                formData.append('file', blob);
                const res = await fetch('/api/upload', {method: 'POST', body: formData});
                const d = await res.json();
                socket.emit('send_msg', { room: currentRoom, type: 'video_circle', file_url: d.url });
            };
            recorder.start();
            setTimeout(() => recorder.stop(), 7000);
        }
    </script>
</body>
</html>
