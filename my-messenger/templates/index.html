<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Ultra</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --text: #ffffff; --primary: #2481cc; --gray: #808b99; --online: #4ade80; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-ui { background: var(--surface); border: 1px solid var(--gray); color: var(--text); padding: 12px; border-radius: 8px; margin: 8px; width: 280px; }
        #sidebar { width: 300px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat-window { flex: 1; display: flex; flex-direction: column; background: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .header { background: var(--surface); padding: 10px 15px; border-bottom: 1px solid #000; display: flex; align-items: center; gap: 10px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { background: var(--surface); padding: 10px; border-radius: 15px; max-width: 70%; position: relative; }
        .video-msg { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; background: var(--gray); }
        .status-dot.online { background: var(--online); }
        .controls { background: var(--surface); padding: 15px; display: flex; gap: 10px; align-items: center; }
        .rec-btn { cursor: pointer; font-size: 20px; background: none; border: none; color: var(--gray); }
        .rec-active { color: #ff4d4d; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        #video-preview { position: fixed; bottom: 80px; right: 20px; width: 150px; border-radius: 50%; display: none; transform: scaleX(-1); }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color: var(--primary)">LiteGram</h1>
        <input type="text" id="r-name" class="input-ui" placeholder="–ò–º—è">
        <input type="text" id="r-user" class="input-ui" placeholder="@username">
        <input type="password" id="r-pass" class="input-ui" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" style="background: var(--primary); color: white; border: none; padding: 12px 100px; border-radius: 8px;">–í–û–ô–¢–ò</button>
    </div>

    <div id="main-container" style="display:none; width: 100%;">
        <div id="sidebar">
            <div class="header"><input type="text" id="user-search" placeholder="–ü–æ–∏—Å–∫ @—é–∑–µ—Ä–∞..." style="flex:1; background:var(--bg); color:white; border:none; padding:8px; border-radius:5px;"><button onclick="searchUser()">üîç</button></div>
            <div id="list-items" style="flex:1; overflow-y:auto;"></div>
        </div>
        <div id="chat-window">
            <div class="header">
                <div id="chat-info">
                    <b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b><br>
                    <small id="user-status" style="color:var(--gray)"></small>
                </div>
            </div>
            <div id="messages"></div>
            <video id="video-preview" autoplay muted></video>
            <div class="controls">
                <label style="cursor:pointer; font-size:20px;">üìé<input type="file" style="display:none" onchange="uploadFile(this)"></label>
                <button id="voice-btn" class="rec-btn" onmousedown="startRec('audio')" onmouseup="stopRec()">üé§</button>
                <button id="video-btn" class="rec-btn" onmousedown="startRec('video')" onmouseup="stopRec()">üì∑</button>
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:var(--bg); color:white; border:none; padding:10px; border-radius:8px;">
                <button onclick="send()" style="color:var(--primary); background:none; border:none; font-size:24px;">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = "–û–±—â–∏–π —á–∞—Ç", chatList = ["–û–±—â–∏–π —á–∞—Ç"], mediaRec, chunks = [];

        function login() {
            const name = document.getElementById('r-name').value;
            const nick = document.getElementById('r-user').value.replace('@','').toLowerCase();
            const pass = document.getElementById('r-pass').value;
            if(name && nick && pass) socket.emit('login_attempt', { name, nick, pass });
        }

        socket.on('login_success', (u) => {
            me = u; document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'flex';
            switchRoom(currentRoom); setInterval(() => socket.emit('update_status', {nick: me.nick}), 5000);
        });

        function switchRoom(n) {
            currentRoom = n; document.getElementById('chat-title').innerText = n;
            document.getElementById('messages').innerHTML = ""; socket.emit('join', {room: n, nick: me.nick});
            if(!chatList.includes(n)) chatList.push(n); renderList();
        }

        function renderList() {
            document.getElementById('list-items').innerHTML = chatList.map(r => `<div class="chat-item" onclick="switchRoom('${r}')" style="padding:15px; cursor:pointer; border-bottom:1px solid #000;">${r}</div>`).join('');
        }

        // –ó–ê–ü–ò–°–¨ –ì–û–õ–û–°–û–í–´–• –ò –í–ò–î–ï–û
        async function startRec(type) {
            chunks = [];
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: type === 'video' });
            if(type === 'video') { 
                const preview = document.getElementById('video-preview');
                preview.srcObject = stream; preview.style.display = 'block';
            }
            mediaRec = new MediaRecorder(stream);
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.onstop = () => {
                const blob = new Blob(chunks, { type: type === 'video' ? 'video/webm' : 'audio/webm' });
                const reader = new FileReader();
                reader.onload = () => socket.emit('message', {
                    user: me.name, nick: '@'+me.nick, room: currentRoom,
                    file: reader.result, file_type: blob.type
                });
                reader.readAsDataURL(blob);
                stream.getTracks().forEach(t => t.stop());
                document.getElementById('video-preview').style.display = 'none';
            };
            mediaRec.start();
            document.getElementById(type+'-btn').classList.add('rec-active');
        }

        function stopRec() {
            mediaRec.stop();
            document.querySelectorAll('.rec-btn').forEach(b => b.classList.remove('rec-active'));
        }

        function addMsg(d) {
            const m = document.getElementById('messages');
            const isMy = d.nick === '@' + me.nick;
            let content = `<span>${d.text || ''}</span>`;
            if(d.file) {
                if(d.file_type.includes('video')) content = `<video src="${d.file}" class="video-msg" controls></video>`;
                else if(d.file_type.includes('audio')) content = `<audio src="${d.file}" controls style="width:200px"></audio>`;
                else if(d.file_type.includes('image')) content = `<img src="${d.file}" style="max-width:250px; border-radius:10px;">`;
            }
            m.insertAdjacentHTML('beforeend', `<div class="msg" style="${isMy ? 'align-self:flex-end; background:var(--primary)' : ''}"><b>${d.user}</b><br>${content}</div>`);
            m.scrollTop = m.scrollHeight;
        }

        socket.on('render_message', addMsg);
        socket.on('history', msgs => msgs.forEach(addMsg));

        socket.on('status_updated', d => {
            if(currentRoom.includes(d.nick)) {
                const isOnline = (Date.now()/1000 - d.last_seen) < 15;
                document.getElementById('user-status').innerText = isOnline ? "–≤ —Å–µ—Ç–∏" : "–±—ã–ª(–∞) –Ω–µ–¥–∞–≤–Ω–æ";
                document.getElementById('user-status').style.color = isOnline ? "var(--online)" : "var(--gray)";
            }
        });

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value) { socket.emit('message', {user: me.name, nick: '@'+me.nick, text: i.value, room: currentRoom}); i.value = ''; }
        }

        function searchUser() {
            const q = document.getElementById('user-search').value;
            socket.emit('search_user', {query: q});
        }
        socket.on('user_found', u => switchRoom([me.nick, u.nick].sort().join('_')));
    </script>
</body>
</html>
