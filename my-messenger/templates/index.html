<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Pro</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --primary: #2481cc; --text: #fff; --online: #4ade80; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-ui { background: var(--surface); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin: 5px; width: 280px; outline: none; }

        #sidebar { width: 320px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat { flex: 1; display: flex; flex-direction: column; background: #080e15; position: relative; }
        
        .header { padding: 15px; background: var(--surface); border-bottom: 1px solid #000; display: flex; align-items: center; justify-content: space-between; }
        .chat-item { display: flex; align-items: center; padding: 12px; cursor: pointer; border-bottom: 1px solid #121b25; position: relative; }
        .chat-item:hover, .chat-item.active { background: #2b5278; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { display: flex; gap: 10px; max-width: 80%; position: relative; margin-bottom: 5px; }
        .my-msg { align-self: flex-end; flex-direction: row-reverse; }
        .msg-content { background: var(--surface); padding: 10px; border-radius: 12px; position: relative; }
        .my-msg .msg-content { background: var(--primary); }

        .tools { position: absolute; top: -20px; right: 0; display: none; gap: 5px; background: #222; padding: 4px; border-radius: 5px; }
        .msg:hover .tools { display: flex; }
        .badge { background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 10px; font-size: 11px; cursor: pointer; margin-top: 5px; display: inline-block; }

        /* –í–∏–¥–µ–æ—á–∞—Ç */
        #call-ui { position: absolute; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 45%; border-radius: 10px; background: #222; box-shadow: 0 0 20px #000; }
        .call-controls { margin-top: 20px; display: flex; gap: 15px; }

        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:var(--primary)">LiteGram Pro</h1>
        <input type="text" id="r-name" class="input-ui" placeholder="–ò–º—è">
        <input type="text" id="r-user" class="input-ui" placeholder="@username">
        <input type="password" id="r-pass" class="input-ui" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" style="background:var(--primary); color:white; border:none; padding:12px 100px; border-radius:8px; cursor:pointer;">–í–û–ô–¢–ò</button>
    </div>

    <div id="call-ui">
        <div style="display:flex; gap:20px; width:90%; justify-content:center;">
            <video id="localVid" autoplay muted playsinline></video>
            <video id="remoteVid" autoplay playsinline></video>
        </div>
        <div class="call-controls">
            <button onclick="toggleMic()" id="mic-btn" class="input-ui" style="width:auto;">üé§ –ú–∏–∫—Ä–æ: –í–ö–õ</button>
            <button onclick="toggleCam()" id="cam-btn" class="input-ui" style="width:auto;">üì∑ –ö–∞–º–µ—Ä–∞: –í–ö–õ</button>
            <button onclick="endCall()" class="input-ui" style="width:auto; background:#e53935;">‚ùå –°–±—Ä–æ—Å</button>
        </div>
    </div>

    <div id="sidebar" style="display:none">
        <div class="header">
            <img id="my-avatar" class="avatar" onclick="changeAv()" title="–°–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ">
            <b id="my-name-display"></b>
        </div>
        <div style="padding:10px;">
            <input type="text" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –∏–ª–∏ –≥—Ä—É–ø–ø..." oninput="search(this.value)" style="width:100%; background:#0f161e; border:1px solid #333; color:white; padding:10px; border-radius:8px; box-sizing:border-box;">
        </div>
        <div style="display:flex; gap:5px; padding:0 10px 10px;">
            <button onclick="createNew('group')" class="input-ui" style="width:50%; font-size:12px;">+ –ì—Ä—É–ø–ø–∞</button>
            <button onclick="createNew('channel')" class="input-ui" style="width:50%; font-size:12px;">+ –ö–∞–Ω–∞–ª</button>
        </div>
        <div id="chats-list" style="overflow-y:auto; flex:1;">
            <div class="chat-item active" id="item-global" onclick="switchRoom('global')">
                <div style="width:40px; height:40px; background:var(--primary); border-radius:50%; display:flex; align-items:center; justify-content:center;">üåê</div>
                <div style="margin-left:12px;"><b>–û–±—â–∏–π —á–∞—Ç</b></div>
            </div>
        </div>
    </div>

    <div id="chat" style="display:none">
        <div class="header">
            <div id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div id="header-ops"></div>
        </div>
        <div id="messages"></div>
        <div class="header" style="border-top:1px solid #000; gap:10px;">
            <button id="voice-btn" style="background:none; border:none; font-size:24px; cursor:pointer;">üé§</button>
            <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:#0f161e; border:none; color:white; padding:12px; border-radius:10px;" onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" style="background:none; border:none; color:var(--primary); font-size:24px; cursor:pointer;">‚û§</button>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = "global", roomsData = {}, mediaRecorder, audioChunks = [], localStream;
        let micOn = true, camOn = true;

        window.onload = () => {
            const saved = localStorage.getItem('litegram_user');
            if(saved) { me = JSON.parse(saved); enterApp(me); }
        };

        function login() {
            const n = document.getElementById('r-name').value, u = document.getElementById('r-user').value.toLowerCase(), p = document.getElementById('r-pass').value;
            if(n && u && p) socket.emit('login_attempt', {name:n, nick:u, pass:p});
        }

        socket.on('login_success', u => { me = u; localStorage.setItem('litegram_user', JSON.stringify(u)); enterApp(u); });

        function enterApp(u) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('sidebar').style.display = 'flex';
            document.getElementById('chat').style.display = 'flex';
            document.getElementById('my-avatar').src = u.avatar || 'https://www.w3schools.com/howto/img_avatar.png';
            document.getElementById('my-name-display').innerText = u.name;
            socket.emit('get_my_rooms');
            switchRoom('global');
        }

        function search(q) {
            if(q.length > 1) socket.emit('search', {query: q});
            else socket.emit('get_my_rooms');
        }

        socket.on('search_results', d => {
            document.getElementById('chats-list').innerHTML = '';
            d.users.forEach(u => {
                if(u.nick !== me.nick) renderSearchItem(u.nick, `@${u.nick}`, 'ls');
            });
            d.rooms.forEach(r => renderRoom(r));
        });

        function renderSearchItem(id, name, type) {
            const html = `<div class="chat-item" onclick="openLS('${id}')">
                <div style="width:40px; height:40px; background:#444; border-radius:50%; display:flex; align-items:center; justify-content:center;">üë§</div>
                <div style="margin-left:12px;"><b>${name}</b></div></div>`;
            document.getElementById('chats-list').insertAdjacentHTML('beforeend', html);
        }

        function openLS(targetNick) {
            const id = [me.nick, targetNick].sort().join('_ls_');
            switchRoom(id, `@${targetNick}`, 'ls');
        }

        function switchRoom(id, title = null, type = 'group') {
            currentRoom = id;
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chat-title').innerText = title || id;
            socket.emit('join', {room: id});
            
            // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Ç–æ–º
            const room = roomsData[id];
            let ops = `<button onclick="startCall()" class="btn">üé• –ó–≤–æ–Ω–æ–∫</button>`;
            if (room && room.creator === me.nick) {
                ops += `<button onclick="deleteFullRoom('${id}')" style="color:red; margin-left:10px;">üóë –£–¥–∞–ª–∏—Ç—å —á–∞—Ç</button>`;
            }
            document.getElementById('header-ops').innerHTML = ops;
        }

        socket.on('load_rooms', rs => { rs.forEach(r => { roomsData[r.id] = r; renderRoom(r); }); });
        socket.on('room_created', r => { roomsData[r.id] = r; renderRoom(r); });

        function renderRoom(r) {
            if(document.getElementById('item-'+r.id)) return;
            const html = `<div class="chat-item" id="item-${r.id}" onclick="switchRoom('${r.id}','${r.name}','${r.type}')">
                <div style="width:40px; height:40px; background:#444; border-radius:50%; display:flex; align-items:center; justify-content:center;">${r.type==='group'?'üë•':'üì¢'}</div>
                <div style="margin-left:12px;"><b>${r.name}</b></div></div>`;
            document.getElementById('chats-list').insertAdjacentHTML('beforeend', html);
        }

        function createNew(type) {
            const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ:");
            if(n) {
                const id = n.toLowerCase().replace(/ /g, '_');
                socket.emit('create_room', {name: n, type: type, id: id, creator: me.nick});
            }
        }

        function deleteFullRoom(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —á–∞—Ç –Ω–∞–≤—Å–µ–≥–¥–∞ –¥–ª—è –≤—Å–µ—Ö?")) socket.emit('delete_room_global', {room: id, nick: me.nick});
        }
        socket.on('room_deleted_event', id => { if(currentRoom === id) switchRoom('global'); document.getElementById('item-'+id)?.remove(); });

        function send() {
            const i = document.getElementById('msg-input');
            const room = roomsData[currentRoom];
            if(room && room.type === 'channel' && !room.admins.includes(me.nick)) return alert("–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω –ø–∏—à–µ—Ç –≤ –∫–∞–Ω–∞–ª–µ!");
            if(i.value.trim()) {
                socket.emit('message', {user: me.name, nick: '@'+me.nick, text: i.value, room: currentRoom, type: 'text'});
                i.value = '';
            }
        }

        socket.on('render_message', d => { if(d.room === currentRoom) addMsg(d); });
        socket.on('history', ms => ms.forEach(addMsg));

        function addMsg(d) {
            const m = document.getElementById('messages'), isMy = d.nick === '@' + me.nick;
            const html = `
                <div class="msg ${isMy ? 'my-msg' : ''}" id="msg-${d._id}">
                    <div class="msg-content">
                        <div class="tools">
                            <span onclick="react('${d._id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            ${isMy ? `<span onclick="delMsg('${d._id}')">üóë</span>` : ''}
                        </div>
                        <b style="font-size:10px; opacity:0.5">${d.user}</b><br>
                        ${d.type==='audio' ? `<audio src="${d.audio}" controls style="height:30px;"></audio>` : d.text}
                        <div id="re-${d._id}"></div>
                    </div>
                </div>`;
            m.insertAdjacentHTML('beforeend', html);
            if(d.reactions) updateReactUI(d._id, d.reactions);
            m.scrollTop = m.scrollHeight;
        }

        function react(id, e) { socket.emit('add_reaction', {msg_id: id, emoji: e, nick: me.nick, room: currentRoom}); }
        socket.on('update_reactions', d => updateReactUI(d.msg_id, d.reactions));
        function updateReactUI(id, rs) {
            const c = document.getElementById('re-'+id); if(!c) return;
            c.innerHTML = Object.entries(rs).map(([e, u]) => `<span class="badge ${u.includes(me.nick)?'active':''}" onclick="react('${id}','${e}')">${e} ${u.length}</span>`).join('');
        }

        function delMsg(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) socket.emit('delete_msg', {msg_id: id, room: currentRoom, nick: me.nick}); }
        socket.on('msg_deleted_confirm', d => document.getElementById('msg-'+d.msg_id)?.remove());

        // –ì–æ–ª–æ—Å–æ–≤—ã–µ (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤)
        const vBtn = document.getElementById('voice-btn');
        vBtn.onmousedown = async () => {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(s); audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => socket.emit('message', {user:me.name, nick:'@'+me.nick, audio:reader.result, room:currentRoom, type:'audio'});
            };
            mediaRecorder.start(); vBtn.style.color = 'red';
        };
        vBtn.onmouseup = () => { if(mediaRecorder) mediaRecorder.stop(); vBtn.style.color = 'white'; };

        // –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫
        async function startCall() {
            document.getElementById('call-ui').style.display = 'flex';
            localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('localVid').srcObject = localStream;
        }
        function toggleMic() { micOn = !micOn; localStream.getAudioTracks()[0].enabled = micOn; document.getElementById('mic-btn').innerText = micOn ? "üé§ –ú–∏–∫—Ä–æ: –í–ö–õ" : "üîá –ú–∏–∫—Ä–æ: –í–´–ö–õ"; }
        function toggleCam() { camOn = !camOn; localStream.getVideoTracks()[0].enabled = camOn; document.getElementById('cam-btn').innerText = camOn ? "üì∑ –ö–∞–º–µ—Ä–∞: –í–ö–õ" : "üö´ –ö–∞–º–µ—Ä–∞: –í–´–ö–õ"; }
        function endCall() { localStream.getTracks().forEach(t => t.stop()); document.getElementById('call-ui').style.display = 'none'; }

        function changeAv() {
            const url = prompt("–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ:");
            if(url) { socket.emit('update_avatar', {nick: me.nick, avatar: url}); document.getElementById('my-avatar').src = url; }
        }
    </script>
</body>
</html>
