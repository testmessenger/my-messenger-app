<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Pro</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surf: #17212b; --prim: #2481cc; --text: #fff; --msg: #182533; }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* –ü–∞–Ω–µ–ª–∏ */
        #sidebar { width: 300px; background: var(--surf); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat { flex: 1; display: flex; flex-direction: column; background: #080e15; }
        #members-bar { width: 250px; background: var(--surf); border-left: 1px solid #000; display: none; flex-direction: column; }

        .header { padding: 15px; background: var(--surf); border-bottom: 1px solid #000; display: flex; align-items: center; justify-content: space-between; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; background: var(--msg); position: relative; }
        .my { align-self: flex-end; background: var(--prim); }
        
        /* –†–ê–ù–ì–ò */
        .rank { font-size: 9px; padding: 2px 5px; border-radius: 4px; margin-left: 5px; text-transform: uppercase; font-weight: bold; }
        .rank-–∞–¥–º–∏–Ω { background: #ff4757; color: white; }
        .rank-–º–æ–¥–µ—Ä–∞—Ç–æ—Ä { background: #ffa502; color: white; }
        .rank-—É—á–∞—Å—Ç–Ω–∏–∫ { background: #2f3542; color: #ccc; }

        .chat-item, .member-item { padding: 12px; cursor: pointer; border-bottom: 1px solid #121b25; display: flex; align-items: center; gap: 10px; }
        .chat-item:hover, .member-item:hover { background: #2b5278; }

        #auth { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #0f161e; color: white; }
    </style>
</head>
<body>

    <div id="auth">
        <div style="background: var(--surf); padding: 30px; border-radius: 20px; width: 320px; text-align: center;">
            <h2 style="color:var(--prim)">LiteGram</h2>
            <input id="login-nick" placeholder="@username">
            <input id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="doLogin()" style="width:100%; padding:12px; background:var(--prim); color:white; border:none; border-radius:8px; cursor:pointer;">–í–û–ô–¢–ò</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="header">
            <div style="display:flex; align-items:center; gap:10px;">
                <img id="my-av" class="avatar" src="">
                <b id="my-name">...</b>
            </div>
        </div>
        <div id="chats-list" style="flex:1; overflow-y:auto;"></div>
        <button onclick="createRoom()" style="margin:10px; padding:10px; background:#2c3b4a; border:none; color:white; border-radius:5px; cursor:pointer;">+ –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</button>
    </div>

    <div id="chat">
        <div class="header">
            <b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
            <button onclick="toggleMembers()" style="background:none; border:none; color:var(--prim); cursor:pointer;">üë§ –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
        </div>
        <div id="messages"></div>
        <div class="header" style="gap:10px;">
            <input id="msg-input" placeholder="–ù–∞–ø–∏—Å–∞—Ç—å..." onkeypress="if(event.key==='Enter') send()">
            <button onclick="send()" style="border:none; background:none; color:var(--prim); font-size:24px; cursor:pointer;">‚û§</button>
        </div>
    </div>

    <div id="members-bar">
        <div class="header"><b>–£—á–∞—Å—Ç–Ω–∏–∫–∏</b></div>
        <div id="members-list"></div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = null;

        function doLogin() {
            const u = document.getElementById('login-nick').value;
            const p = document.getElementById('login-pass').value;
            if(u && p) socket.emit('login_attempt', {nick: u, pass: p});
        }

        socket.on('login_success', u => {
            me = u;
            document.getElementById('auth').style.display = 'none';
            document.getElementById('my-name').innerHTML = `${u.name} <span class="rank rank-${u.rank.toLowerCase()}">${u.rank}</span>`;
            socket.emit('get_rooms');
            switchRoom('global', '–û–±—â–∏–π —á–∞—Ç');
        });

        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('chat-title').innerText = title;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join', {room: id});
            socket.emit('get_members', {room: id});
        }

        socket.on('load_rooms', rs => {
            const l = document.getElementById('chats-list');
            l.innerHTML = '<div class="chat-item" onclick="switchRoom(\'global\',\'–û–±—â–∏–π —á–∞—Ç\')">üë• –û–±—â–∏–π —á–∞—Ç</div>';
            rs.forEach(r => l.insertAdjacentHTML('beforeend', `<div class="chat-item" onclick="switchRoom('${r.id}','${r.name}')">üë• ${r.name}</div>`));
        });

        socket.on('members_list', ms => {
            const l = document.getElementById('members-list');
            l.innerHTML = '';
            ms.forEach(m => {
                l.insertAdjacentHTML('beforeend', `
                    <div class="member-item">
                        <img class="avatar" style="width:30px; height:30px;" src="${m.avatar || 'https://via.placeholder.com/30'}">
                        <div>
                            <div style="font-size:13px; font-weight:bold;">${m.name}</div>
                            <span class="rank rank-${m.rank.toLowerCase()}">${m.rank}</span>
                        </div>
                    </div>
                `);
            });
        });

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value.trim()) {
                socket.emit('message', {room: currentRoom, text: i.value, nick: me.nick, user: me.name});
                i.value = '';
            }
        }

        socket.on('render_message', d => { if(d.room === currentRoom) addMsg(d); });
        socket.on('history', h => h.forEach(addMsg));

        function addMsg(d) {
            const b = document.getElementById('messages');
            const rClass = (d.rank || '–£—á–∞—Å—Ç–Ω–∏–∫').toLowerCase();
            b.insertAdjacentHTML('beforeend', `
                <div class="msg ${d.nick===me.nick?'my':''}">
                    <b style="font-size:11px;">${d.user} <span class="rank rank-${rClass}">${d.rank || '–£—á–∞—Å—Ç–Ω–∏–∫'}</span></b>
                    <div>${d.text}</div>
                </div>
            `);
            b.scrollTop = b.scrollHeight;
        }

        function toggleMembers() {
            const bar = document.getElementById('members-bar');
            bar.style.display = (bar.style.display === 'flex') ? 'none' : 'flex';
        }

        function createRoom() {
            const n = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã:");
            if(n) socket.emit('create_room', {id: 'r'+Date.now(), name: n});
        }
    </script>
</body>
</html>
