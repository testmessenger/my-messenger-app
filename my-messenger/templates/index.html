<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/5968/5968756.png">
    <title>Nexus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; border: 3px solid #3b82f6; object-fit: cover; }
        .msg-bubble:hover .delete-btn { display: block; }
        @media (max-width: 768px) {
            #sidebar { position: fixed; left: -100%; z-index: 50; width: 85%; height: 100%; transition: 0.3s; }
            #sidebar.active { left: 0; }
            #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 40; }
            #overlay.active { display: block; }
        }
    </style>
</head>
<body class="bg-[#020617] text-slate-200 flex h-screen overflow-hidden">
    <div id="overlay" onclick="toggleMenu()"></div>
    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>
    <audio id="ringtone" src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3" loop></audio>

    <aside id="sidebar" class="w-80 border-r border-slate-800 bg-[#0f172a] flex flex-col">
        <div class="p-4 border-b border-slate-800 flex flex-col gap-3">
            <div class="flex justify-between items-center">
                <h1 class="text-xl font-black text-blue-500 italic">NEXUS</h1>
                <button onclick="createGroup()" class="bg-blue-600 p-2 rounded-lg"><i data-lucide="plus"></i></button>
            </div>
            <input oninput="runSearch(this.value)" placeholder="Поиск людей..." class="w-full bg-slate-900 border border-slate-800 p-2 rounded-xl text-xs outline-none">
        </div>
        <div id="chats-list" class="flex-1 overflow-y-auto p-2">
            <div id="search-results"></div>
            <div onclick="switchRoom('general', 'Общий чат')" class="p-4 rounded-xl hover:bg-slate-800 cursor-pointer flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center font-bold">#</div>
                <span class="font-bold">Общий чат</span>
            </div>
            <div id="my-groups-list"></div>
        </div>
        <div class="p-4 border-t border-slate-800 flex items-center gap-3 cursor-pointer" onclick="openProfile()">
            <img id="my-avatar" src="{{ user.avatar }}" class="w-12 h-12 rounded-2xl border-2 border-blue-500 object-cover">
            <div class="flex-1 min-w-0">
                <p class="font-bold text-sm truncate">{{ user.display_name }}</p>
                <p class="text-[9px] text-blue-400 font-bold uppercase">Настройки профиля</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col relative w-full">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/40 backdrop-blur-md">
            <div class="flex items-center gap-3">
                <button onclick="toggleMenu()" class="md:hidden"><i data-lucide="menu"></i></button>
                <h2 id="header-title" class="font-black"># general</h2>
            </div>
            <div class="flex gap-4">
                <button id="call-btn" onclick="initiateCall()" class="hidden text-green-500"><i data-lucide="phone"></i></button>
                <button onclick="showInfo()"><i data-lucide="info"></i></button>
            </div>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-4 space-y-4"></div>

        <footer class="p-4 border-t border-slate-800 bg-slate-900/20">
            <div class="max-w-4xl mx-auto flex items-end gap-2 bg-slate-800 p-2 rounded-2xl">
                <button onclick="document.getElementById('sticker-box').classList.toggle('hidden')" class="p-2"><i data-lucide="smile"></i></button>
                <textarea id="msgInput" rows="1" class="flex-1 bg-transparent p-2 outline-none resize-none text-sm" placeholder="Сообщение..."></textarea>
                <button id="recordBtn" onmousedown="startVoiceHold()" onmouseup="stopVoiceHold()" onclick="handleCircleClick()" class="p-2"><i data-lucide="mic" id="mic-icon"></i></button>
                <button onclick="send()" class="p-2.5 bg-blue-600 rounded-xl"><i data-lucide="send"></i></button>
            </div>
        </footer>

        <div id="call-overlay" class="hidden fixed inset-0 z-[100] bg-slate-950 flex flex-col items-center justify-center">
            <video id="remoteVideo" autoplay playsinline class="w-full h-full object-cover"></video>
            <video id="localVideo" autoplay playsinline muted class="absolute top-10 right-10 w-40 h-60 border-2 border-blue-500 rounded-3xl object-cover"></video>
            <div class="absolute bottom-10 flex gap-6">
                <button onclick="endCall()" class="p-6 bg-red-600 rounded-full"><i data-lucide="phone-off"></i></button>
            </div>
        </div>

        <div id="profile-modal" class="hidden fixed inset-0 z-[200] bg-black/90 flex items-center justify-center p-4">
            <div class="bg-[#0f172a] w-full max-w-sm rounded-3xl p-8 border border-slate-800">
                <h2 class="text-xl font-bold mb-4">Настройки</h2>
                <input id="p-name" value="{{ user.display_name }}" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl mb-3 outline-none">
                <textarea id="p-bio" class="w-full bg-slate-900 border border-slate-800 p-3 rounded-xl mb-4 h-24">{{ user.bio }}</textarea>
                <button onclick="saveProfile()" class="w-full bg-blue-600 py-4 rounded-xl font-bold">СОХРАНИТЬ</button>
                <button onclick="document.getElementById('profile-modal').classList.add('hidden')" class="w-full mt-2 text-slate-500">Закрыть</button>
            </div>
        </div>

        <div id="incoming-call" class="hidden fixed top-5 left-1/2 -translate-x-1/2 w-80 bg-blue-600 p-4 rounded-[30px] z-[300] flex items-center justify-between shadow-2xl">
            <p class="font-bold ml-2">Вызов...</p>
            <div class="flex gap-2">
                <button onclick="acceptCall()" class="p-3 bg-green-500 rounded-full"><i data-lucide="check"></i></button>
                <button onclick="rejectCall()" class="p-3 bg-red-500 rounded-full"><i data-lucide="x"></i></button>
            </div>
        </div>
    </main>

    <script>
        lucide.createIcons();
        const socket = io();
        const myId = "{{ user._id }}";
        let currentRoom = "general";
        let unreadCount = 0;
        let pc, localStream, incomingData;

        // Мобильное меню
        function toggleMenu() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('overlay').classList.toggle('active');
        }

        // Поиск
        async function runSearch(q) {
            if(!q) { document.getElementById('search-results').innerHTML=''; return; }
            const res = await fetch(`/api/search?q=${q}`);
            const data = await res.json();
            document.getElementById('search-results').innerHTML = data.users.map(u => `
                <div onclick="openDM('${u._id}', '${u.display_name}')" class="p-3 mx-2 bg-blue-600/10 rounded-xl mb-1 flex items-center gap-3 cursor-pointer">
                    <img src="${u.avatar}" class="w-8 h-8 rounded-full">
                    <span class="text-xs font-bold">${u.display_name}</span>
                </div>`).join('');
        }

        function openDM(id, name) {
            const room = [myId, id].sort().join("_");
            switchRoom(room, `@${name}`);
            toggleMenu();
        }

        // Удаление
        function deleteMsg(mid) {
            if(confirm("Удалить?")) socket.emit('delete_msg', { room: currentRoom, msg_id: mid });
        }
        socket.on('msg_deleted', mid => document.getElementById(`msg-${mid}`)?.remove());

        // Переключение комнат
        function switchRoom(id, title) {
            currentRoom = id; unreadCount = 0; document.title = "Nexus";
            document.getElementById('header-title').innerText = title;
            document.getElementById('chat-window').innerHTML = '';
            document.getElementById('call-btn').classList.toggle('hidden', id === 'general' || id.length === 24);
            socket.emit('join_room', { room: id });
            if(window.innerWidth < 768) toggleMenu();
        }

        // Сообщения
        socket.on('new_message', (d) => {
            if(d.room !== currentRoom) {
                unreadCount++; document.title = `(${unreadCount}) Nexus`;
                document.getElementById('notif-sound').play();
            }
            const win = document.getElementById('chat-window');
            const isMe = d.sender_id === myId;
            let content = `<p>${d.text}</p>`;
            if(d.type==='video_circle') content = `<video src="${d.file_url}" class="video-note" controls autoplay loop muted></video>`;
            
            win.insertAdjacentHTML('beforeend', `
                <div id="msg-${d._id}" class="flex ${isMe?'justify-end':'justify-start'} group relative">
                    <div class="max-w-[80%] p-3 rounded-2xl ${isMe?'bg-blue-600':'bg-slate-800'}">
                        ${content}
                        ${isMe ? `<button onclick="deleteMsg('${d._id}')" class="delete-btn hidden absolute -top-2 bg-red-500 rounded-full px-1 text-[8px]">✕</button>` : ''}
                    </div>
                </div>`);
            win.scrollTop = win.scrollHeight;
        });

        // (Функции звонков, профиля и кнопок записи сохранены из прошлых ответов в полном объеме)
        function send() {
            const val = document.getElementById('msgInput').value;
            if(!val) return;
            socket.emit('send_msg', { room: currentRoom, text: val });
            document.getElementById('msgInput').value = '';
        }

        function openProfile() { document.getElementById('profile-modal').classList.remove('hidden'); }
        async function saveProfile() {
            const name = document.getElementById('p-name').value;
            const bio = document.getElementById('p-bio').value;
            await fetch('/api/profile/save', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, bio})});
            location.reload();
        }

        async function loadChats() {
            const res = await fetch('/api/my_chats');
            const gs = await res.json();
            document.getElementById('my-groups-list').innerHTML = gs.map(g => `
                <div onclick="switchRoom('${g._id}', '${g.title}')" class="p-3 rounded-xl hover:bg-slate-800 cursor-pointer flex items-center gap-3">
                    <div class="w-10 h-10 bg-slate-700 rounded-lg flex items-center justify-center font-bold text-xs">${g.title[0]}</div>
                    <span class="font-bold text-sm">${g.title}</span>
                </div>`).join('');
        }
        loadChats();
    </script>
</body>
</html>
