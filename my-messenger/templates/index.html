<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Ultra Elite</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --primary: #2481cc; --text: #fff; --online: #4ade80; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; margin: 0; overflow: hidden; }
        
        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .input-ui { background: var(--surface); border: 1px solid #333; color: white; padding: 12px; border-radius: 8px; margin: 5px; width: 280px; outline: none; }

        /* –°–µ—Ç–∫–∞ –≤–∏–¥–µ–æ –∑–≤–æ–Ω–∫–∞ */
        #video-grid { position: fixed; inset: 0; background: #000; z-index: 5000; display: none; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; padding: 20px; }
        .video-container { position: relative; background: #222; border-radius: 15px; overflow: hidden; aspect-ratio: 16/9; }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        .video-label { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6); padding: 4px 10px; border-radius: 4px; font-size: 12px; }
        
        .call-controls { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: none; gap: 20px; z-index: 5001; }
        .call-btn { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        #main-ui { display: flex; height: 100vh; }
        #sidebar { width: 300px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat { flex: 1; display: flex; flex-direction: column; background: #080e15; position: relative; }
        
        .header { padding: 15px; background: var(--surface); border-bottom: 1px solid #000; display: flex; align-items: center; gap: 15px; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        
        .msg { display: flex; gap: 10px; max-width: 80%; position: relative; }
        .msg-content { background: var(--surface); padding: 10px; border-radius: 12px; position: relative; min-width: 60px; }
        .my-msg { align-self: flex-end; flex-direction: row-reverse; }
        .my-msg .msg-content { background: var(--primary); }

        .reactions { display: flex; gap: 5px; margin-top: 5px; }
        .react { background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 8px; font-size: 12px; cursor: pointer; border: 1px solid transparent; }
        .react.active { border-color: white; }

        .avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; background: #333; cursor: pointer; }
        .controls { padding: 15px; background: var(--surface); display: flex; gap: 10px; align-items: center; }
        input#msg-input { flex: 1; background: #080e15; border: none; color: white; padding: 12px; border-radius: 10px; outline: none; }
        
        .tools { position: absolute; top: -20px; right: 0; display: none; gap: 8px; background: #222; padding: 4px; border-radius: 5px; z-index: 10; }
        .msg:hover .tools { display: flex; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <h1 style="color:var(--primary)">LiteGram Ultra</h1>
        <input type="text" id="r-name" class="input-ui" placeholder="–í–∞—à–µ –∏–º—è">
        <input type="text" id="r-user" class="input-ui" placeholder="@username">
        <input type="password" id="r-pass" class="input-ui" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()" style="background:var(--primary); color:white; border:none; padding:12px 100px; border-radius:8px; cursor:pointer; font-weight:bold;">–í–û–ô–¢–ò</button>
    </div>

    <div id="video-grid"></div>
    <div class="call-controls" id="call-ui">
        <button class="call-btn" onclick="leaveCall()" style="background:#ff4d4d">üìû</button>
    </div>

    <div id="main-ui" style="display:none">
        <div id="sidebar">
            <div class="header">
                <img id="my-avatar" class="avatar" onclick="changeAv()" title="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ">
                <b id="my-name-display">–ó–∞–≥—Ä—É–∑–∫–∞...</b>
            </div>
            <div style="padding:15px; background: #242f3d; font-weight: bold;">üí¨ –û–±—â–∏–π —á–∞—Ç</div>
            <div style="flex:1; padding:15px; font-size:12px; color:#aaa;">–î—Ä—É–≥–∏–µ —á–∞—Ç—ã —Å–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è...</div>
            <button onclick="logout()" style="background:none; border:none; color:#ff4d4d; padding:15px; cursor:pointer; text-align:left;">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
        </div>
        <div id="chat">
            <div class="header" style="justify-content: space-between;">
                <b>üåê –û–±—â–∏–π —á–∞—Ç</b>
                <button onclick="startCall()" style="background:var(--primary); border:none; color:white; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">üé• –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫</button>
            </div>
            <div id="messages"></div>
            <div class="controls">
                <input type="text" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
                <button onclick="send()" style="background:none; border:none; color:var(--primary); font-size:28px; cursor:pointer;">‚û§</button>
            </div>
        </div>
    </div>

    <audio id="notif" src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3"></audio>

    <script>
        const socket = io();
        let me = null, currentRoom = "global", myStream = null, peers = {};

        // –ü–†–û–í–ï–†–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–û–ô –°–ï–°–°–ò–ò
        window.onload = () => {
            const saved = localStorage.getItem('litegram_user');
            if(saved) {
                me = JSON.parse(saved);
                enterApp(me);
            }
        };

        function login() {
            const n = document.getElementById('r-name').value, 
                  u = document.getElementById('r-user').value.toLowerCase(), 
                  p = document.getElementById('r-pass').value;
            if(n && u && p) socket.emit('login_attempt', {name:n, nick:u, pass:p});
        }

        socket.on('login_success', u => {
            me = u;
            localStorage.setItem('litegram_user', JSON.stringify(u));
            enterApp(u);
        });

        function enterApp(u) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('my-avatar').src = u.avatar || 'https://www.w3schools.com/howto/img_avatar.png';
            document.getElementById('my-name-display').innerText = u.name;
            socket.emit('join', {room: currentRoom});
            setInterval(() => socket.emit('update_status', {nick: me.nick}), 5000);
        }

        function logout() {
            localStorage.removeItem('litegram_user');
            location.reload();
        }

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value.trim()) { 
                socket.emit('message', {user: me.name, nick: '@'+me.nick, text: i.value, room: currentRoom}); 
                i.value = ''; 
            }
        }

        function addMsg(d) {
            const m = document.getElementById('messages'), isMy = d.nick === '@' + me.nick;
            if(!isMy) document.getElementById('notif').play();
            
            const html = `
                <div class="msg ${isMy ? 'my-msg' : ''}" id="msg-${d._id}">
                    <img class="avatar" src="${d.avatar || 'https://www.w3schools.com/howto/img_avatar.png'}">
                    <div class="msg-content">
                        <div class="tools">
                            <span onclick="react('${d._id}', '‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span onclick="react('${d._id}', 'üëç')">üëç</span>
                            <span onclick="react('${d._id}', 'üî•')">üî•</span>
                            ${isMy ? `<span onclick="del('${d._id}')">üóë</span>` : ''}
                        </div>
                        <b style="font-size:11px; opacity:0.6">${d.user}</b><br>
                        <span>${d.text}</span>
                        <div class="reactions" id="re-${d._id}"></div>
                    </div>
                </div>`;
            m.insertAdjacentHTML('beforeend', html);
            if(d.reactions) updateR(d._id, d.reactions);
            m.scrollTop = m.scrollHeight;
        }

        function react(id, e) { socket.emit('add_reaction', {msg_id:id, emoji:e, nick:me.nick, room:currentRoom}); }
        socket.on('update_reactions', d => updateR(d.msg_id, d.reactions));
        function updateR(id, rs) {
            const el = document.getElementById(`re-${id}`); if(!el) return;
            el.innerHTML = Object.entries(rs).map(([e, us]) => `
                <span class="react ${us.includes(me.nick)?'active':''}" onclick="react('${id}','${e}')">${e} ${us.length}</span>
            `).join('');
        }

        function del(id) { if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) socket.emit('delete_msg_global', {msg_id:id, room:currentRoom}); }
        socket.on('msg_deleted_confirm', d => document.getElementById(`msg-${d.msg_id}`)?.remove());
        socket.on('render_message', addMsg);
        socket.on('history', ms => ms.forEach(addMsg));

        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –í–ò–î–ï–û–ó–í–û–ù–ö–ò (–ë–ï–ó –í–´–õ–ï–¢–ê)
        async function startCall() {
            document.getElementById('video-grid').style.display = 'grid';
            document.getElementById('call-ui').style.display = 'flex';
            try {
                myStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                addV('my-v', myStream, "–í—ã (–Ø)");
                socket.emit('join_call', {room: currentRoom, nick: me.nick});
            } catch(e) { alert("–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ!"); leaveCall(); }
        }

        function addV(id, s, n) {
            if(document.getElementById(id)) return;
            const div = document.createElement('div'); div.className='video-container'; div.id=id;
            const v = document.createElement('video'); v.srcObject=s; v.autoplay=true; v.setAttribute('playsinline', '');
            if(id==='my-v') v.muted=true;
            div.innerHTML += `<div class="video-label">${n}</div>`; div.appendChild(v);
            document.getElementById('video-grid').appendChild(div);
        }

        function leaveCall() {
            if(myStream) myStream.getTracks().forEach(t => t.stop());
            document.getElementById('video-grid').style.display = 'none';
            document.getElementById('call-ui').style.display = 'none';
            document.getElementById('video-grid').innerHTML = '';
            Object.values(peers).forEach(p => p.close());
            peers = {};
            // –ù–ò–ö–ê–ö–û–ì–û location.reload() –¢–£–¢ –ù–ï–¢!
        }

        function changeAv() {
            const url = prompt("–í—Å—Ç–∞–≤—å –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ (URL):");
            if(url) {
                socket.emit('update_avatar', {nick: me.nick, avatar: url});
                document.getElementById('my-avatar').src = url;
                let user = JSON.parse(localStorage.getItem('litegram_user'));
                user.avatar = url;
                localStorage.setItem('litegram_user', JSON.stringify(user));
            }
        }
    </script>
</body>
</html>
