<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LiteGram Pro</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --primary: #2481cc; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* –ú–û–ë–ò–õ–¨–ù–ê–Ø –ê–î–ê–ü–¢–ê–¶–ò–Ø */
        #sidebar { width: 320px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; transition: 0.3s; z-index: 10; }
        #chat { flex: 1; display: flex; flex-direction: column; background: #080e15; position: relative; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; width: 100%; height: 100%; left: 0; }
            #sidebar.mobile-hidden { left: -100%; }
            .back-btn { display: block !important; }
        }

        .back-btn { display: none; background: none; border: none; color: var(--primary); font-size: 20px; cursor: pointer; }
        .header { padding: 15px; background: var(--surface); display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #000; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; background: var(--surface); position: relative; }
        .my-msg { align-self: flex-end; background: var(--primary); }

        /* –û–ö–ù–û –ó–í–û–ù–ö–ê */
        #call-ui { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 1000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 45%; min-width: 280px; border-radius: 10px; background: #222; }
        #inc-call { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--primary); padding: 15px; border-radius: 10px; z-index: 2000; display: none; text-align: center; }

        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; background: var(--primary); color: white; }
    </style>
</head>
<body>

    <audio id="snd-msg" src="https://raw.githubusercontent.com/Anuj-Rathore/Messenger-Clone/master/public/sounds/sent.mp3"></audio>
    <audio id="snd-ring" src="https://www.soundjay.com/phone/phone-calling-1.mp3" loop></audio>

    <div id="inc-call">
        <b>–í—Ö–æ–¥—è—â–∏–π –≤—ã–∑–æ–≤!</b><br><br>
        <button onclick="acceptCall()" class="btn" style="background:green">–ü—Ä–∏–Ω—è—Ç—å</button>
        <button onclick="endCall()" class="btn" style="background:red">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
    </div>

    <div id="call-ui">
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
            <video id="localVid" autoplay muted playsinline></video>
            <video id="remoteVid" autoplay playsinline></video>
        </div>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button onclick="toggleMic()" class="btn">üé§ –ú–∏–∫—Ä–æ</button>
            <button onclick="toggleCam()" class="btn">üì∑ –ö–∞–º–µ—Ä–∞</button>
            <button onclick="endCall()" class="btn" style="background:red">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <div id="sidebar" class="mobile-hidden">
        <div class="header"><b>LiteGram Pro</b></div>
        <div id="chats-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="chat">
        <div class="header">
            <button class="back-btn" onclick="document.getElementById('sidebar').classList.remove('mobile-hidden')">‚ò∞</button>
            <b id="chat-title">–ß–∞—Ç</b>
            <button onclick="startCall()" style="background:none; border:none; font-size:22px; cursor:pointer;">üìû</button>
        </div>
        <div id="messages"></div>
        <div class="header">
            <button id="voice-btn" style="background:none; border:none; font-size:20px; cursor:pointer;">üé§</button>
            <input id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; margin:0 10px; padding:10px; border-radius:20px; border:none; background:#0f161e; color:white;">
            <button onclick="send()" style="background:none; border:none; color:var(--primary); font-size:24px; cursor:pointer;">‚û§</button>
        </div>
    </div>

    <script>
        const socket = io();
        let me = { nick: prompt("–í–∞—à –Ω–∏–∫:") || 'user' + Math.floor(Math.random()*100) };
        let currentRoom = 'global', pc, localStream;

        const playSnd = (id) => document.getElementById(id).play().catch(()=>{});

        // –í–•–û–î –ò –ó–ê–ì–†–£–ó–ö–ê
        window.onload = () => {
            socket.emit('login_attempt', { nick: me.nick, pass: '123', name: me.nick });
            socket.emit('get_my_rooms');
            switchRoom('global', '–û–±—â–∏–π —á–∞—Ç');
        };

        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('chat-title').innerText = title;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join', { room: id });
            document.getElementById('sidebar').classList.add('mobile-hidden');
        }

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value) {
                socket.emit('message', { room: currentRoom, text: i.value, nick: me.nick, user: me.nick, type: 'text' });
                i.value = '';
                playSnd('snd-msg');
            }
        }

        socket.on('render_message', d => {
            if(d.room !== currentRoom) return;
            const m = document.getElementById('messages');
            const h = `<div class="msg ${d.nick === me.nick ? 'my-msg' : ''}">
                <b style="font-size:10px;">${d.user}</b><br>
                ${d.type === 'audio' ? `<audio src="${d.audio}" controls></audio>` : d.text}
            </div>`;
            m.insertAdjacentHTML('beforeend', h);
            m.scrollTop = m.scrollHeight;
            if(d.nick !== me.nick) playSnd('snd-msg');
        });

        // –ó–í–û–ù–ö–ò (WebRTC)
        async function startCall() {
            document.getElementById('call-ui').style.display = 'flex';
            playSnd('snd-ring');
            localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('localVid').srcObject = localStream;

            pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

            pc.onicecandidate = e => e.candidate && socket.emit('ice_candidate', { room: currentRoom, candidate: e.candidate });
            pc.ontrack = e => document.getElementById('remoteVid').srcObject = e.streams[0];

            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            socket.emit('call_user', { room: currentRoom, signal: offer, from: me.nick });
        }

        socket.on('calling', d => {
            document.getElementById('inc-call').style.display = 'block';
            playSnd('snd-ring');
            me.tempSignal = d.signal;
        });

        async function acceptCall() {
            document.getElementById('inc-call').style.display = 'none';
            document.getElementById('call-ui').style.display = 'flex';
            document.getElementById('snd-ring').pause();

            localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
            document.getElementById('localVid').srcObject = localStream;

            pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.onicecandidate = e => e.candidate && socket.emit('ice_candidate', { room: currentRoom, candidate: e.candidate });
            pc.ontrack = e => document.getElementById('remoteVid').srcObject = e.streams[0];

            await pc.setRemoteDescription(new RTCSessionDescription(me.tempSignal));
            const ans = await pc.createAnswer();
            await pc.setLocalDescription(ans);
            socket.emit('answer_call', { room: currentRoom, signal: ans });
        }

        socket.on('call_accepted', d => {
            document.getElementById('snd-ring').pause();
            pc.setRemoteDescription(new RTCSessionDescription(d.signal));
        });

        socket.on('remote_ice', d => pc && pc.addIceCandidate(new RTCIceCandidate(d.candidate)));

        function endCall() {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            document.getElementById('call-ui').style.display = 'none';
            document.getElementById('inc-call').style.display = 'none';
            document.getElementById('snd-ring').pause();
            if(pc) pc.close();
        }

        // –ì–û–õ–û–°–û–í–´–ï (–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)
        const vBtn = document.getElementById('voice-btn');
        let rec;
        vBtn.onmousedown = async () => {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            rec = new MediaRecorder(s);
            let chunks = [];
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = () => {
                const b = new Blob(chunks, { type: 'audio/webm' });
                const r = new FileReader();
                r.readAsDataURL(b);
                r.onloadend = () => socket.emit('message', { room: currentRoom, audio: r.result, type: 'audio', nick: me.nick, user: me.nick });
            };
            rec.start();
            vBtn.style.color = 'red';
        };
        vBtn.onmouseup = () => { rec.stop(); vBtn.style.color = 'white'; };
    </script>
</body>
</html>
