<!DOCTYPE html><html><head><meta charset="UTF-8"><title>LiteGram Ultra</title>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<style>
    :root { --bg: #0e1621; --surf: #17212b; --acc: #2481cc; --txt: #fff; }
    body { background: var(--bg); color: var(--txt); margin:0; display:flex; height:100vh; font-family: sans-serif; overflow:hidden; }
    #sidebar { width:300px; background: var(--surf); border-right:1px solid #000; display:flex; flex-direction:column; }
    .chat-item { padding:12px; cursor:pointer; border-bottom:1px solid #000; display:flex; justify-content:space-between; align-items:center; }
    .chat-item.active { background: var(--acc); }
    #chat-area { flex:1; display:flex; flex-direction:column; position:relative; }
    #messages { flex:1; overflow-y:auto; padding:20px; display:flex; flex-direction:column; gap:10px; }
    .msg { max-width:75%; padding:10px; border-radius:12px; position:relative; }
    .msg.my { align-self:flex-end; background:#2b5278; }
    .msg.other { align-self:flex-start; background:#182533; }
    .del-btn { position:absolute; top:-5px; right:-5px; background:red; border:none; color:#fff; border-radius:50%; cursor:pointer; display:none; font-size:10px; width:18px; height:18px; }
    .msg:hover .del-btn { display:block; }
    #v-preview { position:absolute; bottom:80px; right:20px; width:120px; height:120px; border-radius:50%; border:2px solid red; display:none; object-fit:cover; }
    .btn-icon { background:none; border:none; color:#808b99; cursor:pointer; font-size:20px; padding:5px; }
    #sticker-panel { display:none; position:absolute; bottom:70px; left:10px; background:var(--surf); padding:10px; border-radius:10px; border:1px solid #000; z-index:100; grid-template-columns: repeat(4, 1fr); gap:5px; }
    #user-menu { display:none; position:fixed; background:#2c3e50; border-radius:8px; z-index:2000; border:1px solid #444; padding:5px; }
    #user-menu button { display:block; width:100%; padding:8px; background:none; border:none; color:#fff; cursor:pointer; text-align:left; }
    #call-ui { position:fixed; inset:0; background:rgba(14,22,33,0.95); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:5000; }
</style></head>
<body>
    <div id="user-menu"><button onclick="adminAction('promote')">–ê–¥–º–∏–Ω</button><button onclick="adminAction('mute')">–ú—É—Ç</button><button onclick="adminAction('ban')" style="color:red">–ë–∞–Ω</button></div>
    <div id="call-ui"><h2>–í—ã–∑–æ–≤...</h2><button onclick="endCall()" style="background:red; color:#fff; border:none; padding:10px 20px; border-radius:20px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button></div>
    
    <div id="sidebar">
        <div style="padding:15px; border-bottom:1px solid #000; display:flex; justify-content:space-between;">
            <b id="my-nick">LiteGram</b><button onclick="createRoom()" class="btn-icon" style="color:var(--acc)">+</button>
        </div>
        <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫..." oninput="doSearch()" style="background:none; border:none; color:#fff; padding:10px;">
        <div id="rooms-list"></div>
    </div>

    <div id="chat-area">
        <video id="v-preview" autoplay muted></video>
        <div style="padding:10px; background:var(--surf); display:flex; justify-content:space-between; align-items:center;">
            <b id="chat-name">–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</b><button class="btn-icon" onclick="startCall()">üìû</button>
        </div>
        <div id="messages"></div>
        
        <div id="sticker-panel">
            <img src="https://cdn-icons-png.flaticon.com/512/4721/4721028.png" width="40" onclick="sendMedia(this.src, 'sticker')">
            <img src="https://cdn-icons-png.flaticon.com/512/4721/4721021.png" width="40" onclick="sendMedia(this.src, 'sticker')">
        </div>

        <div style="padding:10px; background:var(--surf); display:flex; align-items:center; gap:5px; position:relative;">
            <div id="mute-msg" style="position:absolute; inset:0; background:rgba(0,0,0,0.8); display:none; align-items:center; justify-content:center;">–í–´ –í –ú–£–¢–ï</div>
            <label class="btn-icon">üìé<input type="file" onchange="upFile(this)" style="display:none"></label>
            <button class="btn-icon" onclick="toggleStickers()">üòä</button>
            <button class="btn-icon" onclick="recMedia('video')">üì∑</button>
            <input id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:none; border:none; color:#fff; outline:none;" onkeypress="if(event.key==='Enter') send()">
            <button class="btn-icon" onclick="recMedia('audio')">üé§</button>
            <button onclick="send()" class="btn-icon" style="color:var(--acc)">‚û§</button>
        </div>
    </div>

<script>
    const socket = io();
    let me = null, curRoom = 'global', selUser = null, roomData = {}, isRec = false, mediaRec, chunks = [];

    window.onload = () => {
        const s = localStorage.getItem('creds');
        if(s) socket.emit('login_attempt', JSON.parse(s)); else login();
    };

    function login() {
        const n = prompt("–ù–∏–∫?"), p = prompt("–ü–∞—Ä–æ–ª—å?");
        if(n && p) {
            const c = {nick: n.toLowerCase(), pass: p};
            localStorage.setItem('creds', JSON.stringify(c));
            socket.emit('login_attempt', c);
        }
    }

    socket.on('login_success', u => {
        me = u; document.getElementById('my-nick').innerText = u.nick;
        socket.emit('get_rooms', {nick: me.nick});
    });

    socket.on('load_rooms', rs => {
        const l = document.getElementById('rooms-list'); l.innerHTML = '';
        rs.forEach(r => {
            const d = document.createElement('div');
            d.className = 'chat-item' + (curRoom===r.id?' active':'');
            d.innerHTML = `<span>${r.name}</span>${r.owner===me.nick ? `<button onclick="delChat('${r.id}',event)" class="del-btn" style="display:block">‚úï</button>`:''}`;
            d.onclick = () => switchRoom(r.id, r.name);
            l.appendChild(d);
        });
    });

    function switchRoom(id, name) {
        curRoom = id; document.getElementById('chat-name').innerText = name;
        document.getElementById('messages').innerHTML = '';
        socket.emit('join', {room: id, nick: me.nick});
    }

    socket.on('room_update', data => {
        roomData = data;
        document.getElementById('mute-msg').style.display = data.muted.includes(me.nick) ? 'flex' : 'none';
    });

    socket.on('kick_user', target => { if(target === me.nick) location.reload(); });
    socket.on('chat_gone', id => { if(curRoom === id) location.reload(); });

    function send() {
        const i = document.getElementById('msg-in');
        if(i.value.trim()) { socket.emit('message', {room: curRoom, text: i.value, nick: me.nick}); i.value=''; }
    }

    function upFile(el) {
        const f = el.files[0]; const r = new FileReader();
        r.onload = (e) => socket.emit('message', {room:curRoom, nick:me.nick, file:e.target.result, fileName:f.name, fileType:f.type});
        r.readAsDataURL(f);
    }

    socket.on('render_message', d => { if(d.room === curRoom) render(d); });
    socket.on('history', h => h.forEach(render));
    socket.on('remove_msg', id => document.getElementById('msg-'+id)?.remove());

    function render(d) {
        let c = d.text ? `<div>${d.text}</div>` : '';
        if(d.file) {
            if(d.fileType.startsWith('image')) c = `<img src="${d.file}" style="max-width:100%; border-radius:8px;">`;
            else c = `<a href="${d.file}" download="${d.fileName}" style="color:cyan">üìÑ ${d.fileName}</a>`;
        }
        if(d.sticker) c = `<img src="${d.sticker}" width="80">`;
        if(d.video) c = `<video src="${d.video}" autoplay loop muted style="width:150px; border-radius:50%;"></video>`;
        if(d.audio) c = `<audio controls src="${d.audio}" style="width:180px;"></audio>`;

        const h = `<div class="msg ${d.nick===me.nick?'my':'other'}" id="msg-${d.id}">
            <button class="del-btn" onclick="socket.emit('delete_message',{msg_id:'${d.id}',room:'${curRoom}'})">‚úï</button>
            <small onclick="openMenu(event,'${d.nick}')" style="cursor:pointer; color:orange">@${d.nick}</small>${c}
            <div onclick="socket.emit('add_reaction',{msg_id:'${d.id}',emoji:'‚ù§Ô∏è',room:'${curRoom}',nick:'${me.nick}'})" style="cursor:pointer; font-size:10px;">‚ù§Ô∏è</div>
        </div>`;
        document.getElementById('messages').insertAdjacentHTML('beforeend', h);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    function openMenu(e, nick) {
        e.preventDefault(); selUser = nick;
        const m = document.getElementById('user-menu');
        m.style.display = 'block'; m.style.left = e.pageX+'px'; m.style.top = e.pageY+'px';
    }

    function adminAction(a) { socket.emit('admin_action', {room:curRoom, nick:me.nick, target:selUser, action:a}); }
    function delChat(id,e) { e.stopPropagation(); if(confirm("–£–¥–∞–ª–∏—Ç—å —á–∞—Ç?")) socket.emit('delete_chat', {room:id, nick:me.nick}); }
    function createRoom() { const n = prompt("–ò–º—è –≥—Ä—É–ø–ø—ã?"); if(n) socket.emit('create_room', {name:n, nick:me.nick}); }
    function toggleStickers() { const s = document.getElementById('sticker-panel'); s.style.display = s.style.display==='grid'?'none':'grid'; }
    function sendMedia(url, type) { socket.emit('message', {room:curRoom, [type]:url, nick:me.nick}); toggleStickers(); }
    function startCall() { document.getElementById('call-ui').style.display='flex'; }
    function endCall() { document.getElementById('call-ui').style.display='none'; }
    function doSearch() { const q = document.getElementById('search').value.toLowerCase(); document.querySelectorAll('.chat-item').forEach(el => el.style.display = el.innerText.toLowerCase().includes(q)?'flex':'none'); }

    async function recMedia(type) {
        if(!isRec) {
            const s = await navigator.mediaDevices.getUserMedia({audio:true, video:type==='video'});
            if(type==='video') { const p=document.getElementById('v-preview'); p.srcObject=s; p.style.display='block'; }
            mediaRec = new MediaRecorder(s); chunks = [];
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.onstop = () => {
                const b = new Blob(chunks, {type: 'video/webm'});
                const r = new FileReader(); r.onloadend = () => socket.emit('message', {room:curRoom, [type]:r.result, nick:me.nick});
                r.readAsDataURL(b); s.getTracks().forEach(t => t.stop()); document.getElementById('v-preview').style.display='none';
            };
            mediaRec.start(); isRec=true;
        } else { mediaRec.stop(); isRec=false; }
    }
    document.addEventListener('click', () => document.getElementById('user-menu').style.display='none');
</script></body></html>
