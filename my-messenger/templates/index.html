<!DOCTYPE html><html lang="ru"><head><meta charset="UTF-8"><title>LiteGram Ultimate</title>
<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<style>
    :root { --bg: #0e1621; --surf: #17212b; --acc: #2481cc; --txt: #fff; --msg: #182533; }
    .light-theme { --bg: #f0f2f5; --surf: #ffffff; --acc: #0088cc; --txt: #000; --msg: #e4e6eb; }
    body { background: var(--bg); color: var(--txt); margin:0; display:flex; height:100vh; font-family: sans-serif; transition: 0.3s; }
    
    #auth-screen { position:fixed; inset:0; background:var(--bg); z-index:10000; display:flex; align-items:center; justify-content:center; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:9000; align-items:center; justify-content:center; }
    .modal-content { background:var(--surf); padding:20px; border-radius:15px; width:300px; }

    #sidebar { width:320px; background:var(--surf); border-right:1px solid rgba(0,0,0,0.2); display:flex; flex-direction:column; }
    #chat-area { flex:1; display:flex; flex-direction:column; position:relative; }
    #messages { flex:1; overflow-y:auto; padding:15px; display:flex; flex-direction:column; gap:10px; }
    
    .msg { max-width:75%; padding:10px; border-radius:12px; background:var(--msg); position:relative; }
    .msg.my { align-self:flex-end; background:var(--acc); color:#fff; }
    .avatar { width:40px; height:40px; border-radius:50%; object-fit:cover; }
    .btn-icon { background:none; border:none; color:var(--acc); cursor:pointer; font-size:20px; }
    #v-preview { position:absolute; bottom:80px; right:20px; width:120px; height:120px; border-radius:50%; border:2px solid red; display:none; object-fit:cover; }
</style></head>
<body class="dark-theme">

<div id="auth-screen">
    <div class="modal-content" style="text-align:center;">
        <h2>LiteGram</h2>
        <input id="a-nick" placeholder="@username"><input id="a-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="doAuth('login')" style="width:100%; padding:10px; background:var(--acc); color:#fff; border:none; margin-top:10px;">–í–æ–π—Ç–∏</button>
        <button onclick="doAuth('reg')" style="width:100%; margin-top:5px; background:none; color:var(--acc); border:none;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
</div>

<div id="modal-prof" class="modal">
    <div class="modal-content">
        <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
        –ò–º—è: <input id="p-name">
        –û —Å–µ–±–µ: <textarea id="p-bio" style="width:100%"></textarea>
        –ê–≤–∞—Ç–∞—Ä (URL): <input id="p-ava">
        –¢–µ–º–∞: <select id="p-theme"><option value="dark-theme">–¢–µ–º–Ω–∞—è</option><option value="light-theme">–°–≤–µ—Ç–ª–∞—è</option></select>
        <button onclick="saveProf()" style="width:100%; background:var(--acc); color:#fff; border:none; padding:10px; margin-top:10px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button onclick="closeModals()" style="width:100%; margin-top:5px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<div id="modal-user" class="modal">
    <div class="modal-content" style="text-align:center;">
        <img id="u-ava" class="avatar" style="width:80px; height:80px;">
        <h3 id="u-name"></h3><p id="u-nick" style="color:var(--acc)"></p><p id="u-bio"></p>
        <div id="admin-btns" style="display:none; border-top:1px solid #444; padding-top:10px;">
            <button onclick="adm('mute')">–ú—É—Ç</button><button onclick="adm('ban')" style="color:red">–ë–∞–Ω</button>
        </div>
        <button onclick="closeModals()" style="width:100%; margin-top:10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
</div>

<div id="sidebar">
    <div style="padding:15px; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="openMyProf()">
        <img id="my-ava" class="avatar" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
        <div><b id="my-name">–ò–º—è</b><div id="my-nick" style="font-size:12px; opacity:0.6;"></div></div>
    </div>
    <input type="text" id="search" placeholder="üîç –ü–æ–∏—Å–∫ —Å–æ–æ–±—â–µ–Ω–∏–π..." oninput="doSearch()" style="margin:10px;">
    <button onclick="const n=prompt('–ò–º—è –≥—Ä—É–ø–ø—ã?'); if(n) socket.emit('create_room',{name:n,nick:me.nick})" style="margin:10px;">+ –ì—Ä—É–ø–ø–∞</button>
    <div id="rooms-list" style="flex:1; overflow-y:auto;"></div>
</div>

<div id="chat-area">
    <video id="v-preview" autoplay muted></video>
    <div style="padding:10px; background:var(--surf); display:flex; justify-content:space-between; align-items:center;">
        <b id="chat-title">–ß–∞—Ç</b>
        <div id="group-actions" style="display:none;"><button onclick="showMembers()">üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏</button></div>
    </div>
    <div id="messages"></div>
    <div id="mute-msg" style="display:none; text-align:center; background:red;">–í–´ –í –ú–£–¢–ï</div>
    <div style="padding:10px; background:var(--surf); display:flex; align-items:center; gap:5px;">
        <label class="btn-icon">üìé<input type="file" onchange="upFile(this)" style="display:none"></label>
        <button class="btn-icon" onclick="rec('video')">üì∑</button>
        <input id="msg-in" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="flex:1; background:none; border:none; color:var(--txt); outline:none;" onkeypress="if(event.key==='Enter') send()">
        <button class="btn-icon" onclick="rec('audio')">üé§</button>
        <button onclick="send()" class="btn-icon">‚û§</button>
    </div>
</div>

<script>
    const socket = io();
    let me = null, curRoom = 'global', rData = {}, isRec = false, mediaRec, chunks = [];

    function doAuth(t) { socket.emit('auth', {type:t, nick:document.getElementById('a-nick').value, pass:document.getElementById('a-pass').value}); }
    socket.on('auth_ok', u => { 
        me = u; document.getElementById('auth-screen').style.display='none';
        document.getElementById('my-name').innerText = u.name;
        document.getElementById('my-nick').innerText = '@'+u.nick;
        if(u.avatar) document.getElementById('my-ava').src = u.avatar;
        document.body.className = u.theme;
        socket.emit('get_rooms', me.nick);
    });

    socket.on('load_rooms', rs => {
        const l = document.getElementById('rooms-list'); l.innerHTML = '';
        rs.forEach(r => {
            const d = document.createElement('div'); d.className = 'user-row';
            d.style.padding='10px'; d.style.cursor='pointer';
            d.innerHTML = `<b>${r.name}</b>`;
            d.onclick = () => {
                curRoom = r.id; document.getElementById('chat-title').innerText = r.name;
                document.getElementById('group-actions').style.display = r.type==='group'?'block':'none';
                document.getElementById('messages').innerHTML = '';
                socket.emit('join', {room:r.id, nick:me.nick});
            };
            l.appendChild(d);
        });
    });

    function openMyProf() {
        document.getElementById('p-name').value = me.name;
        document.getElementById('p-bio').value = me.bio;
        document.getElementById('p-ava').value = me.avatar;
        document.getElementById('p-theme').value = me.theme;
        document.getElementById('modal-prof').style.display='flex';
    }

    function saveProf() {
        socket.emit('update_profile', {nick:me.nick, name:document.getElementById('p-name').value, bio:document.getElementById('p-bio').value, avatar:document.getElementById('p-ava').value, theme:document.getElementById('p-theme').value});
        closeModals();
    }

    socket.on('user_info', u => {
        document.getElementById('u-ava').src = u.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        document.getElementById('u-name').innerText = u.name;
        document.getElementById('u-nick').innerText = '@'+u.nick;
        document.getElementById('u-bio').innerText = u.bio;
        document.getElementById('admin-btns').style.display = (me.nick===rData.owner || rData.admins?.includes(me.nick)) && u.nick!==me.nick ? 'block' : 'none';
        window.selTarg = u.nick;
        document.getElementById('modal-user').style.display='flex';
    });

    function send() {
        const i = document.getElementById('msg-in');
        if(i.value.trim()) { socket.emit('message', {room:curRoom, text:i.value, nick:me.nick, user:me.name}); i.value=''; }
    }

    socket.on('render_message', d => { if(d.room===curRoom) render(d); });
    socket.on('history', h => h.forEach(render));
    socket.on('room_update', r => { rData = r; document.getElementById('mute-msg').style.display = r.muted?.includes(me.nick)?'block':'none'; });

    function render(d) {
        let c = d.text ? `<div>${d.text}</div>` : '';
        if(d.file) c = d.fileType.startsWith('image') ? `<img src="${d.file}" style="max-width:100%">` : `<a href="${d.file}" download>üìÑ ${d.fileName}</a>`;
        if(d.video) c = `<video src="${d.video}" autoplay loop muted style="width:150px; border-radius:50%"></video>`;
        const h = `<div class="msg ${d.nick===me.nick?'my':''}">
            <small onclick="socket.emit('get_user','${d.nick}')" style="cursor:pointer; opacity:0.7">@${d.nick}</small>
            ${c}
            <div onclick="socket.emit('add_reaction',{msg_id:'${d.id}',emoji:'‚ù§Ô∏è',room:curRoom,nick:me.nick})" style="cursor:pointer; font-size:10px;">‚ù§Ô∏è ${Object.keys(d.reactions||{}).length}</div>
        </div>`;
        const b = document.getElementById('messages'); b.insertAdjacentHTML('beforeend', h); b.scrollTop=b.scrollHeight;
    }

    function doSearch() {
        const q = document.getElementById('search').value.toLowerCase();
        document.querySelectorAll('.msg').forEach(m => m.style.display = m.innerText.toLowerCase().includes(q)?'block':'none');
    }

    function adm(a) { socket.emit('admin_action', {room:curRoom, target:window.selTarg, action:a, nick:me.nick}); closeModals(); }
    function closeModals() { document.querySelectorAll('.modal').forEach(m=>m.style.display='none'); }
    function upFile(el) { const f=el.files[0]; const r=new FileReader(); r.onload=e=>socket.emit('message',{room:curRoom,nick:me.nick,file:e.target.result,fileName:f.name,fileType:f.type}); r.readAsDataURL(f); }

    async function rec(mode) {
        if(!isRec) {
            const s = await navigator.mediaDevices.getUserMedia({audio:true, video:mode==='video'});
            if(mode==='video') { const p=document.getElementById('v-preview'); p.srcObject=s; p.style.display='block'; }
            mediaRec = new MediaRecorder(s); chunks = [];
            mediaRec.ondataavailable = e => chunks.push(e.data);
            mediaRec.onstop = () => {
                const b = new Blob(chunks, {type: mode==='video'?'video/webm':'audio/webm'});
                const r = new FileReader(); r.onloadend = () => socket.emit('message', {room:curRoom, [mode]:r.result, nick:me.nick});
                r.readAsDataURL(b); s.getTracks().forEach(t => t.stop()); document.getElementById('v-preview').style.display='none';
            };
            mediaRec.start(); isRec=true;
        } else { mediaRec.stop(); isRec=false; }
    }
</script></body></html>
