<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>LiteGram Pro</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surface: #17212b; --primary: #2481cc; --text: #fff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 320px; background: var(--surface); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat { flex: 1; display: flex; flex-direction: column; background: #080e15; position: relative; }
        .header { padding: 15px; background: var(--surface); border-bottom: 1px solid #000; display: flex; justify-content: space-between; align-items: center; }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; background: var(--surface); position: relative; }
        .my-msg { align-self: flex-end; background: var(--primary); }
        .call-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; }
        video { width: 280px; border-radius: 10px; background: #000; }
        .btn { cursor: pointer; border: none; border-radius: 5px; padding: 8px 12px; color: white; background: var(--primary); }
        .btn-danger { background: #e53935; }
    </style>
</head>
<body>

    <div id="auth" style="position:fixed; inset:0; z-index:1000; background:var(--bg); display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <input id="login-nick" placeholder="@username" style="padding:10px; margin:5px;">
        <button onclick="doLogin()" class="btn">–í–æ–π—Ç–∏</button>
    </div>

    <div id="call-ui" class="call-overlay">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <video id="localVid" autoplay muted></video>
            <video id="remoteVid" autoplay></video>
        </div>
        <div style="display:flex; gap:10px;">
            <button onclick="toggleMic()" id="mic-btn" class="btn">üé§ –ú–∏–∫—Ä–æ –í–∫–ª</button>
            <button onclick="toggleCam()" id="cam-btn" class="btn">üì∑ –ö–∞–º–µ—Ä–∞ –í–∫–ª</button>
            <button onclick="endCall()" class="btn btn-danger">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
        </div>
    </div>

    <div id="sidebar">
        <div class="header"><b>LiteGram</b></div>
        <input type="text" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π –∏–ª–∏ –≥—Ä—É–ø–ø..." oninput="doSearch(this.value)" style="margin:10px; padding:8px; background:#0f161e; color:white; border:1px solid #333;">
        <div id="search-results"></div>
        <hr style="width:100%; border:0; border-top:1px solid #333;">
        <div id="chats-list" style="overflow-y:auto;"></div>
    </div>

    <div id="chat">
        <div class="header">
            <div id="chat-info">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div id="chat-ops"></div>
        </div>
        <div id="messages"></div>
        <div class="header" style="border-top:1px solid #000;">
            <button id="voice-btn" class="btn">üé§</button>
            <input id="msg-input" style="flex:1; margin:0 10px; padding:10px; background:#0f161e; border:none; color:white;">
            <button onclick="send()" class="btn">‚û§</button>
        </div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = null, stream = null;
        let micOn = true, camOn = true;

        function doLogin() {
            const nick = document.getElementById('login-nick').value;
            if(nick) {
                me = { nick: nick.replace('@','') };
                socket.emit('login_attempt', { nick: me.nick, pass: '123' });
                document.getElementById('auth').style.display = 'none';
            }
        }

        function doSearch(q) {
            if(q.length > 1) socket.emit('search', { query: q });
            else document.getElementById('search-results').innerHTML = '';
        }

        socket.on('search_results', d => {
            let h = '';
            d.users.forEach(u => {
                if(u.nick !== me.nick) h += `<div onclick="openLS('${u.nick}')" style="padding:10px; cursor:pointer;">üë§ @${u.nick} (–õ–°)</div>`;
            });
            d.rooms.forEach(r => {
                h += `<div onclick="openRoom('${r.id}')" style="padding:10px; cursor:pointer;">üë• ${r.name}</div>`;
            });
            document.getElementById('search-results').innerHTML = h;
        });

        function openLS(targetNick) {
            const id = [me.nick, targetNick].sort().join('_ls_');
            openRoom(id, `@${targetNick}`);
        }

        function openRoom(id, label) {
            currentRoom = id;
            document.getElementById('messages').innerHTML = '';
            document.getElementById('chat-info').innerText = label || id;
            socket.emit('join', { room: id });
            
            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–∞—Ç–æ–º (—É–¥–∞–ª–µ–Ω–∏–µ)
            document.getElementById('chat-ops').innerHTML = `
                <button onclick="startCall()" class="btn">üìû</button>
                <button onclick="deleteChatAction('${id}')" class="btn btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
            `;
        }

        function deleteChatAction(id) {
            if(id.includes('_ls_')) {
                if(confirm("–£–¥–∞–ª–∏—Ç—å —Ç–æ–ª—å–∫–æ —É —Å–µ–±—è? (–û—Ç–º–µ–Ω–∞ - —É–¥–∞–ª–∏—Ç—å —É –æ–±–æ–∏—Ö)")) {
                   // –õ–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ
                } else {
                    socket.emit('delete_messages_both', { room: id });
                }
            } else {
                socket.emit('delete_room_global', { room: id, nick: me.nick });
            }
        }

        // –ì–û–õ–û–°–û–í–´–ï
        const vBtn = document.getElementById('voice-btn');
        let recorder;
        vBtn.onmousedown = async () => {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            recorder = new MediaRecorder(s);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'audio/webm' });
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = () => socket.emit('message', { room: currentRoom, nick: me.nick, audio: reader.result, type:'audio' });
            };
            recorder.start();
            vBtn.style.background = 'red';
        };
        vBtn.onmouseup = () => { recorder.stop(); vBtn.style.background = var(--primary); };

        // –í–ò–î–ï–û–ß–ê–¢
        async function startCall() {
            document.getElementById('call-ui').style.display = 'flex';
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVid').srcObject = stream;
        }

        function toggleMic() {
            micOn = !micOn;
            stream.getAudioTracks()[0].enabled = micOn;
            document.getElementById('mic-btn').innerText = micOn ? "üé§ –ú–∏–∫—Ä–æ –í–∫–ª" : "üîá –ú–∏–∫—Ä–æ –í—ã–∫–ª";
        }

        function toggleCam() {
            camOn = !camOn;
            stream.getVideoTracks()[0].enabled = camOn;
            document.getElementById('cam-btn').innerText = camOn ? "üì∑ –ö–∞–º–µ—Ä–∞ –í–∫–ª" : "üö´ –ö–∞–º–µ—Ä–∞ –í—ã–∫–ª";
        }

        function endCall() {
            stream.getTracks().forEach(t => t.stop());
            document.getElementById('call-ui').style.display = 'none';
        }

        function send() {
            const inp = document.getElementById('msg-input');
            if(inp.value) {
                socket.emit('message', { room: currentRoom, nick: me.nick, text: inp.value, type: 'text' });
                inp.value = '';
            }
        }

        socket.on('render_message', d => {
            if(d.room !== currentRoom) return;
            const m = document.getElementById('messages');
            const h = `<div class="msg ${d.nick === me.nick ? 'my-msg' : ''}">
                <b>${d.nick}</b><br>
                ${d.type === 'audio' ? `<audio src="${d.audio}" controls></audio>` : d.text}
            </div>`;
            m.insertAdjacentHTML('beforeend', h);
            m.scrollTop = m.scrollHeight;
        });

        socket.on('history', h => h.forEach(d => socket.emit('render_message', d)));
    </script>
</body>
</html>
