<!DOCTYPE html>
<html lang="ru" class="dark">
<head>
    <meta charset="UTF-8">
    <title>Nexus Messenger Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        .video-note { width: 180px; height: 180px; border-radius: 50%; object-fit: cover; border: 3px solid #3b82f6; }
        .modal { background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="flex h-screen bg-slate-950 text-white overflow-hidden">

    <aside class="w-80 border-r border-slate-800 flex flex-col bg-slate-900/40">
        <div class="p-4 flex justify-between items-center">
            <h1 class="text-xl font-black text-blue-500">NEXUS</h1>
            <button onclick="createGroupPrompt()" class="bg-blue-600 p-2 rounded-lg"><i data-lucide="plus"></i></button>
        </div>
        <div class="px-4 pb-2"><input id="searchInput" oninput="searchNexus()" placeholder="–ü–æ–∏—Å–∫..." class="w-full bg-slate-800 p-2 rounded-xl text-sm outline-none border border-slate-700"></div>
        <div id="chats" class="flex-1 overflow-y-auto">
            <div onclick="switchRoom('general')" class="p-4 cursor-pointer hover:bg-slate-800 border-l-4 border-blue-500 bg-blue-500/10"># –û–±—â–∏–π —á–∞—Ç</div>
            <div id="search-results" class="hidden border-b border-slate-800"></div>
            <div id="my-groups" class="p-2 space-y-1"></div>
        </div>
        <div class="p-4 border-t border-slate-800 flex items-center gap-3 cursor-pointer hover:bg-slate-800" onclick="openSettings()">
            <img src="{{ user.avatar }}" id="my-avatar-side" class="w-10 h-10 rounded-full border-2 border-blue-500">
            <div class="flex-1 min-w-0">
                <p class="font-bold truncate" id="my-name-side">{{ user.display_name }}</p>
                <p class="text-[10px] text-blue-400">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col">
        <header class="h-16 border-b border-slate-800 flex items-center justify-between px-6 bg-slate-900/20">
            <h2 id="header-title" class="font-bold"># general</h2>
            <div class="flex gap-4">
                <button onclick="toggleInfo()"><i data-lucide="info" class="text-slate-400 hover:text-white"></i></button>
                <button onclick="toggleTheme()"><i data-lucide="moon"></i></button>
            </div>
        </header>

        <div id="chat-window" class="flex-1 overflow-y-auto p-6 space-y-4"></div>

        <footer class="p-4 border-t border-slate-800">
            <div class="max-w-4xl mx-auto flex items-end gap-2">
                <input type="file" id="fInp" class="hidden" onchange="upFile(this)">
                <button onclick="document.getElementById('fInp').click()" class="p-3"><i data-lucide="paperclip"></i></button>
                <textarea id="msgInput" rows="1" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." class="flex-1 bg-slate-800 rounded-2xl p-3 outline-none resize-none"></textarea>
                <button onclick="recordCircle()" class="p-3 bg-slate-800 rounded-full"><i data-lucide="camera"></i></button>
                <button onclick="send()" class="p-3 bg-blue-600 rounded-full"><i data-lucide="send"></i></button>
            </div>
        </footer>
    </main>

    <div id="settings-modal" class="hidden fixed inset-0 modal flex items-center justify-center z-50">
        <div class="bg-slate-900 border border-slate-800 w-full max-w-md rounded-3xl p-8">
            <h2 class="text-xl font-bold mb-6 text-blue-500">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h2>
            <div class="space-y-4">
                <div><label class="text-xs opacity-50">URL –ê–≤–∞—Ç–∞—Ä–∞</label><input id="set-avatar" value="{{ user.avatar }}" class="w-full bg-slate-800 p-3 rounded-xl outline-none"></div>
                <div><label class="text-xs opacity-50">–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è</label><input id="set-name" value="{{ user.display_name }}" class="w-full bg-slate-800 p-3 rounded-xl outline-none"></div>
                <div><label class="text-xs opacity-50">–û —Å–µ–±–µ (Bio)</label><textarea id="set-bio" class="w-full bg-slate-800 p-3 rounded-xl outline-none">{{ user.bio }}</textarea></div>
                <div class="flex gap-2">
                    <button onclick="saveProfile()" class="flex-1 bg-blue-600 py-3 rounded-xl font-bold">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button onclick="closeModals()" class="flex-1 bg-slate-800 py-3 rounded-xl">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </div>
        </div>
    </div>

    <div id="info-panel" class="hidden fixed right-0 top-16 bottom-0 w-80 bg-slate-900 border-l border-slate-800 z-40 p-4 overflow-y-auto">
        <h3 class="font-bold mb-4 flex items-center gap-2"><i data-lucide="users"></i> –£—á–∞—Å—Ç–Ω–∏–∫–∏</h3>
        <div id="members-list" class="space-y-3"></div>
    </div>

    <script>
        lucide.createIcons();
        const socket = io();
        let currentRoom = "general";
        const myId = "{{ user._id }}";

        socket.emit('join_room', {room: currentRoom});

        // --- –ü–†–û–§–ò–õ–¨ ---
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeModals() { document.querySelectorAll('.modal, #settings-modal').forEach(m => m.classList.add('hidden')); }
        
        async function saveProfile() {
            const data = {
                name: document.getElementById('set-name').value,
                bio: document.getElementById('set-bio').value,
                avatar: document.getElementById('set-avatar').value
            };
            await fetch('/api/profile/save', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è
        }

        // --- –£–ß–ê–°–¢–ù–ò–ö–ò ---
        async function toggleInfo() {
            const panel = document.getElementById('info-panel');
            panel.classList.toggle('hidden');
            if(!panel.classList.contains('hidden')) {
                const res = await fetch(`/api/room/${currentRoom}/members`);
                const members = await res.json();
                const list = document.getElementById('members-list');
                list.innerHTML = members.map(m => `
                    <div class="flex items-center gap-3 p-2 bg-slate-800/50 rounded-xl">
                        <img src="${m.avatar}" class="w-8 h-8 rounded-full border border-blue-500">
                        <div class="min-w-0">
                            <p class="text-sm font-bold truncate">${m.display_name}</p>
                            <p class="text-[10px] opacity-50">@${m.username}</p>
                        </div>
                    </div>
                `).join('');
            }
        }

        // --- –°–û–û–ë–©–ï–ù–ò–Ø –ò –§–£–ù–ö–¶–ò–ò ---
        function send() {
            const inp = document.getElementById('msgInput');
            if(!inp.value) return;
            socket.emit('send_msg', { room: currentRoom, text: inp.value, type: 'text' });
            inp.value = '';
        }

        socket.on('new_message', (data) => {
            const win = document.getElementById('chat-window');
            const isMe = data.sender_id === myId;
            let content = `<p>${data.text}</p>`;
            if(data.type === 'video_circle') content = `<video src="${data.file_url}" class="video-note" controls></video>`;
            if(data.type === 'file') content = `<a href="${data.file_url}" download class="text-blue-400 underline">üìé ${data.text}</a>`;

            win.insertAdjacentHTML('beforeend', `
                <div id="msg-${data._id}" class="flex ${isMe ? 'justify-end' : 'justify-start'}">
                    <div class="relative group ${isMe ? 'bg-blue-600' : 'bg-slate-800'} p-3 rounded-2xl max-w-[70%]">
                        ${!isMe ? `<p class="text-[9px] font-bold text-blue-300">@${data.sender_name}</p>` : ''}
                        ${content}
                        <button onclick="deleteMsg('${data._id}')" class="absolute -top-2 -right-2 bg-red-500 text-[10px] w-5 h-5 rounded-full opacity-0 group-hover:opacity-100 transition">‚úï</button>
                    </div>
                </div>`);
            win.scrollTop = win.scrollHeight;
            lucide.createIcons();
        });

        function deleteMsg(id) { socket.emit('delete_msg', {msg_id: id}); }
        socket.on('msg_deleted', (id) => { document.getElementById(`msg-${id}`)?.remove(); });

        function switchRoom(id, title = "–û–±—â–∏–π —á–∞—Ç") {
            currentRoom = id;
            document.getElementById('header-title').innerText = title;
            document.getElementById('chat-window').innerHTML = '';
            socket.emit('join_room', {room: id});
        }
        
        async function recordCircle() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            const recorder = new MediaRecorder(stream);
            let chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = async () => {
                const blob = new Blob(chunks, { type: 'video/mp4' });
                const formData = new FormData();
                formData.append('file', blob);
                const res = await fetch('/api/upload', {method: 'POST', body: formData});
                const d = await res.json();
                socket.emit('send_msg', { room: currentRoom, type: 'video_circle', file_url: d.url });
            };
            recorder.start();
            setTimeout(() => recorder.stop(), 7000);
        }

        function toggleTheme() { document.documentElement.classList.toggle('light'); }
    </script>
</body>
</html>
