<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LiteGram Admin Panel</title>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <style>
        :root { --bg: #0e1621; --surf: #17212b; --prim: #2481cc; --text: #fff; --msg: #182533; }
        * { box-sizing: border-box; font-family: sans-serif; }
        body { background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        #sidebar { width: 300px; background: var(--surf); border-right: 1px solid #000; display: flex; flex-direction: column; }
        #chat { flex: 1; display: flex; flex-direction: column; background: #080e15; }
        #members-bar { width: 280px; background: var(--surf); border-left: 1px solid #000; display: none; flex-direction: column; }

        .header { padding: 15px; background: var(--surf); border-bottom: 1px solid #000; display: flex; align-items: center; justify-content: space-between; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #333; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { max-width: 80%; padding: 10px; border-radius: 12px; background: var(--msg); }
        .my { align-self: flex-end; background: var(--prim); }
        
        .rank { font-size: 9px; padding: 2px 5px; border-radius: 4px; margin-left: 5px; text-transform: uppercase; font-weight: bold; }
        .rank-–∞–¥–º–∏–Ω { background: #ff4757; color: white; }
        .rank-–º–æ–¥–µ—Ä–∞—Ç–æ—Ä { background: #ffa502; color: white; }
        .rank-—É—á–∞—Å—Ç–Ω–∏–∫ { background: #2f3542; color: #ccc; }

        .member-item { padding: 10px; border-bottom: 1px solid #121b25; }
        .admin-tools { display: none; margin-top: 5px; gap: 5px; }

        #auth { position: fixed; inset: 0; background: var(--bg); z-index: 1000; display: flex; align-items: center; justify-content: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #333; background: #0f161e; color: white; }
    </style>
</head>
<body>

    <div id="auth">
        <div style="background: var(--surf); padding: 30px; border-radius: 20px; width: 320px; text-align: center;">
            <h2 style="color:var(--prim)">LiteGram</h2>
            <input id="login-nick" placeholder="@username">
            <input id="login-pass" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="doLogin()" style="width:100%; padding:12px; background:var(--prim); color:white; border:none; border-radius:8px; cursor:pointer;">–í–û–ô–¢–ò</button>
            <p id="err-msg" style="color:red; font-size:12px;"></p>
        </div>
    </div>

    <div id="sidebar">
        <div class="header"><b id="my-name">...</b></div>
        <div id="chats-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <div id="chat">
        <div class="header">
            <b id="chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</b>
            <button onclick="toggleMembers()" style="background:none; border:none; color:var(--prim); cursor:pointer;">üë§ –£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
        </div>
        <div id="messages"></div>
        <div class="header"><input id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()"></div>
    </div>

    <div id="members-bar">
        <div class="header"><b>–£—á–∞—Å—Ç–Ω–∏–∫–∏</b></div>
        <div id="members-list" style="flex:1; overflow-y:auto;"></div>
    </div>

    <script>
        const socket = io();
        let me = null, currentRoom = 'global';

        function doLogin() {
            const u = document.getElementById('login-nick').value;
            const p = document.getElementById('login-pass').value;
            if(u && p) socket.emit('login_attempt', {nick: u, pass: p});
        }

        socket.on('login_error', t => document.getElementById('err-msg').innerText = t);

        socket.on('login_success', u => {
            me = u;
            document.getElementById('auth').style.display = 'none';
            document.getElementById('my-name').innerHTML = `${u.name} <span class="rank rank-${u.rank.toLowerCase()}">${u.rank}</span>`;
            socket.emit('get_rooms');
            switchRoom('global', '–û–±—â–∏–π —á–∞—Ç');
        });

        function switchRoom(id, title) {
            currentRoom = id;
            document.getElementById('chat-title').innerText = title;
            document.getElementById('messages').innerHTML = '';
            socket.emit('join', {room: id});
            socket.emit('get_members');
        }

        socket.on('members_list', ms => {
            const l = document.getElementById('members-list');
            l.innerHTML = '';
            ms.forEach(m => {
                const isSelf = m.nick === me.nick;
                const canManage = (me.rank === "–ê–¥–º–∏–Ω" || me.rank === "–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä") && !isSelf;
                
                l.insertAdjacentHTML('beforeend', `
                    <div class="member-item">
                        <b>${m.name}</b> <span class="rank rank-${m.rank.toLowerCase()}">${m.rank}</span>
                        <div class="admin-tools" style="display: ${canManage ? 'flex' : 'none'}">
                            <button onclick="ban('${m.nick}')" style="background:#ff4757; color:white; border:none; font-size:10px; border-radius:3px;">–ë–ê–ù</button>
                            ${me.rank === '–ê–¥–º–∏–Ω' ? `
                                <button onclick="setRank('${m.nick}', '–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä')" style="background:#ffa502; border:none; font-size:10px; border-radius:3px;">–ú–û–î</button>
                                <button onclick="setRank('${m.nick}', '–£—á–∞—Å—Ç–Ω–∏–∫')" style="background:#2f3542; color:white; border:none; font-size:10px; border-radius:3px;">–£–ß</button>
                            ` : ''}
                        </div>
                    </div>
                `);
            });
        });

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        function ban(nick) { if(confirm(`–ó–∞–±–∞–Ω–∏—Ç—å @${nick}?`)) socket.emit('ban_user', {target_nick: nick, admin_nick: me.nick}); }
        function setRank(nick, rank) { socket.emit('change_rank', {target_nick: nick, new_rank: rank, admin_nick: me.nick}); }

        socket.on('kick_signal', nick => { if(me.nick === nick) location.reload(); });
        socket.on('system_message', t => alert(t));

        function send() {
            const i = document.getElementById('msg-input');
            if(i.value.trim()) {
                socket.emit('message', {room: currentRoom, text: i.value, nick: me.nick, user: me.name});
                i.value = '';
            }
        }

        socket.on('render_message', d => { if(d.room === currentRoom) addMsg(d); });
        socket.on('history', h => h.forEach(addMsg));

        function addMsg(d) {
            const b = document.getElementById('messages');
            b.insertAdjacentHTML('beforeend', `<div class="msg ${d.nick===me.nick?'my':''}"><b>${d.user} <span class="rank rank-${(d.rank||'—É—á–∞—Å—Ç–Ω–∏–∫').toLowerCase()}">${d.rank||'–£—á–∞—Å—Ç–Ω–∏–∫'}</span></b><br>${d.text}</div>`);
            b.scrollTop = b.scrollHeight;
        }

        function toggleMembers() {
            const bar = document.getElementById('members-bar');
            bar.style.display = (bar.style.display === 'flex') ? 'none' : 'flex';
        }

        socket.on('load_rooms', rs => {
            const l = document.getElementById('chats-list');
            l.innerHTML = '<div style="padding:15px; cursor:pointer;" onclick="switchRoom(\'global\',\'–û–±—â–∏–π —á–∞—Ç\')">üë• –û–±—â–∏–π —á–∞—Ç</div>';
            rs.forEach(r => l.insertAdjacentHTML('beforeend', `<div style="padding:15px; cursor:pointer;" onclick="switchRoom('${r.id}','${r.name}')">üë• ${r.name}</div>`));
        });
    </script>
</body>
</html>
